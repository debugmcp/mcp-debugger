# packages/adapter-rust/vendor/codelldb/linux-arm64/lldb/lib/python3.12/site-packages/pip/_vendor/urllib3/util/connection.py
@source-hash: e4bc760753d6dbd2
@generated: 2026-02-09T17:57:52Z

## Connection Utilities Module

This module provides low-level socket connection utilities for urllib3, handling cross-platform connection management, IPv6 detection, and socket option configuration.

### Core Functions

**`is_connection_dropped(conn)` (L11-30)**
- Platform-aware connection health checker
- Returns `True` if HTTP connection should be closed due to being dropped
- Handles AppEngine platform specially (always returns `False`)
- Uses `wait_for_read()` with zero timeout to detect dropped sockets
- Gracefully handles `NoWayToWaitForSocketError` exceptions

**`create_connection(address, timeout, source_address, socket_options)` (L37-97)**
- Enhanced version of Python's `socket.create_connection()` with additional features
- Creates TCP socket connection to given address (host, port tuple)
- Supports IPv6 bracket notation parsing (strips `[]` from host)
- Uses `allowed_gai_family()` for intelligent IPv4/IPv6 selection
- Validates hostname encoding with IDNA support, raises `LocationParseError` on failure
- Iterates through `getaddrinfo()` results until successful connection
- Applies custom socket options via `_set_socket_options()`
- Handles source address binding and timeout configuration
- Cleans up failed socket attempts and propagates last error

**`_set_socket_options(sock, options)` (L100-105)**
- Helper function applying socket-level options
- Iterates through options list and calls `setsockopt()` for each

**`allowed_gai_family()` (L108-116)**
- Returns appropriate address family for `getaddrinfo()` calls
- Returns `AF_INET` (IPv4 only) or `AF_UNSPEC` (both IPv4/IPv6) based on system capabilities
- Depends on global `HAS_IPV6` constant

**`_has_ipv6(host)` (L119-146)**
- Runtime IPv6 capability detection by attempting socket bind
- Early return `False` for AppEngine sandbox environment
- Tests actual system IPv6 support beyond Python compile-time flags
- Creates IPv6 socket and binds to test address, handles all exceptions gracefully
- Ensures socket cleanup in all code paths

### Dependencies
- `socket` - Core networking primitives
- `..contrib._appengine_environ` - AppEngine platform detection
- `..exceptions.LocationParseError` - URL/hostname parsing errors  
- `..packages.six` - Python 2/3 compatibility utilities
- `.wait.wait_for_read, NoWayToWaitForSocketError` - Socket readiness detection

### Global State
- `HAS_IPV6` (L149) - Module-level constant caching IPv6 availability test result using localhost (`::1`)

### Architectural Patterns
- Platform-specific behavior abstraction (AppEngine vs standard environments)
- Graceful degradation for IPv6 unavailability
- Resource cleanup with proper exception handling
- Socket option extensibility through parameter passing