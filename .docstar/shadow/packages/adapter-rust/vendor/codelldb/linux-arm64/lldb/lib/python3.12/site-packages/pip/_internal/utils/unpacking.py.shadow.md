# packages/adapter-rust/vendor/codelldb/linux-arm64/lldb/lib/python3.12/site-packages/pip/_internal/utils/unpacking.py
@source-hash: 7b20e44ac9389d6f
@generated: 2026-02-09T18:00:40Z

Archive extraction utilities for pip package installation. Handles unpacking of various archive formats (ZIP, TAR, BZ2, XZ) with security protections and permission handling.

## Core Functionality
Primary purpose: Safe extraction of package archives during pip installation with path traversal protection and proper file permissions.

## Key Components

### Archive Format Detection & Support (L26-42)
- `SUPPORTED_EXTENSIONS`: Dynamically built list of supported archive types
- Conditional imports for `bz2` and `lzma` modules with graceful fallback
- Extensions imported from `pip._internal.utils.filetypes`

### Security & Path Utilities
- `split_leading_dir()` (L51-60): Cross-platform path splitting handling both `/` and `\` separators
- `has_leading_dir()` (L63-75): Detects if archive contents share common root directory
- `is_within_directory()` (L78-86): Path traversal protection using `os.path.commonprefix()`

### Permission Management
- `current_umask()` (L44-48): Gets system umask by temporarily setting it to 0
- `_get_default_mode_plus_executable()` (L89-90): Calculates default permissions with execute bits
- `set_extracted_file_to_default_mode_plus_executable()` (L93-98): Applies execute permissions
- `zip_item_is_executable()` (L101-105): Checks ZIP entry execute permissions via `external_attr`

### Main Extraction Functions

#### `unzip_file()` (L108-151)
- Extracts ZIP archives with optional flattening (removes leading directory)
- Security: Path traversal protection via `is_within_directory()`
- Memory efficient: Uses `shutil.copyfileobj()` instead of reading entire files
- Preserves executable permissions for files with execute bits set

#### `untar_file()` (L154-248)
- Extracts TAR archives with compression support (gzip, bz2, xz)
- Modern Python: Uses `tarfile.data_filter` (PEP 706) when available
- Fallback: `_untar_without_filter()` for older Python versions
- Handles specific Python version bugs for `LinkOutsideDestinationError` (L211-224)
- Custom `pip_filter()` applies security filtering and permission correction

#### `_untar_without_filter()` (L251-306)
- Fallback implementation for Python < 3.12 without built-in security filters
- Manual path traversal protection
- Robust error handling for corrupt archives with detailed logging
- Updates file timestamps and applies execute permissions

#### `unpack_file()` (L309-337)
- Main entry point for archive extraction
- Auto-detects format via content-type, file extension, or magic bytes
- Special handling: Wheel files (`.whl`) extracted without flattening
- Error handling: Raises `InstallationError` for unsupported formats

## Dependencies
- Standard library: `os`, `shutil`, `stat`, `sys`, `tarfile`, `zipfile`
- Internal: `pip._internal.exceptions.InstallationError`, `pip._internal.utils.filetypes`, `pip._internal.utils.misc.ensure_dir`

## Security Measures
- Path traversal protection in both ZIP and TAR extraction
- Validation that extracted files remain within target directory
- Graceful handling of malformed archives with logging
- Protection against ZIP bombs via streaming extraction

## Architecture Notes
- Defensive programming with extensive error handling and logging
- Cross-platform compatibility for path separators and permissions
- Progressive enhancement: Uses modern Python features when available
- Memory-conscious streaming extraction for large files