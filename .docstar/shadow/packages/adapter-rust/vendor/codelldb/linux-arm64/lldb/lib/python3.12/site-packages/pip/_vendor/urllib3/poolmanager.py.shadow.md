# packages/adapter-rust/vendor/codelldb/linux-arm64/lldb/lib/python3.12/site-packages/pip/_vendor/urllib3/poolmanager.py
@source-hash: 696ca15d1b4d3b82
@generated: 2026-02-09T18:01:14Z

## Purpose
Connection pool management for urllib3, providing efficient reuse of HTTP/HTTPS connections through pooling strategies. Manages both direct connections and proxy connections with automatic pool lifecycle management.

## Key Classes

### PoolManager (L140-422)
Primary connection pool manager that maintains a cache of connection pools indexed by connection parameters.

**Key attributes:**
- `pools`: RecentlyUsedContainer for pool caching (L174)
- `connection_pool_kw`: Default parameters for new pools (L173)
- `pool_classes_by_scheme`: Maps schemes to pool classes (L178)
- `key_fn_by_scheme`: Maps schemes to key normalization functions (L179)

**Core methods:**
- `connection_from_host(host, port, scheme, pool_kwargs)` (L225-246): Main entry point for getting connection pools
- `connection_from_context(request_context)` (L248-261): Gets pools from normalized request context
- `connection_from_pool_key(pool_key, request_context)` (L263-285): Thread-safe pool retrieval/creation with locking
- `urlopen(method, url, redirect, **kw)` (L353-421): High-level request interface with redirect handling
- `_new_pool(scheme, host, port, request_context)` (L189-214): Factory method for creating new connection pools
- `clear()` (L216-223): Closes and removes all cached pools

### ProxyManager (L424-536)
Extends PoolManager for proxy-based connections with CONNECT tunneling support.

**Key attributes:**
- `proxy`: Parsed proxy URL (L490)
- `proxy_headers`: Headers sent to proxy (L491)
- `proxy_config`: ProxyConfig namedtuple with SSL context and forwarding settings (L493)

**Overridden methods:**
- `connection_from_host()` (L501-509): Routes HTTPS through proxy, HTTP directly to proxy
- `urlopen()` (L526-536): Adds proxy-specific headers when not using CONNECT tunnels

## Key Data Structures

### PoolKey (L73)
Namedtuple defining all parameters that distinguish connection pools. Contains 23 fields covering host/port, SSL settings, timeouts, retries, and proxy configuration.

### ProxyConfig (L76)
Namedtuple for proxy configuration: `(ssl_context, use_forwarding_for_https)`

## Important Functions

### _default_key_normalizer (L79-125)
Transforms request context into normalized PoolKey:
- Lowercases scheme/host for RFC 3986 compliance (L101-102)
- Converts mutable collections to immutable (frozensets, tuples) (L105-113)
- Prefixes all keys with "key_" for namedtuple compatibility (L117-118)

### proxy_from_url (L539)
Factory function creating ProxyManager from URL string.

## Key Constants

- `SSL_KEYWORDS` (L28-38): SSL-related parameter names for filtering
- `key_fn_by_scheme` (L132-135): Global scheme-to-key-function mapping
- `pool_classes_by_scheme` (L137): Maps schemes to connection pool classes

## Architecture Patterns

**Pool Caching Strategy**: Uses RecentlyUsedContainer with configurable size limit (default 10 pools). Thread-safe with explicit locking in `connection_from_pool_key()`.

**Key Normalization**: Ensures consistent pool keys by normalizing case-sensitive components and converting mutable objects to immutable equivalents.

**Proxy Handling**: Distinguishes between HTTP CONNECT tunneling (for HTTPS) and direct proxy forwarding (for HTTP), with special handling for HTTPS-over-HTTPS proxy scenarios.

**Redirect Logic**: Built-in redirect following with method transformation (303 â†’ GET), header stripping for cross-host redirects, and retry integration.

## Critical Invariants

- Pool keys must be immutable and hashable for caching
- SSL parameters are filtered out for HTTP connections (L210-212)
- Proxy connections require absolute URLs in requests when not using CONNECT tunnels
- Thread safety maintained through RecentlyUsedContainer's internal locking