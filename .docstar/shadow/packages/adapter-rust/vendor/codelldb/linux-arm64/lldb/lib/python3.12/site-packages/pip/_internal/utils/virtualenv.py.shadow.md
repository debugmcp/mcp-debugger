# packages/adapter-rust/vendor/codelldb/linux-arm64/lldb/lib/python3.12/site-packages/pip/_internal/utils/virtualenv.py
@source-hash: 4ba7fb72c628ad1a
@generated: 2026-02-09T18:00:33Z

## Primary Purpose
Virtual environment detection and configuration parsing utility for pip. Determines if pip is running inside a virtual environment and whether system site-packages are accessible.

## Key Functions

**`running_under_virtualenv() -> bool` (L31-33)**
- Main entry point for virtual environment detection
- Returns True if running in any type of virtual environment
- Combines PEP 405 and legacy virtualenv detection methods

**`_running_under_venv() -> bool` (L14-19)**
- Detects PEP 405 compliant virtual environments (Python 3.3+)
- Compares `sys.prefix` with `sys.base_prefix` for detection
- Handles modern venv module created environments

**`_running_under_legacy_virtualenv() -> bool` (L22-28)**
- Detects legacy pypa/virtualenv created environments
- Checks for existence of `sys.real_prefix` attribute
- Supports older virtualenv implementations

**`virtualenv_no_global() -> bool` (L94-104)**
- Determines if system site-packages are excluded from virtual environment
- Prioritizes PEP 405 compliance check over legacy methods
- Returns False if not in a virtual environment

**`_no_global_under_venv() -> bool` (L51-77)**
- Parses `pyvenv.cfg` file to check `include-system-site-packages` setting
- Logs warning if configuration file is inaccessible
- Defaults to no system access if file cannot be read

**`_no_global_under_legacy_virtualenv() -> bool` (L80-91)**
- Checks for `no-global-site-packages.txt` marker file
- Locates file relative to site.py module directory
- Mirrors pypa/virtualenv logic for system packages exclusion

**`_get_pyvenv_cfg_lines() -> Optional[List[str]]` (L36-48)**
- Reads and parses `{sys.prefix}/pyvenv.cfg` configuration file
- Uses UTF-8 encoding per PEP 405 specification
- Returns None on file access errors

## Key Dependencies
- **sys**: Python system-specific parameters and functions
- **site**: Site-specific configuration hook for Python paths
- **os**: Operating system interface utilities
- **re**: Regular expression operations for configuration parsing

## Important Constants
**`_INCLUDE_SYSTEM_SITE_PACKAGES_REGEX` (L9-11)**
- Compiled regex pattern for parsing pyvenv.cfg include-system-site-packages setting
- Matches "true" or "false" values with flexible whitespace

## Architectural Patterns
- **Layered Detection**: Combines multiple detection strategies for comprehensive virtual environment identification
- **PEP 405 Priority**: Modern PEP 405 methods take precedence over legacy approaches
- **Graceful Degradation**: Falls back to safe defaults when configuration files are inaccessible
- **Separation of Concerns**: Distinct functions for different virtualenv types and configuration methods