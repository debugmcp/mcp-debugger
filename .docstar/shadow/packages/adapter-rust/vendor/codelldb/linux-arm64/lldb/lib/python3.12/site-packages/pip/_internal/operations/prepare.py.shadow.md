# packages/adapter-rust/vendor/codelldb/linux-arm64/lldb/lib/python3.12/site-packages/pip/_internal/operations/prepare.py
@source-hash: 8e8589c0f92ea86b
@generated: 2026-02-09T18:00:34Z

**Core Responsibility:** Orchestrates the preparation phase of Python package installation, handling download, unpacking, hash verification, and metadata extraction for various requirement types.

## Key Classes and Functions

### File (L84-92)
Dataclass representing a downloadable file with path and auto-detected MIME type. Used as return type for download operations.

### RequirementPreparer (L215-732)
Central coordinator class managing the complete preparation workflow. Key responsibilities:
- **Configuration (L218-275):** Stores build settings, download directories, session management, and resolver flags
- **Metadata Optimization (L358-446):** Implements PEP 658 metadata-only fetching and lazy wheel loading to avoid full downloads when only dependency info is needed
- **Hash Management (L326-357):** Enforces hash requirements, validates against pinned versions, handles VCS/directory URL restrictions
- **Batch Processing (L447-490, L529-557):** Manages partial downloads and completes them in batches for efficiency

### Core Download Functions
- **get_http_url (L94-116):** Downloads HTTP resources with hash validation and download directory caching
- **get_file_url (L118-140):** Handles local file URLs with optional hash checking
- **unpack_url (L142-183):** Universal unpacking dispatcher supporting VCS, file, and HTTP URLs
- **unpack_vcs_link (L78-82):** VCS-specific unpacking using appropriate backend

### Helper Functions
- **_get_prepared_distribution (L60-76):** Creates distribution metadata using build tracker
- **_check_download_dir (L185-213):** Validates cached downloads against expected hashes

## Architecture Patterns

**Optimization Strategy:** Implements progressive fallback from metadata-only → lazy wheel → full download, minimizing bandwidth usage during dependency resolution.

**Hash Security Model:** Enforces cryptographic verification when `require_hashes` is enabled, with special handling for VCS URLs (unsupported) and unpinned requirements (blocked).

**Build Isolation:** Coordinates with BuildTracker to manage concurrent builds and dependency resolution in isolated environments.

**Caching Layer:** Maintains download memoization (`_downloaded` dict L271) and integrates with pip's wheel cache system.

## Dependencies and Integration Points
- **Network Layer:** Uses Downloader/BatchDownloader for HTTP operations with session management
- **Metadata System:** Interfaces with distribution factories and metadata parsers
- **VCS Integration:** Delegates to pluggable VCS backends for source control operations  
- **Build System:** Coordinates with build tracker for sdist→wheel conversions
- **Security:** Integrates hash verification throughout the pipeline

## Critical Constraints
- Hash verification is mandatory when `require_hashes=True` except for already-installed packages
- VCS URLs cannot be hash-verified and will raise VcsHashUnsupported
- Directory URLs similarly raise DirectoryUrlHashUnsupported when hashes required
- Unpinned requirements are blocked when hash checking is enabled for security