# packages/adapter-rust/vendor/codelldb/linux-arm64/lldb/lib/python3.12/site-packages/pip/_vendor/urllib3/connectionpool.py
@source-hash: 05eeaaeb9491f656
@generated: 2026-02-09T18:01:12Z

## Primary Purpose
HTTP connection pool implementation providing thread-safe connection reuse for HTTP/HTTPS requests with retry logic, proxy support, and timeout handling.

## Core Classes

### ConnectionPool (L69-107)
Abstract base class for all connection pools. Provides basic host/port validation and context manager interface. Key methods:
- `__init__`: Validates and normalizes host, stores port
- `close()`: Abstract method for closing pooled connections
- Context manager support via `__enter__`/`__exit__`

### HTTPConnectionPool (L113-911)
Main HTTP connection pool implementation inheriting from ConnectionPool and RequestMethods. Manages a LIFO queue of reusable HTTP connections.

**Core Properties:**
- `scheme = "http"`, `ConnectionCls = HTTPConnection`, `ResponseCls = HTTPResponse` (L173-175)
- Connection pool using `LifoQueue` (L206, L214-215)
- Request/connection counters for debugging (L218-219)

**Key Methods:**
- `__init__` (L177-239): Initializes pool with maxsize, timeout, retries, proxy config
- `_new_conn()` (L241-260): Creates fresh HTTPConnection instances
- `_get_conn()` (L262-299): Retrieves connection from pool or creates new one
- `_put_conn()` (L301-330): Returns connection to pool or closes if full
- `_make_request()` (L379-496): Core request execution with timeout/error handling
- `urlopen()` (L534-910): Main entry point for HTTP requests with retry/redirect logic

**Critical Features:**
- Connection pooling with configurable maxsize and blocking behavior
- Comprehensive error handling and retry logic with backoff
- Proxy support including HTTP tunneling detection
- Timeout management (connect/read timeouts)
- SSL error detection and user-friendly proxy error messages (L778-791)
- Automatic redirect handling following RFC specifications (L844-878)

### HTTPSConnectionPool (L913-1081)
HTTPS-specific connection pool extending HTTPConnectionPool. Adds SSL/TLS configuration and certificate validation.

**Key Methods:**
- `_prepare_conn()` (L979-997): Configures SSL settings on VerifiedHTTPSConnection
- `_prepare_proxy()` (L999-1012): Establishes HTTPS tunneling through HTTP CONNECT
- `_new_conn()` (L1014-1048): Creates HTTPS connections with SSL configuration
- `_validate_conn()` (L1050-1080): Validates SSL certificates and warns on unverified connections

## Utility Functions

### connection_from_url() (L1083-1108)
Factory function creating appropriate connection pool (HTTP/HTTPS) from URL string.

### _normalize_host() (L1111-1126)
Normalizes IPv6 bracket notation for httplib compatibility.

### _close_pool_connections() (L1129-1136)
Helper for draining and closing all connections in a pool queue.

## Key Dependencies
- `socket`, `errno` for network operations and error codes
- `weakref` for garbage collection management (L54-59)
- Custom modules: connection classes, retry logic, timeout handling, URL parsing
- Queue implementation (`LifoQueue`) for connection pooling

## Architecture Notes
- Uses LIFO queue for connection reuse to improve cache locality
- Implements comprehensive retry logic with exponential backoff
- Supports both blocking and non-blocking connection acquisition
- Handles proxy detection and tunneling automatically
- Uses weak references to prevent memory leaks in connection cleanup
- Thread-safe design for concurrent request handling

## Critical Invariants
- Connection pool size never exceeds maxsize when blocking=True
- All connections are properly closed on pool shutdown
- SSL warnings issued for unverified HTTPS connections
- Request body position tracking for retry scenarios
- Connection validation occurs before each request