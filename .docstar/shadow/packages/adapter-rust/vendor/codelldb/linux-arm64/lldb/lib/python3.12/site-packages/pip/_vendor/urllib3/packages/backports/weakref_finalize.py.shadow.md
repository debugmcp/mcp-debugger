# packages/adapter-rust/vendor/codelldb/linux-arm64/lldb/lib/python3.12/site-packages/pip/_vendor/urllib3/packages/backports/weakref_finalize.py
@source-hash: b5109a97938084d4
@generated: 2026-02-09T17:56:56Z

## weakref_finalize.py

**Purpose**: Backport of Python 3's `weakref.finalize` functionality for Python 2 compatibility. Provides automatic cleanup of resources when objects are garbage collected.

### Core Components

**weakref_finalize class (L17-155)**: Main finalizer class that manages cleanup callbacks for weakly-referenced objects. Uses a registry-based design to avoid reference cycles.

**Key Methods:**
- `__init__` (L43-59): Registers cleanup callback, auto-registers exit handler on first use
- `__call__` (L61-66): Executes cleanup function when triggered, marks finalizer as dead
- `detach` (L68-74): Removes finalizer and returns object/callback details if still alive  
- `peek` (L76-82): Non-destructively inspects finalizer state
- `alive` property (L84-87): Checks if finalizer is still active
- `atexit` property (L89-99): Controls whether finalizer runs at program exit

**Class Attributes:**
- `_registry` (L34): Maps finalizer instances to `_Info` objects containing state
- `_shutdown` (L35): Prevents execution during program shutdown
- `_index_iter` (L36): Provides creation ordering for exit-time execution
- `_dirty` (L37): Tracks registry modifications for exit processing
- `_registered_with_atexit` (L38): Ensures single atexit registration

**_Info nested class (L40-41)**: Data container for finalizer state using `__slots__` for memory efficiency.

**Exit Handling:**
- `_select_for_exit` (L114-119): Returns live finalizers marked for exit, ordered by creation time
- `_exitfunc` (L121-155): Program exit handler that runs finalizers with garbage collection disabled to prevent interference

### Architecture Patterns

- **Registry Pattern**: Uses global registry to track finalizer instances and their state
- **Weak References**: Prevents reference cycles by weakly referencing target objects
- **Singleton Registration**: atexit handler registered only once per class
- **Thread Safety**: Uses atomic operations and handles race conditions in registration

### Critical Invariants

- Finalizer objects contain no state (enforced by `__slots__ = ()`)
- Registry cleanup maintains consistency between finalizer lifecycle and object lifecycle
- Exit-time execution occurs in reverse creation order with GC disabled
- Finalizers become "dead" after single execution and return None on subsequent calls