# packages/adapter-rust/vendor/codelldb/linux-arm64/lldb/lib/python3.12/site-packages/pip/_vendor/cachecontrol/caches/file_cache.py
@source-hash: f4096699325ce9cb
@generated: 2026-02-09T17:57:50Z

## Purpose and Responsibility

File-based cache implementation for pip's HTTP caching system. Provides thread-safe, disk-persistent storage for HTTP responses with security features to prevent symlink attacks and race conditions.

## Key Classes and Functions

### `_secure_open_write(filename, fmode)` (L21-59)
Security-hardened file creation function that:
- Uses exclusive creation flags to prevent race conditions
- Prevents symlink following attacks with `O_NOFOLLOW`
- Atomically removes existing files before creation
- Handles platform-specific binary mode flags

### `_FileCacheMixin` (L62-142)
Base mixin providing core file cache functionality:
- **`__init__()`** (L65-92): Configures cache directory, file permissions, and file locking
- **`encode()`** (L94-96): SHA224 hash function for key encoding
- **`_fn()`** (L98-103): Generates hierarchical file paths using hash prefixes for distribution
- **`get()`** (L105-112): Reads cached data from disk
- **`set()`** (L114-118): Stores data using secure write operations
- **`_write()`** (L120-133): Thread-safe file writing with directory creation and file locking
- **`_delete()`** (L135-141): Conditional file deletion respecting `forever` flag

### `FileCache` (L144-151)
Traditional cache storing complete responses in memory. Inherits from `_FileCacheMixin` and `BaseCache`.
- **`delete()`** (L150-151): Removes main cache file

### `SeparateBodyFileCache` (L154-173)
Memory-efficient cache storing response bodies in separate `.body` files. Inherits from `_FileCacheMixin` and `SeparateBodyBaseCache`.
- **`get_body()`** (L160-165): Returns file handle for response body
- **`set_body()`** (L167-169): Stores response body in separate file
- **`delete()`** (L171-173): Removes both main cache file and body file

### `url_to_file_path()` (L176-181)
Utility function that converts URLs to cache file paths using `CacheController.cache_url()`.

## Dependencies

- **filelock**: Required dependency for thread-safe file operations
- **pip._vendor.cachecontrol.cache**: Base cache interfaces
- **pip._vendor.cachecontrol.controller**: Cache URL processing

## Architectural Patterns

- **Mixin Pattern**: Common functionality in `_FileCacheMixin`, specialized by inheritance
- **Template Method**: Abstract cache interfaces implemented with file operations
- **Security by Design**: Multiple layers preventing symlink and race condition attacks
- **Hierarchical Storage**: Hash-based directory distribution prevents filesystem bottlenecks

## Critical Invariants

- File paths are deterministic based on SHA224 hash of cache keys
- All write operations are atomic and thread-safe via file locking
- Cache files use restrictive permissions (0o0600 default)
- The `forever` flag prevents deletion when enabled
- `.body` suffix distinguishes response body files in separate body cache