# packages/adapter-rust/vendor/codelldb/linux-arm64/lldb/lib/python3.12/site-packages/pip/_vendor/truststore/_windows.py
@source-hash: 7a574d5621cd1de6
@generated: 2026-02-09T18:01:07Z

## Purpose and Responsibility
Windows-specific certificate verification implementation using Windows CryptoAPI for the truststore package. Provides X.509 certificate chain validation against Windows certificate stores as an alternative to OpenSSL verification.

## Core Architecture

**Windows API Structures (L39-196)**
- `CERT_CONTEXT` (L39-46): Represents a certificate context with encoding type, certificate data, and store handle
- `CERT_CHAIN_*` structures (L70-141): Define certificate chain validation parameters and contexts
- `SSL_EXTRA_CERT_CHAIN_POLICY_PARA` (L144-150): SSL-specific policy parameters including server name
- `CERT_CHAIN_ENGINE_CONFIG` (L177-193): Configuration for custom certificate chain engines

**Windows API Function Bindings (L244-319)**
- Certificate store operations: `CertOpenStore`, `CertAddEncodedCertificateToStore`, `CertCloseStore`
- Chain building: `CertGetCertificateChain`, `CertCreateCertificateChainEngine`
- Verification: `CertVerifyCertificateChainPolicy`
- Memory management: `CertFreeCertificateContext`, `CertFreeCertificateChain`

## Key Functions

**`_verify_peercerts_impl()` (L322-412)**
Primary verification entry point. Takes SSL context, certificate chain bytes, and optional server hostname. Implements two-stage verification:
1. Attempts verification against Windows system trust store
2. Falls back to custom CA verification if system verification fails and custom CAs are loaded

**`_get_and_verify_cert_chain()` (L414-500)**
Core chain building and verification logic. Creates certificate chain, applies SSL policy parameters, and handles hostname verification based on SSL context settings. Converts Windows error codes to SSL exceptions with human-readable messages.

**`_verify_using_custom_ca_certs()` (L502-552)**
Fallback verification using custom CA certificates. Creates in-memory certificate store, populates with custom CAs, and builds custom chain engine for exclusive trust validation.

**`_configure_context()` (L554-564)**
Context manager that temporarily disables SSL context verification to allow custom Windows-based verification.

## Constants and Configuration

**Encoding and Store Constants (L198-201)**
- X.509/PKCS#7 encoding flags
- Memory-based certificate store provider

**Policy Flags (L204-231)**
- Revocation checking options
- Certificate validation bypass flags for CERT_NONE mode
- Combined flag set `CERT_CHAIN_POLICY_VERIFY_MODE_NONE_FLAGS` for permissive validation

## Dependencies
- `ssl`: Python SSL module integration
- `ctypes`: Windows API bindings
- `_ssl_constants`: SSL context configuration utilities

## Critical Behavior Patterns
- Two-tier verification strategy: system store first, custom CAs second
- Proper resource cleanup with try/finally blocks for Windows handles
- Error handling preserves original exceptions when fallback fails
- Hostname verification controlled by SSL context settings
- CRL checking respects SSL context verify_flags