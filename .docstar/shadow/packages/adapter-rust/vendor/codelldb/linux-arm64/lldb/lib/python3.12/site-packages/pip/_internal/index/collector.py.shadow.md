# packages/adapter-rust/vendor/codelldb/linux-arm64/lldb/lib/python3.12/site-packages/pip/_internal/index/collector.py
@source-hash: 45d3ced092c0966c
@generated: 2026-02-09T18:00:30Z

## Primary Purpose

This module implements link collection functionality for pip's package index system. It fetches and parses PyPI Simple API responses (HTML/JSON) and local file directories to discover downloadable package links. The main entry point is `LinkCollector.collect_sources()`.

## Key Classes and Functions

### LinkCollector (L390-494)
Main orchestrator class that collects package links from configured sources.
- `__init__(session, search_scope)` (L398): Initialize with HTTP session and search configuration
- `create(session, options, suppress_no_index=False)` (L406): Factory method that processes command-line options into SearchScope
- `collect_sources(project_name, candidates_from_page)` (L450): **Primary method** - collects LinkSource objects from index URLs and find-links, returns CollectedSources
- `fetch_response(location)` (L444): Wrapper around `_get_index_content()` for fetching individual pages

### IndexContent (L252-271)  
Frozen dataclass representing a fetched page's content and metadata.
- Fields: `content` (bytes), `content_type`, `encoding`, `url`, `cache_link_parsing` (bool)
- Used as input to link parsing functions

### HTMLLinkParser (L273-299)
HTMLParser subclass for extracting links from HTML Simple API responses.
- Tracks first `<base>` href and collects all `<a>` tag attributes
- `handle_starttag()` (L286): Processes base and anchor tags

## Core Functions

### _get_index_content(link, session) (L324-382)
Central function for fetching page content with comprehensive error handling.
- Handles VCS URL rejection, file:// directory detection
- Manages multiple exception types (network, SSL, content-type errors)
- Returns IndexContent or None on failure

### parse_links(page) (L223-249) 
**@with_cached_index_content decorated** - Parses IndexContent into Link objects.
- Supports both JSON (application/vnd.pypi.simple.v1+json) and HTML formats
- JSON: parses `files` array using `Link.from_json()`
- HTML: uses HTMLLinkParser + `Link.from_element()`

### _get_simple_response(url, session) (L113-173)
HTTP client for Simple API endpoints with content-type validation.
- Pre-flight HEAD request for suspected archives
- Sets Accept headers prioritizing JSON over HTML
- Uses `Cache-Control: max-age=0` for fresh responses (see L141-154 comment)

## Utility Functions

- `_match_vcs_scheme(url)` (L51): Detects VCS URLs (git+, svn+, etc.)
- `_ensure_api_header(response)` (L69): Validates content-type headers
- `with_cached_index_content(fn)` (L203): Decorator for LRU caching based on CacheablePageContent

## Dependencies

- **External**: `pip._vendor.requests`, `html.parser.HTMLParser`
- **Internal**: `Link`, `SearchScope`, `PipSession`, VCS handling, network utilities
- **Local**: `.sources.build_source()` for LinkSource construction

## Architecture Patterns

- **Caching**: Link parsing results cached by URL when `cache_link_parsing=True`
- **Error handling**: Comprehensive exception catching with graceful degradation
- **Content negotiation**: Supports both legacy HTML and modern JSON Simple API formats
- **Factory pattern**: `LinkCollector.create()` abstracts option processing

## Critical Constraints

- Index URLs have `cache_link_parsing=False` to ensure fresh package discovery
- Find-links sources have `cache_link_parsing=True` for performance
- File URLs automatically append "index.html" for directories
- VCS URLs are rejected at the HTTP client level