# packages/adapter-rust/vendor/codelldb/linux-arm64/lldb/lib/python3.12/site-packages/pip/_vendor/rich/ansi.py
@source-hash: 883eb9df6418aa70
@generated: 2026-02-09T18:01:00Z

## ANSI Code Parser and Decoder

**Primary Purpose**: Parses ANSI escape sequences from terminal output and converts them into Rich's styled Text objects for rendering.

### Core Components

**ANSI Regex Parser (L10-16)**
- `re_ansi`: Regex pattern matching OSC (Operating System Command) and SGR (Select Graphic Rendition) escape sequences
- Handles both `\x1b](.*?)\x1b\\` (OSC sequences) and `\x1b[...` (control sequences)

**_AnsiToken NamedTuple (L19-25)**
- Represents tokenized ANSI text with fields: `plain` (text content), `sgr` (style codes), `osc` (link codes)

**_ansi_tokenize Function (L27-56)**
- Core tokenizer that splits ANSI text into tokens
- Yields _AnsiToken instances for plain text and escape sequences
- Handles special case for SGR codes ending with 'm'
- Skips sequences starting with '(' (continuation markers)

**SGR_STYLE_MAP Dictionary (L58-116)**
- Maps SGR numeric codes to Rich style strings
- Covers text formatting (bold, italic, underline), colors (0-15), background colors, and special effects
- Includes reset codes (22-29) and extended formatting (frame, encircle, overline)

**AnsiDecoder Class (L119-211)**
- Main decoder translating ANSI codes to Rich Text objects
- `__init__` (L122-123): Initializes with null style state
- `decode` (L125-135): Processes multi-line terminal text, splits by lines
- `decode_line` (L137-210): Core line processing logic
  - Handles OSC link sequences (8; prefix for hyperlinks)
  - Processes SGR codes with state machine approach
  - Supports 256-color mode (code 38/48 + 5) and RGB mode (code 38/48 + 2)
  - Maintains cumulative style state across tokens

### Key Dependencies
- Rich's Color, Style, and Text classes for output formatting
- Standard library: re, sys, contextlib.suppress, typing

### Architecture Notes
- State-based decoder maintains style across tokens within a line
- Robust error handling with suppress() for malformed color sequences
- Performance optimizations: local variable assignments for frequently used functions (L146-150)
- Carriage return handling: keeps only rightmost content after '\r' (L151)

### Main Script (L213-240)
- Unix-only terminal spawning utility using pty
- Captures and decodes command output, saves as HTML
- Demonstrates practical usage of the decoder