# packages/adapter-rust/vendor/codelldb/linux-arm64/lldb/lib/python3.12/site-packages/pip/_vendor/truststore/_macos.py
@source-hash: 549db86afcf96841
@generated: 2026-02-09T18:01:09Z

## Purpose
macOS-specific certificate verification implementation using Apple's Security and CoreFoundation frameworks via ctypes. Provides peer certificate validation for SSL/TLS connections using the system's trust store and native macOS security APIs.

## Core Architecture
- **Platform Compatibility**: Enforces macOS 10.8+ requirement (L21-26)
- **Framework Loading**: Dynamic loading of Security and CoreFoundation frameworks with Big Sur compatibility (L29-52)
- **Type System**: Extensive ctypes type definitions mapping C types to Python (L54-82, L84-201)
- **Error Handling**: Custom OSStatus error handling with message extraction (L204-261)

## Key Functions

### `_load_cdll(name, macos10_16_path)` (L29-43)
Loads system frameworks with fallback path handling for Big Sur (10.16+). Uses find_library for older versions, hardcoded paths for newer ones.

### `_handle_osstatus(result, _, args)` (L204-254)
Critical error handler for Security framework calls. Converts OSStatus codes to Python exceptions with localized error messages via CFString conversion.

### `_der_certs_to_cf_cert_array(certs)` (L317-344)
Converts list of DER-encoded certificate bytes to CFArray of SecCertificateRefs. Handles memory management with proper CFRelease cleanup.

### `_configure_context(ctx)` (L347-357)
Context manager that temporarily disables SSL context verification to allow custom validation logic.

### `_verify_peercerts_impl(ssl_context, cert_chain, server_hostname)` (L360-499)
**Primary verification function**. Implements full certificate chain validation using macOS Security framework:
- Creates SSL policy with optional hostname verification (L370-380)
- Handles CRL checking policies (L382-398)
- Builds SecTrust object from certificate chain (L400-415)
- Applies custom CA certificates if present (L417-429)
- Evaluates trust and handles verification errors (L434-493)

## Framework Bindings

### Security Framework (L84-124)
- Certificate creation and data extraction
- Trust object management and evaluation
- Policy creation (SSL, revocation)
- Error message retrieval

### CoreFoundation Framework (L125-198)
- String creation and conversion utilities
- Data and array management
- Memory management (CFRelease)
- Error handling utilities

## Constants and Types

### `CFConst` class (L263-272)
Defines critical constants including UTF-8 encoding and common Security framework error codes.

## Memory Management
Extensive use of CFRelease calls throughout to prevent memory leaks in CoreFoundation objects. Critical in functions handling certificate arrays and string conversions.

## Dependencies
- `ctypes` for C library interaction
- `ssl` for SSL context integration
- `._ssl_constants` for SSL context utilities
- Platform-specific macOS Security and CoreFoundation frameworks