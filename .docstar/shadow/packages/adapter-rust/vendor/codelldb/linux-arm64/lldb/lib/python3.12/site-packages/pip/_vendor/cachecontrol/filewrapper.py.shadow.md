# packages/adapter-rust/vendor/codelldb/linux-arm64/lldb/lib/python3.12/site-packages/pip/_vendor/cachecontrol/filewrapper.py
@source-hash: 493b6d1a620f06f6
@generated: 2026-02-09T18:00:33Z

**CallbackFileWrapper (L14-119)**: HTTP response stream wrapper that tees all read data into a temporary file and executes a callback with the buffered content when the stream closes.

## Core Functionality
- **Transparent proxying**: All attributes/methods are proxied to the underlying HTTPResponse via `__getattr__` (L40-50)
- **Data buffering**: Uses `NamedTemporaryFile` (L36) to capture all read data without memory pressure
- **Callback execution**: Invokes callback with complete buffered data when stream closes

## Key Methods
- **`__init__` (L33-38)**: Initializes wrapper with HTTPResponse and optional callback, creates temporary buffer
- **`read` (L97-106)**: Primary read method that tees data to buffer and triggers cleanup on stream close
- **`_safe_read` (L108-119)**: Handles chunked transfer encoding reads, with special case for CRLF terminators
- **`_close` (L70-95)**: Executes callback with memory-mapped buffer data, breaks reference cycles, cleans up resources
- **`__is_fp_closed` (L52-68)**: Detects stream closure through multiple fallback attribute checks

## Memory Management Strategy
- Uses `mmap` (L81-83) to avoid loading large files into memory
- Temporary file leverages filesystem cache for small files
- Breaks reference cycles (L91) to prevent garbage collection deadlocks
- Double-underscore naming (L22-24) prevents attribute shadowing

## Architecture Patterns
- Proxy pattern with attribute delegation
- Resource management with automatic cleanup
- Defensive programming with multiple closure detection strategies
- Memory-efficient streaming with mmap integration

## Dependencies
- `mmap`: Memory-mapped file access
- `tempfile.NamedTemporaryFile`: Temporary file management
- `http.client.HTTPResponse`: Type hint for wrapped object

## Critical Constraints
- Callback must accept `bytes` or `memoryview`
- Temporary file deletion handled automatically
- Stream closure detection is best-effort with fallbacks