# packages/adapter-rust/vendor/codelldb/linux-arm64/lldb/lib/python3.12/site-packages/pip/_vendor/msgpack/fallback.py
@source-hash: c1d516264597da0c
@generated: 2026-02-09T18:00:51Z

## Pure Python MessagePack Implementation

A fallback pure Python implementation of the MessagePack serialization format, providing both streaming and one-shot packing/unpacking capabilities.

### Key Components

**Platform-Specific Optimizations (L7-41)**
- PyPy-specific StringBuilder optimization using `__pypy__.builders.StringBuilder` for faster byte concatenation
- Custom `StringIO` wrapper (L18-34) for PyPy that uses StringBuilder internally
- Falls back to standard `io.BytesIO` on other Python implementations

**Core Functions**

**`unpackb(packed, **kwargs)` (L77-99)**
- One-shot unpacking function that deserializes msgpack bytes to Python objects
- Creates temporary `Unpacker` instance and handles common exceptions
- Converts `OutOfData` to `ValueError`, `RecursionError` to `StackError`
- Validates no extra data remains after unpacking

**Constants and Type System (L48-61)**
- Execution modes: `EX_SKIP`, `EX_CONSTRUCT`, `EX_READ_ARRAY_HEADER`, `EX_READ_MAP_HEADER`
- Type identifiers: `TYPE_IMMEDIATE`, `TYPE_ARRAY`, `TYPE_MAP`, `TYPE_RAW`, `TYPE_BIN`, `TYPE_EXT`
- Default recursion limit: 511

**MessagePack Header Mapping (L102-132)**
- `_MSGPACK_HEADERS` dictionary maps msgpack format bytes to unpacking instructions
- Contains size, struct format, and type information for each msgpack header byte

### Main Classes

**`Unpacker` (L135-605)**
Streaming deserializer supporting both file-like objects and manual feeding.

Key methods:
- `__init__()` (L231-321): Extensive configuration options for limits, hooks, and type handling
- `feed(next_bytes)` (L322-336): Adds data to internal buffer for streaming
- `_read_header()` (L395-489): Core msgpack header parsing logic with format validation
- `_unpack(execute=EX_CONSTRUCT)` (L491-563): Recursive unpacking with execution mode control
- `__next__()` (L568-578): Iterator protocol support for streaming
- Buffer management methods: `_consume()`, `_reserve()`, `_read()`

**`Packer` (L607-951)**
MessagePack serializer with extensive type support and optimization options.

Key methods:
- `__init__()` (L676-696): Configuration for float precision, binary types, strict typing
- `_pack()` (L698-820): Core recursive packing logic with type detection and conversion
- `pack(obj)` (L822-831): Main serialization entry point with auto-reset
- Header packing methods: `_pack_array_header()`, `_pack_map_header()`, `_pack_raw_header()`, `_pack_bin_header()`
- Utility methods: `bytes()`, `reset()`, `getbuffer()`

### Architecture Patterns

**Buffer Management**
- Checkpoint-based buffer consumption to handle incomplete data gracefully
- Automatic buffer trimming to prevent memory leaks during streaming
- Size limits and overflow protection for all data types

**Type System**
- Strict vs loose type checking modes
- Extensive hook system for custom object handling (`object_hook`, `object_pairs_hook`, `list_hook`, `ext_hook`)
- Special handling for timestamps, datetime objects, and extension types

**Error Handling**
- Comprehensive validation with specific exception types
- Recursion depth tracking to prevent stack overflow
- Buffer size limits to prevent memory exhaustion

**Performance Optimizations**
- Platform-specific I/O optimizations (PyPy StringBuilder)
- Efficient struct packing/unpacking for binary data
- Memory view support for zero-copy operations where possible