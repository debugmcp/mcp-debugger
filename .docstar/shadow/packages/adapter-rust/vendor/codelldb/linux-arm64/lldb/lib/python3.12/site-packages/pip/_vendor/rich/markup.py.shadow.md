# packages/adapter-rust/vendor/codelldb/linux-arm64/lldb/lib/python3.12/site-packages/pip/_vendor/rich/markup.py
@source-hash: ddeb8628fe6ce353
@generated: 2026-02-09T18:01:02Z

**Primary Purpose:** Rich markup parsing and rendering engine that converts console markup strings (e.g., `[bold]text[/bold]`) into styled Text objects with proper escape handling and emoji support.

**Core Architecture:**
- Uses regex-based parsing with `RE_TAGS` (L12-15) to identify markup tags in format `[tag=params]`
- Maintains a style stack for nested tag handling during rendering
- Supports both explicit and implicit tag closing mechanisms
- Handles special meta tags starting with `@` for advanced functionality

**Key Components:**

**Tag (L20-41):** NamedTuple representing parsed markup tags
- `name`: tag identifier (e.g., 'bold', 'red')
- `parameters`: optional tag parameters after `=`
- `markup` property: reconstructs original tag syntax

**escape() (L48-71):** Escapes markup characters to prevent interpretation
- Uses regex substitution to add backslashes before tag-like patterns
- Handles edge case of trailing single backslash

**_parse() (L73-104):** Core parser yielding tuples of (position, text, tag)
- Handles escaped characters via backslash counting with `divmod`
- Processes both literal text and tag elements sequentially
- Manages tag parameter parsing with `partition("=")`

**render() (L106-231):** Main rendering function converting markup to Text objects
- **Input:** markup string, base style, emoji options
- **Process:** 
  - Fast path for markup-free strings (L128-132)
  - Maintains `style_stack` for nested tag tracking (L137)
  - Builds `spans` list for style application ranges (L140)
  - Handles meta tags (`@` prefix) with parameter evaluation via `literal_eval` (L189-198)
- **Output:** Text object with applied spans and styles

**Critical Parsing Logic:**
- Closing tags (`/tagname`) pop from style stack with error handling for mismatched tags
- Meta tags create Style objects with meta dictionaries for custom handlers
- Style normalization ensures consistent tag naming
- Span generation tracks character ranges for style application

**Dependencies:**
- `Style`, `Text`, `Span` from rich.text/style modules
- `_emoji_replace` for emoji processing
- `literal_eval` for safe parameter parsing
- `MarkupError` for parsing exceptions

**Error Handling:**
- Validates tag matching and proper nesting
- Catches syntax errors in meta tag parameters
- Provides position-aware error messages