# packages/adapter-rust/vendor/codelldb/linux-arm64/lldb/lib/python3.12/site-packages/pip/_vendor/urllib3/contrib/securetransport.py
@source-hash: 15e7f5208514147a
@generated: 2026-02-09T17:57:57Z

# SecureTransport SSL Support for urllib3

**Primary Purpose**: Provides macOS SecureTransport-based SSL/TLS support for urllib3 via ctypes, enabling TLS 1.2+ connections on macOS without requiring compilation.

## Key Components

### Module Functions
- `inject_into_urllib3()` (L188-197): Monkey-patches urllib3 to use SecureTransportContext instead of standard SSL
- `extract_from_urllib3()` (L200-209): Reverses monkey-patching to restore original urllib3 SSL behavior

### Core Classes

#### WrappedSocket (L325-782)
SSL socket wrapper providing OpenSSL-compatible API over SecureTransport:
- `__init__(socket)` (L333-349): Initializes with base socket, stores original timeout
- `handshake()` (L473-564): Performs TLS handshake with comprehensive parameter support
- `recv()` / `recv_into()` (L576-623): Read operations with timeout and error handling
- `send()` / `sendall()` (L631-652): Write operations with chunking for large data
- `getpeercert()` (L677-733): Returns peer certificate in DER format only
- `version()` (L735-754): Returns negotiated TLS version string
- `close()` (L658-675): Cleanup including keychain deletion

#### SecureTransportContext (L784-920)
SSLContext-compatible interface for SecureTransport:
- `__init__(protocol)` (L791-799): Maps protocol to min/max TLS versions
- Properties: `check_hostname` (always True), `verify_mode`, `options`
- `load_verify_locations()` (L860-870): Supports cafile/cadata but not capath
- `set_alpn_protocols()` (L877-887): ALPN support for macOS 10.12+
- `wrap_socket()` (L889-920): Creates WrappedSocket and initiates handshake

### Callback Functions
- `_read_callback()` (L212-264): SecureTransport read callback with timeout handling
- `_write_callback()` (L267-315): SecureTransport write callback with chunked sending

## Key Dependencies
- SecureTransport bindings: `CoreFoundation`, `Security`, `SecurityConst` (L70)
- Low-level helpers: `_assert_no_error`, `_cert_array_from_pem`, etc. (L71-78)
- Python 2/3 compatibility via `_fileobject` / `backport_makefile` (L80-84)

## Important Constants
- `CIPHER_SUITES` (L120-151): Predefined cipher suite list matching urllib3 defaults
- `_protocol_to_min_max` (L156-185): Maps Python SSL protocols to SecureTransport constants
- `SSL_WRITE_BLOCKSIZE = 16384` (L115): Write chunk size limit
- `_connection_refs` (L110): WeakValueDictionary for callback socket lookup

## Architecture Notes
- Uses ctypes exclusively to avoid compilation requirements
- Thread-safe connection reference tracking via `_connection_ref_lock` (L111)
- Implements custom certificate validation via `_custom_validate()` (L398-431)
- Temporary keychain creation for client certificates
- Error propagation from I/O callbacks via `_raise_on_error()` context manager (L351-370)

## Critical Constraints
- macOS only (SecureTransport is Apple's SSL library)
- No custom cipher string support
- No certificate directory support (capath)
- Binary certificate format only
- No server-side SSL support
- Hostname checking cannot be disabled