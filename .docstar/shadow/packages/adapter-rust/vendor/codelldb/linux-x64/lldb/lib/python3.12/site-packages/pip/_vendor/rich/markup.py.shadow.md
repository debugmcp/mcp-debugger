# packages/adapter-rust/vendor/codelldb/linux-x64/lldb/lib/python3.12/site-packages/pip/_vendor/rich/markup.py
@source-hash: ddeb8628fe6ce353
@generated: 2026-02-09T18:01:56Z

## Purpose
Console markup parser and renderer for the Rich text formatting library. Provides functionality to parse and render markup tags (e.g., `[bold]text[/bold]`) into styled text objects, with support for escaping, emoji processing, and style stacking.

## Key Components

### Core Regular Expressions
- `RE_TAGS` (L12-15): Main regex for matching markup tags with backslash escaping support
- `RE_HANDLER` (L17): Regex for parsing handler names and parameters in meta tags

### Tag Class
- `Tag` (L20-41): NamedTuple representing a markup tag with name and optional parameters
  - `.markup` property (L33-40): Returns string representation of the tag in markup format

### Core Functions

#### escape() (L48-71)
Escapes text to prevent markup interpretation by adding backslashes before tag-like patterns. Uses internal `escape_backslashes()` helper function for regex substitution.

#### _parse() (L73-104)
Internal parser that tokenizes markup into tuples of `(position, text, tag)`. Handles:
- Text segments between tags
- Backslash escaping logic with divmod calculation for literal backslashes vs escaped tags
- Tag parameter parsing using partition on '=' character

#### render() (L106-231) 
Main rendering function that converts markup string to Rich Text object. Core algorithm:
- Fast path for strings without '[' brackets (L128-132)
- Style stack management for nested tags (L137-151)
- Tag processing loop (L153-221):
  - Closing tags (L159-218): Handles explicit (`/name`) and implicit (`/`) closes
  - Meta tags with '@' prefix: Parses parameters using `literal_eval()` for safety
  - Opening tags: Normalizes and pushes to stack
- Span generation and sorting (L223-231)

### Type Aliases (L43-46)
Type hints for regex match objects and substitution callables used in escaping logic.

## Dependencies
- `Style` from `.style`: Style objects and normalization
- `Text`, `Span` from `.text`: Text container and span objects  
- `_emoji_replace` from `._emoji_replace`: Emoji processing
- `MarkupError` from `.errors`: Exception for markup syntax errors

## Key Patterns
- Style stack with explicit/implicit closing tag support
- Regex-based tokenization with backslash escape handling
- Meta tag system using '@' prefix for special handlers
- Safe parameter parsing using `literal_eval()` to prevent code injection
- Performance optimizations: caching method references, fast path for non-markup text

## Critical Invariants
- Tags must be properly nested (enforced by style stack)
- Backslash escaping follows specific rules: even number = literals, odd = escape next
- Meta tag parameters must be valid Python literals
- Spans are sorted by start position for proper text rendering