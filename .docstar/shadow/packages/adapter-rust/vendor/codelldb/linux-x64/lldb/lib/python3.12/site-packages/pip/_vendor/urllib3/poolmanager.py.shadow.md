# packages/adapter-rust/vendor/codelldb/linux-x64/lldb/lib/python3.12/site-packages/pip/_vendor/urllib3/poolmanager.py
@source-hash: 696ca15d1b4d3b82
@generated: 2026-02-09T18:02:10Z

## Purpose
HTTP connection pool management system for urllib3, providing automated connection pooling, proxy support, and request routing. Manages connection reuse and handles both direct connections and proxy connections transparently.

## Key Components

### PoolManager (L140-422)
Primary class for managing multiple HTTP connection pools with automatic pooling and connection reuse.

**Key attributes:**
- `pools` (L174): RecentlyUsedContainer for LRU connection pool caching
- `pool_classes_by_scheme` (L178): Maps schemes to connection pool classes
- `key_fn_by_scheme` (L179): Maps schemes to pool key generation functions
- `proxy`/`proxy_config` (L168-169): Proxy configuration (None for direct connections)

**Core methods:**
- `__init__(num_pools=10, headers=None, **connection_pool_kw)` (L171): Initialize with pool cache size and default headers
- `connection_from_host(host, port, scheme, pool_kwargs)` (L225): Get/create connection pool for host/port/scheme
- `connection_from_context(request_context)` (L248): Get connection pool from normalized request context
- `connection_from_pool_key(pool_key, request_context)` (L263): Thread-safe pool retrieval/creation using pool key
- `urlopen(method, url, redirect=True, **kw)` (L353): Main request method with redirect handling and cross-host logic

### ProxyManager (L424-536)
Extends PoolManager for proxy-based connections, supporting HTTP/HTTPS proxies with CONNECT tunneling.

**Key attributes:**
- `proxy` (L490): Parsed proxy URL
- `proxy_headers` (L491): Headers sent to proxy
- `proxy_ssl_context` (L492): SSL context for HTTPS proxies
- `proxy_config` (L493): ProxyConfig namedtuple with SSL context and forwarding settings

**Core methods:**
- `__init__(proxy_url, num_pools, headers, proxy_headers, proxy_ssl_context, use_forwarding_for_https, **kw)` (L464): Initialize with proxy configuration
- `connection_from_host(host, port, scheme, pool_kwargs)` (L501): Routes HTTPS to target, HTTP through proxy
- `_set_proxy_headers(url, headers)` (L511): Sets Accept and Host headers for proxy requests

### Key Data Structures

**PoolKey namedtuple (L73):**
Contains all parameters needed to uniquely identify a connection pool:
- Network: `key_scheme`, `key_host`, `key_port`
- SSL: `key_ssl_context`, `key_cert_file`, `key_ca_certs`, etc.
- Connection: `key_timeout`, `key_retries`, `key_maxsize`
- Proxy: `key__proxy`, `key__proxy_headers`, `key__proxy_config`

**ProxyConfig namedtuple (L76):**
- `ssl_context`: SSL context for proxy connections
- `use_forwarding_for_https`: Whether to forward HTTPS requests instead of tunneling

### Pool Key Generation

**_default_key_normalizer (L79-125):**
Normalizes request context into immutable pool key:
- Lowercases scheme and host for RFC 3986 compliance
- Converts mutable dict/list fields to frozenset/tuple
- Maps context keys to namedtuple fields with "key_" prefix
- Fills missing fields with None

**key_fn_by_scheme (L132-135):**
Global mapping of schemes to key normalization functions, customizable per PoolManager instance.

## Dependencies
- `RecentlyUsedContainer`: LRU cache for connection pools
- `HTTPConnectionPool`/`HTTPSConnectionPool`: Actual connection pool implementations
- `RequestMethods`: Mixin providing HTTP method convenience functions
- `parse_url`: URL parsing utility
- `connection_requires_http_tunnel`: Proxy tunnel detection logic

## Architecture Patterns
- **Factory Pattern**: Dynamic pool creation based on scheme/host/port
- **Object Pool Pattern**: Connection pool reuse with LRU eviction
- **Strategy Pattern**: Configurable key generation functions per scheme
- **Proxy Pattern**: ProxyManager wraps PoolManager with proxy-specific logic
- **Context Manager**: Supports `with` statement for resource cleanup

## Critical Invariants
- Pool keys must be immutable (frozensets, tuples, not dicts/lists)
- Thread-safe pool access via `pools.lock` (L271)
- SSL keywords filtered for HTTP schemes (L210-212)
- Proxy scheme validation limited to http/https (L483-484)
- Redirect handling preserves retries and removes unsafe headers (L392-406)