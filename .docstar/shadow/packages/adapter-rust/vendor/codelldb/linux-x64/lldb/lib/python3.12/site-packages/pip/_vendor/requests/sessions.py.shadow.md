# packages/adapter-rust/vendor/codelldb/linux-x64/lldb/lib/python3.12/site-packages/pip/_vendor/requests/sessions.py
@source-hash: ca44c8f145864a5b
@generated: 2026-02-09T18:01:58Z

## Primary Purpose

Core session management module for the requests library, providing persistent settings, cookie handling, connection pooling, and automatic redirect resolution across HTTP requests.

## Key Components

### Platform-Specific Clock Selection (L55-58)
- `preferred_clock`: Platform-optimized timing function (perf_counter on Windows, time.time elsewhere)
- Used for request timing measurements

### Utility Functions

#### `merge_setting()` (L61-88)
Merges request-level and session-level settings with intelligent handling:
- Prioritizes request settings over session settings
- Performs deep merge for dictionary-type settings using `dict_class`
- Removes None values from merged results
- Used extensively throughout session preparation

#### `merge_hooks()` (L91-103)
Specialized merger for event hooks with edge case handling:
- Handles empty response hook arrays that would break session hooks
- Falls back to standard merge_setting for normal cases

### SessionRedirectMixin (L106-354)
Abstract base providing comprehensive redirect handling:

#### `get_redirect_target()` (L107-125)
- Extracts redirect URL from response Location header
- Handles UTF-8 encoding issues in headers via latin1 re-encoding
- Returns None if response is not a redirect

#### `should_strip_auth()` (L127-157)
Authorization header security logic:
- Strips auth when redirecting to different hostnames
- Special case: allows http→https redirect on standard ports (80→443)
- Considers scheme and port changes for auth stripping decisions

#### `resolve_redirects()` (L159-280)
Core redirect resolution generator:
- Maintains redirect history and enforces max_redirects limit
- Handles relative URLs, fragment preservation, and URL normalization
- Manages request body rewinding for redirects
- Processes cookies, auth, and proxy settings per redirect
- Yields either prepared requests or responses based on yield_requests flag

#### `rebuild_auth()` (L282-300)
- Strips authorization headers when redirecting across hosts
- Attempts to restore auth from .netrc for new hosts

#### `rebuild_proxies()` (L302-331)
- Re-evaluates proxy configuration considering NO_PROXY environment
- Handles Proxy-Authorization header management
- Returns updated proxy dictionary

#### `rebuild_method()` (L333-353)
HTTP method transformation for redirects:
- 303 responses: converts non-HEAD to GET
- 302 responses: converts non-HEAD to GET (browser behavior)
- 301 with POST: converts to GET (Issue 1704 compatibility)

### Session Class (L356-817)
Main session implementation inheriting from SessionRedirectMixin:

#### Initialization (L390-449)
Sets up default configuration:
- Headers, auth, proxies, hooks, params (all empty/None by default)
- SSL verification enabled, streaming disabled, environment trust enabled
- Default redirect limit (30), cookie jar, HTTP/HTTPS adapters mounted

#### `__attrs__` (L375-388)
Defines serializable attributes for state management

#### Context Manager Support (L451-455)
- `__enter__`: returns self
- `__exit__`: calls close()

#### Request Preparation (L457-498)
`prepare_request()`: Merges session and request settings:
- Handles cookie merging with RequestsCookieJar
- Applies netrc authentication when trust_env=True
- Creates PreparedRequest with merged headers, params, auth, cookies, hooks

#### HTTP Method Implementations (L593-671)
Convenience methods for standard HTTP verbs:
- `get()`, `options()`: default allow_redirects=True
- `head()`: default allow_redirects=False  
- `post()`, `put()`, `patch()`: accept data/json parameters
- `delete()`: basic implementation
All delegate to main `request()` method

#### Core Request Method (L500-591)
`request()`: Primary request interface:
- Creates Request object from parameters
- Prepares request with session settings
- Merges environment settings
- Delegates to `send()` method

#### Send Implementation (L673-748)
`send()`: Core request transmission:
- Validates PreparedRequest input
- Resolves proxies and applies session defaults
- Times request execution using preferred_clock
- Handles response hooks and cookie extraction
- Manages redirect resolution and history building
- Forces content loading when streaming disabled

#### Environment Integration (L750-779)
`merge_environment_settings()`: Environment variable processing:
- Applies HTTP_PROXY, HTTPS_PROXY when trust_env=True
- Respects NO_PROXY settings
- Handles REQUESTS_CA_BUNDLE, CURL_CA_BUNDLE for SSL verification

#### Adapter Management (L781-808)
- `get_adapter()`: URL-to-adapter resolution with longest prefix matching
- `mount()`: Registers adapters with automatic sorting by prefix length
- `close()`: Closes all mounted adapters

#### State Management (L810-816)
Pickle support via `__getstate__`/`__setstate__` using `__attrs__` definition

### Legacy Function (L819-831)
`session()`: Deprecated factory function for backward compatibility

## Key Dependencies
- HTTPAdapter for connection handling
- Cookie utilities for persistent cookie management
- Authentication utilities for auth header generation
- URL utilities for parsing and manipulation
- Hook system for extensible event handling

## Architecture Notes
- Mixin pattern separates redirect logic from core session management
- Extensive use of merge_setting for configuration layering
- Generator-based redirect resolution for memory efficiency
- Platform-aware timing for accurate request measurement
- Comprehensive environment variable integration