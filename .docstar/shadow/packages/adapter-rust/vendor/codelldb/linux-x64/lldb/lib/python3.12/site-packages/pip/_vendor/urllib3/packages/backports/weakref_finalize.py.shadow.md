# packages/adapter-rust/vendor/codelldb/linux-x64/lldb/lib/python3.12/site-packages/pip/_vendor/urllib3/packages/backports/weakref_finalize.py
@source-hash: b5109a97938084d4
@generated: 2026-02-09T17:56:54Z

## Purpose
Backports Python 3's `weakref.finalize` functionality for Python 2 compatibility. Provides automatic cleanup of resources when objects are garbage collected, with support for exit handlers.

## Core Architecture
**weakref_finalize class (L17-155)**: Main finalizer implementation that registers cleanup functions to be called when weakly-referenced objects are garbage collected. Uses a global registry pattern with thread-safe initialization.

**_Info class (L40-41)**: Internal data container with slots for storing finalizer metadata (weakref, func, args, kwargs, atexit flag, index).

## Key Components

### Initialization & Registration
- `__init__(obj, func, *args, **kwargs)` (L43-59): Creates finalizer, registers with atexit on first use, stores cleanup info in global registry
- Uses `itertools.count()` for unique indexing and ordering (L36)
- Thread-safe atexit registration with `_registered_with_atexit` flag (L38, L44-50)

### Core Methods
- `__call__(_=None)` (L61-66): Executes and removes finalizer, returns cleanup function result
- `detach()` (L68-74): Removes finalizer and returns (obj, func, args, kwargs) tuple
- `peek()` (L76-82): Non-destructively inspects finalizer state
- `alive` property (L85-87): Checks if finalizer is still registered
- `atexit` property + setter (L90-99): Controls whether finalizer runs at program exit

### Exit Handling
- `_select_for_exit()` (L114-119): Sorts live atexit finalizers by creation order (oldest first)
- `_exitfunc()` (L121-155): Shutdown handler that disables GC, processes pending finalizers, handles exceptions via `sys.excepthook`

## Global State Management
- `_registry = {}` (L34): Maps finalizer instances to _Info objects
- `_shutdown = False` (L35): Prevents execution after program shutdown
- `_dirty = False` (L37): Tracks when registry needs reprocessing during exit

## Dependencies
- `weakref.ref` for object lifecycle tracking
- `itertools.count` for unique indexing
- `atexit` module for program exit hooks
- `gc` module for garbage collection control during shutdown

## Key Patterns
- **Registry Pattern**: Central storage prevents reference cycles
- **Flyweight Pattern**: Finalizer objects have no instance state (`__slots__ = ()`)
- **Exit Safety**: Comprehensive shutdown handling with GC management and exception isolation