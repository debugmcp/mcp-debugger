# packages/adapter-rust/vendor/codelldb/linux-x64/lldb/lib/python3.12/site-packages/pip/_vendor/urllib3/contrib/_securetransport/low_level.py
@source-hash: 076241076fcd44fd
@generated: 2026-02-09T17:56:55Z

## Purpose
Low-level helpers for SecureTransport bindings on macOS, providing CoreFoundation memory management utilities, certificate handling, and TLS protocol support for urllib3's SecureTransport adapter.

## Key Functions

### CoreFoundation Data Conversion
- `_cf_data_from_bytes(bytestring)` (L27-34): Creates CFData from bytes, requires CFRelease by caller
- `_cf_dictionary_from_tuples(tuples)` (L37-56): Builds CFDictionary from Python tuples with proper memory management
- `_cfstr(py_bstr)` (L59-70): Converts Python binary string to CFString, requires CFRelease
- `_create_cfstring_array(lst)` (L73-101): Creates CFMutableArray from string list with exception safety

### String/Error Utilities
- `_cf_string_to_unicode(value)` (L104-126): Converts CFString to Unicode for error reporting, handles buffer fallback
- `_assert_no_error(error, exception_class=None)` (L129-147): Checks OSStatus codes, raises ssl.SSLError with descriptive messages

### Certificate Management
- `_cert_array_from_pem(pem_bundle)` (L150-193): Parses PEM certificate bundle into CFArray of SecCertificateRef objects
- `_is_cert(item)` (L196-201): Type checking for SecCertificateRef objects
- `_is_identity(item)` (L204-209): Type checking for SecIdentityRef objects

### Keychain Operations
- `_temporary_keychain()` (L212-244): Creates temporary keychain with random password, returns (keychain, temp_dir) tuple
- `_load_items_from_file(keychain, path)` (L247-299): Imports certificates/identities from file into keychain using SecItemImport
- `_load_client_cert_chain(keychain, *paths)` (L302-374): Builds client certificate trust chain from multiple files, ensures SecIdentityRef availability

### TLS Protocol Support
- `TLS_PROTOCOL_VERSIONS` (L377-383): Maps TLS version names to (major, minor) version tuples
- `_build_tls_unknown_ca_alert(version)` (L386-396): Constructs TLS alert record for unknown CA errors

## Dependencies
- **CoreFoundation/Security bindings** (L19): Native macOS framework access via ctypes
- **Standard libraries**: base64, ctypes, itertools, os, re, ssl, struct, tempfile

## Memory Management Pattern
All functions creating CoreFoundation objects expect caller to CFRelease them. Exception handling consistently releases resources on error paths. The module emphasizes avoiding memory leaks through careful ref counting.

## Critical Invariants
- SecIdentityRef requires key to be imported into keychain on macOS
- CFArrayAppendValue performs CFRetain, requiring balanced CFRelease
- PEM certificate parsing uses regex `_PEM_CERTS_RE` (L22-24)
- Temporary keychains use cryptographically secure random passwords