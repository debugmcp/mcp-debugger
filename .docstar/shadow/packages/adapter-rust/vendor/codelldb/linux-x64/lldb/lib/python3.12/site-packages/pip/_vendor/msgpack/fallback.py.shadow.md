# packages/adapter-rust/vendor/codelldb/linux-x64/lldb/lib/python3.12/site-packages/pip/_vendor/msgpack/fallback.py
@source-hash: c1d516264597da0c
@generated: 2026-02-09T18:01:42Z

## Purpose
Pure Python fallback implementation of MessagePack serialization/deserialization protocol. Provides complete msgpack encoding/decoding functionality when native C extensions are unavailable.

## Key Classes & Functions

### StringIO Implementation (L18-34)
PyPy-optimized StringIO using StringBuilder for performance. Falls back to standard io.BytesIO on other Python implementations.

### unpackb() (L77-99)
Top-level convenience function for unpacking msgpack bytes. Creates temporary Unpacker instance, handles common exceptions (OutOfData → ValueError, RecursionError → StackError), checks for extra data.

### Unpacker Class (L135-605)
**Core streaming unpacker with extensive configuration options:**
- `__init__()` (L231-321): Comprehensive parameter validation and configuration
- `_read_header()` (L395-489): Decodes msgpack type headers using _MSGPACK_HEADERS lookup table
- `_unpack()` (L491-563): Main recursive unpacking logic with execution modes (EX_SKIP, EX_CONSTRUCT, etc.)
- `feed()` (L322-335): Adds data to internal buffer for streaming
- `_reserve()` (L361-393): Buffer management and file reading logic
- Iterator interface (`__next__()` L568-577): Enables streaming unpacking

**Key features:**
- Streaming support via file-like objects or manual feeding
- Configurable limits (max_buffer_size, max_array_len, etc.) for security
- Hook system (object_hook, list_hook, object_pairs_hook) for custom deserialization
- Timestamp handling with multiple output formats
- Buffer management with checkpointing for error recovery

### Packer Class (L607-944)
**MessagePack encoder with type-specific serialization:**
- `__init__()` (L676-696): Configuration for float precision, autoreset, strict typing
- `_pack()` (L698-820): Main recursive packing logic with type dispatch
- Type-specific header packing methods:
  - `_pack_array_header()` (L887-894)
  - `_pack_map_header()` (L896-903)  
  - `_pack_raw_header()` (L911-921)
  - `_pack_bin_header()` (L923-933)
- `pack_ext_type()` (L858-885): Extension type serialization
- Buffer management: `bytes()`, `reset()`, `getbuffer()`

## Important Constants & Data Structures

### _MSGPACK_HEADERS (L103-132)
Lookup table mapping msgpack format codes to (size, struct_format, type) tuples. Critical for header parsing performance.

### Type Constants (L53-58)
- TYPE_IMMEDIATE, TYPE_ARRAY, TYPE_MAP, TYPE_RAW, TYPE_BIN, TYPE_EXT
- Used in unpacking state machine

### Execution Modes (L48-51)
- EX_SKIP, EX_CONSTRUCT, EX_READ_ARRAY_HEADER, EX_READ_MAP_HEADER
- Control unpacker behavior during recursive descent

## Dependencies
- struct: Binary data packing/unpacking
- sys: Python version detection and string interning
- datetime: Timestamp conversion support
- Local: .exceptions, .ext modules for error handling and extension types

## Architectural Patterns
- **State machine**: Unpacker uses execution modes for different parsing contexts
- **Buffer management**: Sophisticated checkpointing system for streaming and error recovery
- **Type dispatch**: Both Packer and Unpacker use extensive type checking with fallback chains
- **Hook system**: Configurable callbacks for custom serialization/deserialization
- **Platform optimization**: PyPy-specific StringIO implementation for performance