# packages/adapter-rust/vendor/codelldb/linux-x64/lldb/lib/python3.12/site-packages/pip/_internal/operations/prepare.py
@source-hash: 8e8589c0f92ea86b
@generated: 2026-02-09T18:01:28Z

**Core Responsibility**: Distribution preparation engine for pip installation - handles downloading, unpacking, hash verification, and metadata extraction for packages from various sources (HTTP, file, VCS).

## Key Components

### File Dataclass (L84-92)
Represents a downloaded file with path and auto-detected MIME type. Simple container for tracking files through the preparation pipeline.

### Core Functions

**`_get_prepared_distribution()` (L60-75)**: Entry point for building distribution metadata. Creates abstract distribution, tracks build process, and returns prepared metadata distribution.

**`unpack_vcs_link()` (L78-81)**: Handles VCS URL unpacking by delegating to appropriate VCS backend (git, svn, etc.).

**`get_http_url()` (L94-115)**: Downloads files from HTTP URLs with optional hash verification and download directory caching. Returns File object with path and content type.

**`get_file_url()` (L118-139)**: Handles local file URLs with hash verification and download directory support. Simpler than HTTP variant.

**`unpack_url()` (L142-182)**: Central dispatcher for URL unpacking - routes to VCS, file, or HTTP handlers based on link type. Only unpacks non-wheel archives.

**`_check_download_dir()` (L185-212)**: Validates previously downloaded files in download directory against expected hashes. Removes corrupted files and returns valid paths.

### RequirementPreparer Class (L215-732)
Main orchestrator for requirement preparation with extensive configuration options.

#### Key Methods:

**`prepare_linked_requirement()` (L491-527)**: Primary entry point for linked requirements. Implements optimization strategy: check cache → fetch metadata-only → full preparation.

**`prepare_linked_requirements_more()` (L529-557)**: Batch completion for partially downloaded requirements using lazy wheel/metadata-only optimization.

**`_prepare_linked_requirement()` (L559-649)**: Core preparation logic - handles source directory setup, downloading, unpacking, hash verification, and distribution building.

**`_fetch_metadata_only()` (L358-375)**: Attempts lightweight metadata fetching via PEP 658 or lazy wheel for dependency resolution optimization.

**`_fetch_metadata_using_link_data_attr()` (L377-416)**: PEP 658 implementation - downloads standalone METADATA file and validates package name consistency.

**`_fetch_metadata_using_lazy_wheel()` (L418-445)**: Downloads only wheel metadata via HTTP range requests for fast dependency resolution.

**`_complete_partial_requirements()` (L447-489)**: Batch downloader for completing partially prepared requirements, with link-to-requirement mapping.

**`save_linked_requirement()` (L651-675)**: Persists downloaded files to download directory, handling VCS archives and file copying.

**`prepare_editable_requirement()` (L677-708)**: Specialized handler for editable installs - ensures source directory and creates direct URL metadata.

**`prepare_installed_requirement()` (L710-732)**: Handler for already-satisfied requirements - logs skip reason and returns installed distribution metadata.

## Architecture Patterns

**Optimization Strategy**: Three-tier approach (cache check → metadata-only → full download) minimizes network I/O for dependency resolution.

**Hash Security**: Comprehensive hash verification with support for multiple algorithms, requirement pinning validation, and cache integrity checks.

**Error Handling**: Specialized exceptions for different failure modes (VCS hash unsupported, directory URL hash unsupported, network errors).

**Build Isolation**: Integrates with build tracker for proper build environment management and dependency checking.

## Dependencies
- Network layer: `Downloader`, `BatchDownloader` for HTTP operations
- VCS backends: Dynamic VCS system integration
- Distribution system: Abstract distribution creation and metadata handling
- Hash verification: `Hashes` class for cryptographic validation
- Temporary management: `TempDirectory` for cleanup automation