# packages/adapter-rust/vendor/codelldb/linux-x64/lldb/lib/python3.12/site-packages/pip/_vendor/urllib3/contrib/securetransport.py
@source-hash: 15e7f5208514147a
@generated: 2026-02-09T17:58:24Z

## Purpose
Provides macOS SecureTransport-backed SSL/TLS support for urllib3 using ctypes bindings, enabling TLSv1.2+ connections without requiring OpenSSL compilation. This is a compatibility shim that monkey-patches urllib3's SSL implementation.

## Key Components

### Public Interface Functions (L188-210)
- `inject_into_urllib3()` (L188-198): Monkey-patches urllib3 to use SecureTransport instead of OpenSSL
- `extract_from_urllib3()` (L200-210): Reverses the monkey-patching to restore original SSL implementation

### Core Classes

#### WrappedSocket (L325-782)
Primary SSL socket wrapper that implements the Python SSL socket interface using SecureTransport APIs.

**Key Methods:**
- `__init__(socket)` (L333-349): Initializes wrapper, saves original timeout, sets socket to non-blocking
- `handshake()` (L473-564): Performs TLS handshake with full parameter support including client certs, ALPN, custom trust bundles
- `recv()/recv_into()` (L576-623): Secure data reading with timeout handling
- `send()/sendall()` (L631-652): Secure data writing with chunking (16KB blocks per SSL_WRITE_BLOCKSIZE)
- `getpeercert()` (L677-733): Returns peer certificate in DER format only
- `version()` (L735-754): Returns negotiated TLS version string
- `close()` (L658-675): Cleanup including keychain deletion and CF object releases

**Internal Methods:**
- `_set_ciphers()` (L372-383): Configures allowed cipher suites from CIPHER_SUITES constant
- `_set_alpn_protocols()` (L385-396): Sets ALPN protocol negotiation
- `_custom_validate()` (L398-431): Custom certificate validation logic
- `_evaluate_trust()` (L433-471): Trust chain evaluation using custom CA bundle

#### SecureTransportContext (L784-920)
SSL context wrapper that translates standard library SSLContext interface to SecureTransport calls.

**Properties:**
- `check_hostname` (L801-815): Always returns True (cannot be disabled)
- `verify_mode` (L833-838): Maps to internal `_verify` boolean
- `options` (L817-830): Placeholder for SSL options (limited implementation)

**Key Methods:**
- `__init__(protocol)` (L791-799): Maps protocol constants to min/max TLS versions using `_protocol_to_min_max`
- `wrap_socket()` (L889-919): Creates WrappedSocket and initiates handshake
- `load_verify_locations()` (L860-870): Sets custom CA bundle (cafile or cadata only)
- `set_alpn_protocols()` (L877-887): Configures ALPN protocols with macOS 10.12+ requirement

### Callback Functions (L212-322)
- `_read_callback()` (L212-264): SecureTransport read callback using connection refs dictionary
- `_write_callback()` (L267-315): SecureTransport write callback with chunked sending
- Global callback pointers (L321-322): Prevents garbage collection of callback functions

## Critical Data Structures

### Connection Management (L94-111)
- `_connection_refs`: WeakValueDictionary mapping connection IDs to WrappedSocket instances
- `_connection_ref_lock`: Threading lock for safe connection ref insertion
- Handle computation uses `id(self) % 2147483647` with collision resolution

### Protocol Configuration (L120-185)
- `CIPHER_SUITES` (L120-151): Hardcoded list of supported cipher suites prioritizing modern AEAD ciphers
- `_protocol_to_min_max` (L156-185): Maps Python SSL protocol constants to SecureTransport version constants

## Dependencies
- Core: ctypes, ssl, socket, threading, weakref
- urllib3 internals: util, packages.six
- SecureTransport bindings: CoreFoundation, Security, SecurityConst
- Low-level utilities: _assert_no_error, _cert_array_from_pem, _temporary_keychain, etc.

## Architecture Notes
- Uses ctypes exclusively to avoid compilation requirements for pip compatibility
- Thread-safe connection reference management with performance-optimized callback access
- Graceful fallback patterns for missing Python 2/3 socket features
- Custom certificate validation bypasses system trust store when needed
- Memory management with explicit CoreFoundation CFRelease calls
- 16KB write block size limit following OpenSSL conventions

## Limitations
- macOS-only (SecureTransport framework)
- Binary certificate format only in getpeercert()
- No custom cipher string support
- No certificate directory support (capath)
- Server-side SSL not supported
- TLS 1.3 explicitly unsupported (L741-742)