# packages/adapter-rust/vendor/codelldb/linux-x64/lldb/lib/python3.12/site-packages/pip/_vendor/rich/ansi.py
@source-hash: 883eb9df6418aa70
@generated: 2026-02-09T18:01:55Z

## ANSI Terminal Code Parser and Decoder

**Primary Purpose**: Parses ANSI escape sequences from terminal text and converts them to Rich-compatible styled Text objects. Part of the Rich library's terminal output handling system.

### Key Components

**Regular Expression (L10-16)**
- `re_ansi`: Compiled regex pattern matching ANSI escape sequences
- Handles both OSC (Operating System Command) and SGR (Select Graphic Rendition) sequences
- Uses verbose mode for complex pattern matching

**Token Structure (L19-25)**
- `_AnsiToken`: NamedTuple representing parsed ANSI components
- Fields: `plain` (text content), `sgr` (style codes), `osc` (operating system commands)

**Core Parsing (L27-56)**
- `_ansi_tokenize()`: Generator function that splits ANSI text into tokens
- Processes text sequentially, yielding plain text and escape sequences separately
- Handles special case for `(` character in SGR sequences (L46-48)
- Strips `m` suffix from SGR codes for processing (L49-50)

**Style Mapping (L58-116)**
- `SGR_STYLE_MAP`: Comprehensive dictionary mapping SGR numeric codes to Rich style strings
- Covers text formatting (bold, italic, underline), colors (0-15), background colors, and special effects
- Includes both standard and extended ANSI codes

**Main Decoder Class (L119-210)**
- `AnsiDecoder`: Stateful decoder that maintains current style across processing
- `__init__()` (L122-123): Initializes with null style
- `decode()` (L125-135): Processes multi-line terminal output
- `decode_line()` (L137-210): Core method processing individual lines

**Line Processing Logic (L137-210)**
- Handles carriage return by taking rightmost segment (L151)
- Processes three token types: plain text, OSC commands, SGR codes
- OSC handling: Supports hyperlink sequences starting with "8;" (L156-159)
- SGR processing: Complex logic for color and style codes (L160-208)
  - Code 0: Reset to null style (L170-172)
  - Standard codes: Maps via `SGR_STYLE_MAP` (L173-175)
  - Code 38: Foreground color (256-color palette or RGB) (L176-191)
  - Code 48: Background color (256-color palette or RGB) (L192-208)

**Development/Debug Section (L213-240)**
- Platform-specific code for non-Windows systems
- Includes PTY spawning and HTML output generation for testing
- Creates console recorder and saves styled output to HTML file

### Dependencies
- `.color.Color`: Color creation and conversion
- `.style.Style`: Style composition and parsing
- `.text.Text`: Rich text object with styling
- Standard library: `re`, `contextlib.suppress`, `typing`

### Architecture Notes
- Uses iterator pattern for memory-efficient processing of large terminal outputs
- Maintains decoder state to handle multi-line ANSI sequences correctly
- Employs defensive programming with `suppress(StopIteration)` for malformed codes
- Optimizes performance with local variable assignments in hot path (L146-150)