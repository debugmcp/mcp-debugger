# packages/adapter-rust/vendor/codelldb/linux-x64/lldb/lib/python3.12/site-packages/pip/_vendor/truststore/_windows.py
@source-hash: 7a574d5621cd1de6
@generated: 2026-02-09T18:02:09Z

## Purpose
Windows-specific certificate verification implementation for the truststore library using Windows Crypto API (WinCrypt). Provides peer certificate chain validation using Windows certificate stores and chain verification policies.

## Key Structures (L39-196)
- **CERT_CONTEXT (L39-46)**: Core Windows certificate structure containing encoding type, certificate data, and store handle
- **CERT_CHAIN_CONTEXT (L127-138)**: Certificate chain structure with trust status and chain elements
- **CERT_CHAIN_PARA (L70-82)**: Parameters for certificate chain building including usage matching and timeout settings
- **SSL_EXTRA_CERT_CHAIN_POLICY_PARA (L144-150)**: SSL-specific chain policy parameters with server name and authentication type

## Constants (L198-231)
- Certificate encoding flags: `X509_ASN_ENCODING`, `PKCS_7_ASN_ENCODING` (L198-199)
- Chain verification flags for CRL checking (L204-205)
- Policy flags for different verification modes, combined into `CERT_CHAIN_POLICY_VERIFY_MODE_NONE_FLAGS` (L221-231)
- Server authentication OID: `OID_PKIX_KP_SERVER_AUTH` (L203)

## Windows API Function Bindings (L244-320)
Wraps WinCrypt functions with proper ctypes signatures:
- **CertCreateCertificateChainEngine** (L244-249): Creates custom chain validation engines
- **CertGetCertificateChain** (L272-284): Builds certificate chains
- **CertVerifyCertificateChainPolicy** (L286-293): Validates chains against policies
- **CertAddEncodedCertificateToStore** (L256-265): Adds certificates to stores
- Error handling via `_handle_win_error` (L237-241)

## Core Verification Functions

### _verify_peercerts_impl (L322-412)
Main certificate verification entry point:
1. Creates in-memory store for intermediate certificates (L335)
2. Adds intermediate certs to store (L338-346) 
3. Creates context for leaf certificate (L349-352)
4. Sets up chain parameters for server authentication (L354-363)
5. Attempts verification with default Windows roots (L375-383)
6. Falls back to custom CA verification if available (L389-402)
7. Proper resource cleanup in finally block (L408-411)

### _get_and_verify_cert_chain (L414-500)
Performs actual chain building and policy verification:
1. Builds certificate chain using Windows API (L427-436)
2. Configures SSL-specific policy parameters (L440-447)
3. Sets verification flags based on SSLContext settings (L453-456)
4. Verifies chain against SSL policy (L463-468)
5. Formats and raises SSLCertVerificationError on failure (L471-496)

### _verify_using_custom_ca_certs (L502-552)
Creates custom chain engine with user-provided CA certificates:
1. Creates in-memory root store (L512)
2. Adds custom CA certs to root store (L515-523)
3. Creates exclusive chain engine trusting only custom CAs (L527-536)
4. Delegates to `_get_and_verify_cert_chain` with custom engine (L539-547)

### _configure_context (L554-564)
Context manager that temporarily disables hostname checking and sets verify mode to CERT_NONE, allowing custom verification logic to handle validation.

## Dependencies
- Windows-only: Uses WinDLL, WinError, and wintypes from ctypes
- Imports `_set_ssl_context_verify_mode` from `._ssl_constants` (L32)
- Standard library: ssl, contextlib, typing

## Architecture Pattern
Two-tier verification strategy: First attempts validation against Windows system certificate stores, then falls back to custom CA certificates if system validation fails but custom CAs are configured. This allows leveraging both Windows trust infrastructure and application-specific certificate authorities.