# packages/adapter-rust/vendor/codelldb/linux-x64/lldb/lib/python3.12/site-packages/pip/_vendor/truststore/_macos.py
@source-hash: 549db86afcf96841
@generated: 2026-02-09T18:02:04Z

## Purpose and Responsibility

macOS-specific SSL certificate verification implementation using native macOS Security and CoreFoundation frameworks through ctypes bindings. Provides certificate chain validation against the macOS system trust store for the truststore library.

## Key Components

**Platform Compatibility (L21-26)**: Early version check requiring macOS 10.8+ with graceful failure for older versions.

**Dynamic Library Loading**: 
- `_load_cdll()` (L29-44): Robust CDLL loader with Big Sur+ path fallback mechanism
- `Security` and `CoreFoundation` framework loading (L46-52)

**Type Definitions (L54-82)**: Complete ctypes type mapping for CoreFoundation and Security framework primitives:
- CoreFoundation types: CFString, CFArray, CFData, CFError, etc.
- Security types: SecCertificateRef, SecTrustRef, SecPolicyRef, etc.

**Function Signature Bindings (L84-202)**: Comprehensive ctypes function signature definitions for both frameworks with proper argument/return types and error handling setup.

**Error Handling**:
- `_handle_osstatus()` (L204-254): OSStatus error code translator that converts Security framework errors to Python ssl.SSLError with descriptive messages
- `CFConst` (L263-272): Constants for common error codes and string encoding

**Utility Functions**:
- `_bytes_to_cf_data_ref()` (L274-277): Python bytes to CFDataRef converter
- `_bytes_to_cf_string()` (L280-292): Python bytes to CFString converter with UTF-8 encoding
- `_cf_string_ref_to_str()` (L294-314): CFStringRef to Python string converter with fallback buffer handling
- `_der_certs_to_cf_cert_array()` (L317-344): DER certificate list to CFArray converter with proper memory management

**SSL Context Management**:
- `_configure_context()` (L347-357): Context manager that temporarily disables SSL verification for custom validation

**Core Verification Logic**:
- `_verify_peercerts_impl()` (L360-499): Main certificate verification function implementing:
  - SSL policy creation with optional hostname verification
  - CRL checking support (VERIFY_CRL_CHECK_CHAIN)
  - Custom CA certificate loading from SSLContext
  - SecTrust evaluation with comprehensive error handling
  - SSLCertVerificationError construction with detailed error information

## Dependencies

- `ctypes`: Core FFI interface to macOS frameworks
- `ssl`: Python SSL module for context and error types
- `._ssl_constants`: Internal SSL verification mode utilities

## Architecture Patterns

- **Resource Management**: Extensive use of try/finally blocks for CFRelease calls preventing memory leaks
- **Error Translation**: Two-layer error handling (OSStatus + CFError) with fallback messaging
- **Type Safety**: Explicit ctypes type definitions with pointer relationships
- **Platform Adaptation**: Version-aware library loading for different macOS releases

## Critical Constraints

- Requires macOS 10.8+ (enforced at import)
- Memory management critical - all CF objects must be released
- SecTrust evaluation is boolean but uses complex error reporting
- CRL leaf checking not implemented (raises NotImplementedError)