# packages/adapter-rust/vendor/codelldb/linux-x64/lldb/lib/python3.12/site-packages/pip/_vendor/pyproject_hooks/_impl.py
@source-hash: eb5189c73422a742
@generated: 2026-02-09T18:01:42Z

## Purpose and Responsibility

This module implements the core subprocess-based communication mechanism for PEP 517/518 build backend hooks. It provides a clean API for invoking build backend operations in isolated Python subprocesses, ensuring proper environment isolation and error handling.

## Key Components

### Exception Classes (L23-48)
- **BackendUnavailable (L23-27)**: Raised when backend import fails in hook process
- **BackendInvalid (L29-35)**: Raised for invalid backend specifications  
- **HookMissing (L37-42)**: Raised when required hooks are not implemented
- **UnsupportedOperation (L44-48)**: Raised when backend explicitly rejects operations

### Utility Functions
- **write_json/read_json (L13-21)**: JSON serialization utilities for IPC
- **default_subprocess_runner (L50-60)**: Standard subprocess execution with environment merging
- **quiet_subprocess_runner (L62-72)**: Silent subprocess execution suppressing output
- **norm_and_check (L74-96)**: Path validation ensuring relative paths stay within source tree

### Main API Class

**BuildBackendHookCaller (L98-330)**: Primary interface for build backend communication
- **Constructor (L102-132)**: Initializes with source directory, backend spec, optional backend path, subprocess runner, and Python executable
- **subprocess_runner context manager (L133-150)**: Temporarily overrides subprocess runner

### Build Hook Methods
All methods follow consistent pattern of calling `_call_hook` with appropriate parameters:

- **_supported_features (L151-153)**: Query backend feature support
- **get_requires_for_build_wheel (L155-169)**: Get wheel build dependencies
- **prepare_metadata_for_build_wheel (L170-191)**: Prepare dist-info metadata
- **build_wheel (L192-214)**: Build wheel package
- **get_requires_for_build_editable (L215-229)**: Get editable wheel dependencies  
- **prepare_metadata_for_build_editable (L230-251)**: Prepare editable metadata
- **build_editable (L252-275)**: Build editable wheel
- **get_requires_for_build_sdist (L276-285)**: Get sdist build dependencies
- **build_sdist (L286-296)**: Build source distribution

### Core Implementation

**_call_hook (L297-330)**: Central method implementing subprocess communication protocol:
1. Sets up environment variables for backend specification
2. Creates temporary directory for JSON-based IPC
3. Executes hook script in subprocess with proper working directory
4. Parses response and handles error conditions
5. Maps error responses to appropriate exception types

## Dependencies and Integration

- Imports `_in_proc_script_path` from `._in_process` module for script execution
- Uses standard library: `json`, `os`, `sys`, `tempfile`, `subprocess`, `contextlib`
- Integrates with PEP 517 build backend protocol via environment variables

## Architectural Patterns

- **Subprocess Isolation**: All backend operations run in separate Python processes
- **JSON IPC**: Communication via temporary JSON files for data exchange
- **Environment Variable Configuration**: Backend specification passed via PEP517_* environment variables
- **Path Security**: Strict validation prevents path traversal attacks
- **Error Mapping**: Structured error handling with domain-specific exceptions
- **Fallback Support**: Some hooks support fallback mechanisms when not implemented

## Critical Invariants

- Backend paths must be relative and within source tree (enforced by norm_and_check)
- All directory paths are converted to absolute paths before subprocess invocation
- Temporary directories are automatically cleaned up via context managers
- Environment variables are isolated per subprocess call