# packages/adapter-rust/vendor/codelldb/linux-x64/lldb/lib/python3.12/site-packages/pip/_internal/utils/virtualenv.py
@source-hash: 4ba7fb72c628ad1a
@generated: 2026-02-09T18:01:24Z

## Primary Purpose
Virtual environment detection and configuration utility for pip. Determines if pip is running within a virtual environment and whether system site-packages are accessible, supporting both PEP 405 compliant venv and legacy pypa/virtualenv environments.

## Key Functions

### Virtual Environment Detection
- `running_under_virtualenv() -> bool` (L31-33): Main entry point that returns True if running in any virtual environment type
- `_running_under_venv() -> bool` (L14-19): Detects PEP 405 compliant virtual environments by comparing `sys.prefix` and `sys.base_prefix`
- `_running_under_legacy_virtualenv() -> bool` (L22-28): Detects legacy pypa/virtualenv environments by checking for `sys.real_prefix` attribute

### System Site-Packages Access Control
- `virtualenv_no_global() -> bool` (L94-104): Main entry point that determines if system site-packages are excluded from the virtual environment
- `_no_global_under_venv() -> bool` (L51-77): Checks PEP 405 environments by parsing `pyvenv.cfg` for `include-system-site-packages = false`
- `_no_global_under_legacy_virtualenv() -> bool` (L80-91): Checks legacy environments for presence of `no-global-site-packages.txt` file

### Configuration File Handling
- `_get_pyvenv_cfg_lines() -> Optional[List[str]]` (L36-48): Reads and parses `{sys.prefix}/pyvenv.cfg` file with UTF-8 encoding, returns None on failure

## Key Dependencies
- **sys module**: Core Python system interface for prefix checking and virtual environment detection
- **os/site modules**: File system operations and site-packages directory location
- **re module**: Regex pattern matching for parsing pyvenv.cfg configuration

## Important Constants
- `_INCLUDE_SYSTEM_SITE_PACKAGES_REGEX` (L9-11): Compiled regex pattern for parsing system site-packages inclusion setting

## Architectural Decisions
- **Detection Priority**: PEP 405 compliance checked before legacy virtualenv (L96-97) since newer virtualenv versions support both but only use PEP 405 config
- **Error Handling**: Graceful degradation with logging when pyvenv.cfg is inaccessible, defaulting to secure assumption (no global access)
- **UTF-8 Encoding**: Explicitly uses UTF-8 for pyvenv.cfg reading per PEP 405 compliance (L45)

## Critical Invariants
- Virtual environment detection is mutually exclusive between PEP 405 and legacy methods in practice
- System site-packages exclusion defaults to secure state (True) when configuration is ambiguous or inaccessible
- File system operations are wrapped with proper exception handling to prevent crashes