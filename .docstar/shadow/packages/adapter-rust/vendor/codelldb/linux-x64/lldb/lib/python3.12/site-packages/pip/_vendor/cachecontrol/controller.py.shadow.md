# packages/adapter-rust/vendor/codelldb/linux-x64/lldb/lib/python3.12/site-packages/pip/_vendor/cachecontrol/controller.py
@source-hash: a3e7a31899419a92
@generated: 2026-02-09T18:01:34Z

**Primary Purpose**: HTTP caching controller implementing RFC 7234 cache-control algorithms, ported from httplib2 for use with requests library. Manages cache storage, retrieval, validation, and freshness calculations.

**Core Architecture**:
- `CacheController` (L48-499): Main interface for HTTP caching decisions
- `parse_uri()` (L37-45): RFC 3986 URI parsing using regex
- URI regex pattern (L32): Captures scheme, authority, path, query, fragment components

**Key Dependencies**:
- `BaseCache`/`DictCache`/`SeparateBodyBaseCache`: Cache storage backends
- `Serializer`: Request/response serialization for cache storage
- `requests.PreparedRequest`/`urllib3.HTTPResponse`: HTTP objects
- `CaseInsensitiveDict`: Header management

**Configuration & State (L51-61)**:
- `cache`: Storage backend (defaults to DictCache)
- `cache_etags`: Enable ETag-based validation
- `serializer`: Object serialization handler
- `cacheable_status_codes`: HTTP status codes to cache (200, 203, 300, 301, 308)

**Core Methods**:

**URL Normalization**:
- `_urlnorm()` (L64-81): Normalizes URIs for consistent cache keys (lowercases scheme/authority, ensures absolute URIs)
- `cache_url()` (L84-85): Public interface to URL normalization

**Cache Control Parsing**:
- `parse_cache_control()` (L87-139): Parses Cache-Control headers into structured data
- Handles RFC 7234 directives: max-age, no-cache, no-store, must-revalidate, etc.
- Validates directive values and logs parsing errors

**Cache Retrieval & Validation**:
- `_load_from_cache()` (L141-165): Raw cache loading with Range header filtering
- `cached_request()` (L167-275): Main cache lookup with freshness validation
  - Checks no-cache directives (L177-184)
  - Handles permanent redirects (L191-206)
  - Calculates response age and freshness (L218-246)
  - Applies min-fresh adjustments (L257-261)
  - Purges stale entries without ETags (L269-272)

**Conditional Requests**:
- `conditional_headers()` (L277-290): Generates If-None-Match/If-Modified-Since headers for cache validation

**Cache Storage**:
- `_cache_set()` (L292-320): Handles both unified and separate-body cache storage
- `cache_response()` (L322-457): Main caching logic with comprehensive rules:
  - Status code filtering (L336-341)
  - Content-Length validation (L354-364)
  - no-store directive handling (L373-385)
  - Vary: * rejection (L387-394)
  - ETag-based caching (L396-408)
  - Permanent redirect caching (L410-414)
  - Expires/max-age based caching (L416-457)

**Cache Updates**:
- `update_cached_response()` (L459-499): Updates cached responses on 304 Not Modified
- Merges new headers while excluding problematic ones (content-length)
- Converts 304 responses to 200 with cached body

**Critical Constants**:
- `PERMANENT_REDIRECT_STATUSES` (L34): Status codes 301, 308 for permanent caching
- Default ETag cache duration: 14 days minimum (L404)

**Architectural Patterns**:
- Follows RFC 7234 HTTP caching specification
- Supports both in-memory and persistent cache backends
- Implements proper cache validation with conditional requests
- Handles edge cases like partial content, vary headers, malformed dates