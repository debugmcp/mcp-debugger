# packages/adapter-rust/vendor/codelldb/linux-x64/lldb/lib/python3.12/site-packages/pip/_internal/utils/unpacking.py
@source-hash: 7b20e44ac9389d6f
@generated: 2026-02-09T18:01:29Z

## Purpose
Archive extraction utilities for pip package installation, providing secure and cross-platform unpacking of ZIP and TAR archives with path traversal protection and permission handling.

## Core Functionality

### Archive Detection & Support
- **SUPPORTED_EXTENSIONS (L26)**: Dynamically built list of supported archive formats
- Conditional support for BZ2 (L28-33) and LZMA/XZ (L35-41) based on module availability
- Supports ZIP, TAR, TAR.GZ, TAR.BZ2, TAR.XZ formats

### Security Functions
- **is_within_directory (L78-86)**: Path traversal protection using absolute path comparison
- **has_leading_dir (L63-75)**: Detects if archive contents share common root directory
- **split_leading_dir (L51-60)**: Cross-platform path splitting for leading directory detection

### Permission Management
- **current_umask (L44-48)**: Gets system umask by temporarily setting it to 0
- **_get_default_mode_plus_executable (L89-90)**: Calculates default file mode with execute bits
- **set_extracted_file_to_default_mode_plus_executable (L93-98)**: Applies execute permissions
- **zip_item_is_executable (L101-105)**: Checks if ZIP entry has execute permissions

### Main Extraction Functions
- **unzip_file (L108-151)**: 
  - Extracts ZIP archives with optional flattening
  - Validates extraction paths against directory traversal
  - Preserves execute permissions for executable files
  - Uses streaming extraction to avoid memory issues

- **untar_file (L154-248)**:
  - Handles multiple TAR compression formats
  - Uses modern tarfile.data_filter (L187) when available for security
  - Falls back to manual validation for older Python versions
  - Special handling for Python versions with tarfile bugs (L211-224)

- **_untar_without_filter (L251-306)**: Legacy extraction for Python < 3.12 without data_filter

- **unpack_file (L309-337)**: Main entry point that dispatches to appropriate extractor based on file type/content-type

## Key Dependencies
- Standard library: `tarfile`, `zipfile`, `os`, `shutil`, `stat`
- Internal: `pip._internal.exceptions.InstallationError`, file type constants, `ensure_dir`

## Security Architecture
Implements defense-in-depth against archive-based attacks:
1. Path traversal validation in both ZIP and TAR extractors
2. Uses Python 3.12+ tarfile security filters when available
3. Fallback manual validation for older Python versions
4. Proper handling of symlinks and hardlinks

## Platform Considerations  
- Cross-platform path handling (forward/backslash normalization)
- Windows chmod no-op behavior documented and handled
- UTF-8 encoding specified for TAR files