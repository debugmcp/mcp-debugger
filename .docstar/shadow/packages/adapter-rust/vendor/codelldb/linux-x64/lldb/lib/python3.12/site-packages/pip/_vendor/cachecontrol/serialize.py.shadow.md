# packages/adapter-rust/vendor/codelldb/linux-x64/lldb/lib/python3.12/site-packages/pip/_vendor/cachecontrol/serialize.py
@source-hash: 1d0776225950d391
@generated: 2026-02-09T18:01:25Z

## Purpose
HTTP response serialization component for pip's cachecontrol library. Handles conversion between HTTPResponse objects and binary format for persistent caching, with support for HTTP Vary headers and backwards compatibility.

## Core Architecture
**Serializer class (L17-146)**: Single-responsibility serializer using msgpack format with version-aware deserialization.

### Key Methods
- **dumps() (L20-60)**: Serializes PreparedRequest/HTTPResponse pair to bytes with Vary header processing
- **loads() (L65-81)**: Deserializes bytes back to HTTPResponse with version checking
- **prepare_response() (L83-133)**: Validates cached response against current request using Vary headers
- **_loads_v4() (L135-146)**: Internal v4 format deserializer

## Dependencies
- **msgpack (L9)**: Binary serialization format
- **urllib3.HTTPResponse (L11)**: HTTP response objects
- **requests structures (L10)**: CaseInsensitiveDict for headers

## Key Features
### Vary Header Support (L49-58, L101-103)
Captures request headers specified in response Vary header for cache validation. Ensures cached responses only match requests with identical varied headers.

### Version Management (L18, L77-78)
Uses `serde_version = "4"` with format prefix "cc=4," for backwards compatibility. Rejects data from older versions.

### Body Handling
- **Inline bodies (L34-36)**: Reads response body and resets file pointer
- **Separate body files (L69, L117-120)**: Supports external body storage
- **Legacy encoding fix (L121-128)**: Handles Python 2/3 str/bytes compatibility

## Critical Invariants
1. Response body is always rewound after reading (L35-36)
2. Vary header "*" invalidates cache entry (L96-97)  
3. Transfer-encoding: chunked is stripped from cached responses (L110-111)
4. All header keys/values are stringified during serialization (L41, L44, L54, L57)

## Error Handling
- Returns None for empty data, version mismatches, or msgpack decode errors
- Gracefully handles missing Vary headers and body files
- Includes fallback for legacy pickle format encoding issues