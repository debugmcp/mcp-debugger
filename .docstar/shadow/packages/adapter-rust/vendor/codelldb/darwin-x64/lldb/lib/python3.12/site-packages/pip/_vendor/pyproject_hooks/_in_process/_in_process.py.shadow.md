# packages/adapter-rust/vendor/codelldb/darwin-x64/lldb/lib/python3.12/site-packages/pip/_vendor/pyproject_hooks/_in_process/_in_process.py
@source-hash: 9b66f7e1cf75ec85
@generated: 2026-02-09T17:57:49Z

## PEP 517 Build Backend In-Process Subprocess Handler

**Primary Purpose:** Subprocess script that loads and executes PEP 517 build backend hooks in isolation, communicating via JSON files and environment variables.

### Core Architecture

**Communication Protocol (L1-14):**
- Receives hook name and control directory via command line args
- Backend specified via `PEP517_BUILD_BACKEND` environment variable
- Optional backend path via `PEP517_BACKEND_PATH` environment variable  
- Input parameters read from `control_dir/input.json`
- Results written to `control_dir/output.json`

**JSON I/O Utilities (L30-38):**
- `write_json()` - UTF-8 JSON file writer
- `read_json()` - UTF-8 JSON file reader
- Duplicated from wrappers.py for zip-safety when run as script

### Exception Hierarchy

- `BackendUnavailable` (L40-44): Import failure with traceback
- `BackendInvalid` (L46-50): Backend validation failure  
- `HookMissing` (L52-57): Required hook not found
- `GotUnsupportedOperation` (L294-298): Backend raised UnsupportedOperation
- `_DummyException` (L290-292): Sentinel for backends without UnsupportedOperation

### Backend Loading System

**`_build_backend()` (L66-92):** Core backend loader
- Modifies sys.path with `PEP517_BACKEND_PATH` if provided
- Imports module from `PEP517_BUILD_BACKEND` entry point specification
- Validates backend loaded from expected path when backend-path specified
- Resolves object path (e.g., "module:object.attribute")

**Security:** `contained_in()` (L59-64) validates backend file location within allowed paths

### Hook Implementation Functions

**Requirements Hooks:**
- `get_requires_for_build_wheel()` (L107-119): Optional, returns [] if missing
- `get_requires_for_build_editable()` (L121-133): Optional, returns [] if missing  
- `get_requires_for_build_sdist()` (L276-288): Optional, returns [] if missing

**Metadata Preparation Hooks:**
- `prepare_metadata_for_build_wheel()` (L135-155): Fallback builds wheel if missing
- `prepare_metadata_for_build_editable()` (L157-182): Fallback builds editable wheel if missing

**Build Hooks:**
- `build_wheel()` (L239-253): Mandatory, optimizes by reusing prebuilt wheels
- `build_editable()` (L255-274): Optional, optimizes by reusing prebuilt wheels
- `build_sdist()` (L300-307): Mandatory, handles UnsupportedOperation

**Feature Detection:**
- `_supported_features()` (L94-105): Returns list of supported optional features

### Wheel Optimization System

**Prebuilt Wheel Detection (L217-237):** `_find_already_built_wheel()`
- Checks for `PEP517_ALREADY_BUILT_WHEEL` marker file
- Locates single .whl file in metadata parent directory
- Handles multiple wheel ambiguity with fallback to rebuild

**Metadata Extraction (L187-215):** `_get_wheel_metadata_from_wheel()`
- Extracts .dist-info from wheel ZIP using regex pattern (L191)
- Creates wheel marker file for optimization
- Returns dist-info directory name

**Constant:** `WHEEL_BUILT_MARKER = 'PEP517_ALREADY_BUILT_WHEEL'` (L184)

### Main Execution Flow

**`main()` (L322-350):**
- Validates hook name against `HOOK_NAMES` whitelist (L309-319)
- Loads hook function from globals
- Executes hook with JSON input parameters
- Comprehensive exception handling for all custom exception types
- Structured JSON output with error categorization

**Supported Hooks:** All standard PEP 517 hooks plus `_supported_features`

### Key Invariants

1. All hook functions are optional except `build_wheel` and `build_sdist`
2. Missing optional hooks return empty lists or trigger fallbacks
3. Backend path validation ensures security when `PEP517_BACKEND_PATH` specified  
4. Wheel building optimization prevents duplicate builds via marker files
5. All errors captured and serialized to JSON rather than propagating