# packages/adapter-rust/vendor/codelldb/darwin-x64/lldb/lib/python3.12/site-packages/pip/_vendor/urllib3/packages/backports/weakref_finalize.py
@source-hash: b5109a97938084d4
@generated: 2026-02-09T17:56:56Z

## Purpose
Backports Python 3's `weakref.finalize` functionality for Python 2 compatibility. Provides object finalization through weak references that execute cleanup functions when objects are garbage collected.

## Core Classes

### weakref_finalize (L17-155)
Main finalizer class that manages object cleanup callbacks. Uses weak references to avoid circular reference issues.

**Class Attributes:**
- `_registry` (L34): Dict mapping finalizer instances to `_Info` objects containing callback metadata
- `_shutdown` (L35): Boolean flag preventing finalizer execution during program shutdown
- `_index_iter` (L36): Counter for creation order tracking using `itertools.count()`
- `_dirty` (L37): Flag indicating registry changes requiring re-sorting
- `_registered_with_atexit` (L38): Prevents duplicate atexit registration

**Key Methods:**
- `__init__` (L43-59): Creates finalizer with callback function, registers with atexit on first use
- `__call__` (L61-66): Executes and removes finalizer callback, returns callback result or None
- `detach` (L68-74): Removes finalizer and returns (obj, func, args, kwargs) tuple if alive
- `peek` (L76-82): Returns finalizer info without removing it
- `alive` property (L84-87): Checks if finalizer is still registered
- `atexit` property (L89-99): Controls whether finalizer runs at program exit

### _Info (L40-41)
Internal data class storing finalizer metadata with slots for memory efficiency:
- `weakref`: Weak reference to target object
- `func`: Cleanup callback function  
- `args`/`kwargs`: Callback arguments
- `atexit`: Exit execution flag
- `index`: Creation order for deterministic shutdown sequence

## Key Behaviors

**Initialization Pattern (L44-50):**
- Lazy atexit registration using thread-safe flag check
- Creates weak reference to target object that triggers finalizer on GC

**Shutdown Handling (_exitfunc L122-155):**
- Disables garbage collection during cleanup to prevent new finalizers
- Processes finalizers in reverse creation order (oldest first)
- Handles exceptions without stopping cleanup process
- Sets global shutdown flag to prevent further execution

**Registry Management:**
- Uses finalizer instances as keys to avoid circular references (L29-31)
- Tracks "dirty" state for lazy re-sorting of exit finalizers (L136-138)

## Dependencies
- `weakref.ref` for weak reference creation
- `itertools.count()` for monotonic index generation  
- `atexit` module for program exit hooks
- `gc` module for garbage collection control during shutdown

## Architectural Decisions
- **No instance state**: Uses `__slots__ = ()` and registry lookup pattern to prevent circular references
- **Lazy atexit registration**: Registers exit handler only when first finalizer is created
- **Exception isolation**: Shutdown process continues despite individual finalizer failures
- **Deterministic ordering**: Maintains creation order for predictable cleanup sequence