# packages/adapter-rust/vendor/codelldb/darwin-x64/lldb/lib/python3.12/site-packages/pip/_vendor/truststore/_windows.py
@source-hash: 7a574d5621cd1de6
@generated: 2026-02-09T18:00:18Z

## Windows Certificate Verification Module

This module provides Windows-specific certificate verification using Windows Crypto API (WinCrypt) through ctypes bindings. Part of the truststore library for cross-platform certificate validation.

### Primary Purpose
- Implements certificate chain validation using native Windows certificate stores
- Provides fallback verification using custom CA certificates from SSL contexts
- Replaces Python's default certificate verification with Windows system trust anchors

### Key Data Structures
- **CERT_CONTEXT (L39-46)**: Core certificate context structure containing encoding type, certificate data, and store handle
- **CERT_CHAIN_CONTEXT (L127-137)**: Certificate chain context with trust status and chain elements
- **CERT_CHAIN_PARA (L70-81)**: Parameters for certificate chain building including usage matching and timeouts
- **CERT_CHAIN_POLICY_PARA (L153-158)**: Policy parameters for chain verification
- **SSL_EXTRA_CERT_CHAIN_POLICY_PARA (L144-150)**: SSL-specific policy parameters including server name validation

### Windows API Function Bindings (L244-319)
- **CertCreateCertificateChainEngine**: Creates custom certificate chain engines
- **CertOpenStore**: Opens certificate stores (memory-based for intermediates/custom CAs)
- **CertAddEncodedCertificateToStore**: Adds certificates to stores
- **CertGetCertificateChain**: Builds certificate chains
- **CertVerifyCertificateChainPolicy**: Validates chains against policies
- **FormatMessageW**: Retrieves Windows error messages

### Core Verification Functions
- **_verify_peercerts_impl (L322-411)**: Main entry point for certificate verification
  - First attempts verification using default Windows system trust roots
  - Falls back to custom CA verification if system verification fails and custom CAs exist
  - Handles intermediate certificate store creation and cleanup
  
- **_get_and_verify_cert_chain (L414-499)**: Performs actual chain building and policy verification
  - Configures SSL policy parameters including hostname checking
  - Handles SSL context verify_mode and check_hostname settings
  - Formats Windows error codes into readable SSL verification errors

- **_verify_using_custom_ca_certs (L502-551)**: Creates custom chain engine with provided CA certificates
  - Sets up exclusive root certificate store with custom CAs
  - Creates isolated chain engine that only trusts the custom certificates

### Configuration Management
- **_configure_context (L554-564)**: Context manager that temporarily disables Python's built-in certificate verification during Windows-native verification

### Constants and Flags
- Certificate encoding constants (L198-199): X509_ASN_ENCODING, PKCS_7_ASN_ENCODING
- Chain policy flags for different verification modes (L204-231)
- **CERT_CHAIN_POLICY_VERIFY_MODE_NONE_FLAGS (L221-231)**: Combined flags for bypassing all certificate validation checks

### Key Dependencies
- Windows crypt32.dll and kernel32.dll via ctypes WinDLL
- ssl module for SSLContext integration and exception types
- _ssl_constants module for SSL context configuration

### Error Handling Pattern
Uses **_handle_win_error (L237-241)** as errcheck callback to automatically convert Windows API failures into Python OSError exceptions via WinError().

### Architecture Notes
- Dual-path verification: system trust store first, custom CA fallback
- Memory-based certificate stores for intermediate and custom CA certificates
- Integration with Python's SSL context for configuration inheritance
- Comprehensive policy flag mapping for different verification strictness levels