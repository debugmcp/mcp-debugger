# packages/adapter-rust/vendor/codelldb/darwin-x64/lldb/lib/python3.12/site-packages/pip/_vendor/urllib3/contrib/pyopenssl.py
@source-hash: 843261e0c87263fa
@generated: 2026-02-09T17:57:49Z

## Purpose and Responsibility

PyOpenSSL adapter module that provides TLS with SNI support for urllib3, primarily for Python 2 compatibility. The module monkey-patches urllib3's SSL implementation with PyOpenSSL-backed SSL support, enabling enhanced certificate verification and SNI functionality. **Deprecated as of this version** - will be removed in urllib3 2.x (L82-88).

## Key Classes and Functions

### Core Injection/Extraction Functions
- `inject_into_urllib3()` (L130-141): Monkey-patches urllib3 to use PyOpenSSL by replacing `util.SSLContext` with `PyOpenSSLContext` and updating SNI/PyOpenSSL flags
- `extract_from_urllib3()` (L143-152): Reverses the monkey-patching, restoring original urllib3 SSL implementation
- `_validate_dependencies_met()` (L154-178): Validates required cryptography and PyOpenSSL versions are available

### Certificate Handling
- `get_subj_alt_name(peer_cert)` (L223-273): Extracts Subject Alternative Names from PyOpenSSL certificates using cryptography backend, handles DNS names and IP addresses
- `_dnsname_to_stdlib(name)` (L180-221): Converts cryptography dNSName fields to stdlib format with IDNA encoding/decoding

### Socket Wrapper
- `WrappedSocket` (L276-409): API-compatibility wrapper for PyOpenSSL Connection objects
  - Implements standard socket interface methods: `recv()`, `recv_into()`, `sendall()`, `close()`
  - Handles PyOpenSSL-specific exceptions and converts them to stdlib equivalents
  - Manages reference counting for PyPy garbage collection (`_makefile_refs`, `_reuse()`, `_drop()`)
  - `getpeercert()` (L384-396): Returns certificate information compatible with stdlib format

### SSL Context
- `PyOpenSSLContext` (L423-514): Wrapper for PyOpenSSL Context that mimics stdlib SSLContext interface
  - Maps urllib3 SSL protocols to PyOpenSSL equivalents via `_openssl_versions` (L96-109)
  - Properties: `options`, `verify_mode` with appropriate getters/setters
  - Methods: `set_ciphers()`, `load_verify_locations()`, `load_cert_chain()`, `set_alpn_protocols()`
  - `wrap_socket()` (L485-514): Creates SSL connections with proper hostname verification and handshake handling

## Key Dependencies
- PyOpenSSL (OpenSSL.crypto, OpenSSL.SSL)
- cryptography library with x509 support
- urllib3 util modules for monkey-patching targets

## Important Constants and Mappings
- `_openssl_versions` (L96-109): Protocol mapping from stdlib/urllib3 to PyOpenSSL
- `_stdlib_to_openssl_verify` (L112-117): Certificate verification mode mapping
- `SSL_WRITE_BLOCKSIZE = 16384` (L121): OpenSSL write chunk size limit

## Architecture Patterns
- Monkey-patching pattern for transparent SSL backend replacement
- Adapter pattern wrapping PyOpenSSL APIs to match stdlib interfaces
- Exception translation layer converting PyOpenSSL exceptions to stdlib equivalents
- Platform-specific code handling for Python 2/3 differences (makefile implementation)

## Critical Invariants
- Module must validate dependencies before injection to prevent runtime failures
- Certificate verification modes must be properly mapped between stdlib and PyOpenSSL
- Socket operations must handle PyOpenSSL's non-blocking behavior with proper timeout handling
- Reference counting must be maintained for PyPy compatibility