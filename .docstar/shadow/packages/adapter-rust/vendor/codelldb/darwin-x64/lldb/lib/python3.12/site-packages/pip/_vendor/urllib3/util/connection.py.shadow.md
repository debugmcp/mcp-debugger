# packages/adapter-rust/vendor/codelldb/darwin-x64/lldb/lib/python3.12/site-packages/pip/_vendor/urllib3/util/connection.py
@source-hash: e4bc760753d6dbd2
@generated: 2026-02-09T17:57:43Z

## Primary Purpose
Socket connection utilities for urllib3, providing enhanced connection creation with IPv6 support detection, socket option configuration, and connection drop detection.

## Key Functions

### `is_connection_dropped(conn)` (L11-30)
- **Purpose**: Detects if an HTTP connection has been dropped and should be closed
- **Parameters**: `conn` - HTTP connection object
- **Returns**: Boolean indicating if connection is dropped
- **Logic**: 
  - Returns False for AppEngine platform (no socket attribute)
  - Returns True if socket is None (already closed)
  - Uses `wait_for_read()` with 0 timeout to detect readable socket (indicating dropped connection)
  - Gracefully handles `NoWayToWaitForSocketError` on AppEngine

### `create_connection(address, timeout, source_address, socket_options)` (L37-97)
- **Purpose**: Enhanced socket connection creation with IPv6 support and custom options
- **Parameters**: 
  - `address`: (host, port) tuple
  - `timeout`: connection timeout (defaults to global socket timeout)
  - `source_address`: optional (host, port) for socket binding
  - `socket_options`: list of socket options to apply
- **Returns**: Connected socket object
- **Logic**:
  - Strips brackets from IPv6 addresses
  - Validates host with IDNA encoding
  - Uses `allowed_gai_family()` for IPv4/IPv6 selection
  - Iterates through `getaddrinfo()` results attempting connections
  - Applies socket options via `_set_socket_options()`
  - Handles connection failures gracefully

### `_set_socket_options(sock, options)` (L100-105)
- **Purpose**: Applies socket-level options to a socket
- **Parameters**: `sock` - socket object, `options` - list of option tuples
- **Logic**: Iterates through options calling `sock.setsockopt(*opt)`

### `allowed_gai_family()` (L108-116)
- **Purpose**: Determines address family for `getaddrinfo()` calls
- **Returns**: `socket.AF_INET` or `socket.AF_UNSPEC` based on IPv6 availability
- **Logic**: Returns `AF_UNSPEC` if `HAS_IPV6` is True, otherwise `AF_INET`

### `_has_ipv6(host)` (L119-146)
- **Purpose**: Tests system IPv6 support by attempting socket binding
- **Parameters**: `host` - IPv6 address to test (typically "::1")
- **Returns**: Boolean indicating IPv6 support
- **Logic**:
  - Returns False immediately on AppEngine (quota limitations)
  - Checks `socket.has_ipv6` (compile-time support)
  - Attempts to bind IPv6 socket to verify runtime support
  - Properly closes test socket

## Key Dependencies
- `socket` - Core socket operations
- `..contrib._appengine_environ` - AppEngine environment detection
- `..exceptions.LocationParseError` - URL parsing error handling
- `..packages.six` - Python 2/3 compatibility utilities
- `.wait.wait_for_read`, `.wait.NoWayToWaitForSocketError` - Non-blocking socket operations

## Global State
- `HAS_IPV6` (L149): Module-level constant determined by testing IPv6 binding on "::1"

## Platform Considerations
- Special handling for Google AppEngine environment (socket limitations, no IPv6)
- IPv6 support detection accounts for compile-time vs runtime availability
- Connection drop detection varies by platform capabilities