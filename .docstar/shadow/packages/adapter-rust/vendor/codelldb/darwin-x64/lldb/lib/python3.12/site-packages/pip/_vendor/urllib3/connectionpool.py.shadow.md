# packages/adapter-rust/vendor/codelldb/darwin-x64/lldb/lib/python3.12/site-packages/pip/_vendor/urllib3/connectionpool.py
@source-hash: 05eeaaeb9491f656
@generated: 2026-02-09T18:00:28Z

## Purpose and Responsibility

This module implements connection pooling for HTTP/HTTPS connections in urllib3. It provides thread-safe connection pools that manage connection reuse, retries, redirects, and proxy handling for efficient HTTP client operations.

## Key Classes

### ConnectionPool (L69-108)
Base abstract class for all connection pools. Provides:
- Host/port normalization and storage (L83-90)
- Context manager support (`__enter__`/`__exit__`) (L94-100)
- Abstract `close()` method (L102-106)

### HTTPConnectionPool (L113-911)
Primary HTTP connection pool implementation inheriting from `ConnectionPool` and `RequestMethods`. Key functionality:
- **Initialization** (L177-240): Sets up connection pool with maxsize, blocking behavior, timeouts, retries, proxy configuration
- **Connection Management**:
  - `_new_conn()` (L241-260): Creates fresh HTTP connections
  - `_get_conn()` (L262-299): Retrieves pooled or new connections with dropped connection detection
  - `_put_conn()` (L301-331): Returns connections to pool with overflow handling
- **Request Processing**:
  - `_make_request()` (L379-496): Low-level request execution with timeout and error handling
  - `urlopen()` (L534-910): High-level request method with comprehensive retry/redirect logic
- **Utility Methods**:
  - `is_same_host()` (L513-532): Host comparison for redirect validation
  - `_validate_conn()` (L332-336): Pre-request connection validation hook

### HTTPSConnectionPool (L913-1081)
HTTPS-specific pool extending `HTTPConnectionPool`:
- **SSL Configuration** (L930-978): Handles certificates, SSL versions, hostname verification
- **Connection Preparation**:
  - `_prepare_conn()` (L979-997): Configures SSL parameters for VerifiedHTTPSConnection
  - `_prepare_proxy()` (L999-1012): Establishes HTTP CONNECT tunnels for HTTPS proxies
- **Enhanced Validation** (L1050-1080): SSL certificate and proxy verification warnings

## Key Dependencies

- **Connection Classes**: `HTTPConnection`, `HTTPSConnection`, `VerifiedHTTPSConnection` from `.connection`
- **Utilities**: `Timeout`, `Retry`, `HTTPHeaderDict`, various URL and proxy utilities
- **Queue Implementation**: `LifoQueue` for connection pooling (L44, L81)
- **Exception Hierarchy**: Comprehensive exception types for error handling (L23-37)

## Important Patterns

### Connection Lifecycle
1. Connection acquisition via `_get_conn()` with pool timeout handling
2. Connection validation and proxy preparation
3. Request execution with comprehensive error handling
4. Connection return to pool or cleanup on errors

### Retry/Redirect Logic
- Integrated retry mechanism with exponential backoff (L799-802, L862, L892)
- Automatic redirect following with method transformation for 303 responses (L844-878)
- Connection cleanup and retry state management

### Error Handling Strategy
- Exception transformation for consistent error reporting (L765-797)
- Timeout detection across multiple error types (L354-377)
- SSL proxy misconfiguration detection (L765-791)

### Memory Management
- Weak reference cleanup for connection pools (L239)
- Connection pool draining utility `_close_pool_connections()` (L1129-1137)

## Critical Invariants

- Pool size enforcement via blocking/non-blocking behavior
- Connection reuse only for valid, non-dropped connections
- Proper SSL verification warnings for unverified HTTPS requests
- Host consistency validation for redirects (unless disabled)
- Request body position tracking for retries/redirects

## Utility Functions

- `connection_from_url()` (L1083-1108): Factory function for creating appropriate pool type from URL
- `_normalize_host()` (L1111-1126): IPv6 bracket handling for httplib compatibility
- Global constants: `_blocking_errnos` (L110) for timeout detection