# packages/adapter-rust/vendor/codelldb/darwin-x64/lldb/lib/python3.12/site-packages/pip/_vendor/truststore/_macos.py
@source-hash: 549db86afcf96841
@generated: 2026-02-09T18:00:19Z

## Purpose
macOS-specific certificate verification implementation for truststore package. Provides low-level bindings to macOS Security and CoreFoundation frameworks via ctypes to validate SSL certificates using the system's trust store.

## Core Components

### System Requirements & Loading (L21-52)
- Enforces minimum macOS 10.8 requirement (L23-26)
- `_load_cdll()` (L29-44): CDLL loader with fallback paths for macOS 10.16+ (Big Sur)
- Loads Security and CoreFoundation frameworks with hardcoded paths for newer macOS versions

### Type Definitions (L54-82)
Comprehensive ctypes type aliases for macOS framework interop:
- CoreFoundation types: CFString, CFArray, CFData, CFError, etc. (L54-76)
- Security framework types: SecCertificateRef, SecTrustRef, SecPolicyRef (L77-82)

### Framework Function Bindings (L84-202)
Extensive ctypes function signature definitions for:
- **Security framework** (L84-121): Certificate creation, trust evaluation, policy management
- **CoreFoundation framework** (L125-199): String/data/array manipulation, memory management

### Error Handling (L204-261)
- `_handle_osstatus()` (L204-254): Converts OSStatus errors to Python ssl.SSLError with detailed messages
- Attached as errcheck handlers to Security framework functions (L257-260)

### Constants (L263-272)
`CFConst` class defining:
- UTF-8 encoding constant
- Security framework error codes for certificate validation failures

### Utility Functions (L274-345)
- `_bytes_to_cf_data_ref()` (L274-277): Python bytes → CFDataRef conversion
- `_bytes_to_cf_string()` (L280-292): Python bytes → CFString conversion with UTF-8 encoding
- `_cf_string_ref_to_str()` (L294-314): CFStringRef → Python str conversion with fallback buffer handling
- `_der_certs_to_cf_cert_array()` (L317-344): DER certificate list → CFArray conversion for Security framework

### SSL Context Management (L347-358)
`_configure_context()`: Context manager temporarily disabling SSL verification to allow custom validation

### Main Verification Logic (L360-499)
`_verify_peercerts_impl()`: Core certificate verification function:
- Creates SSL policies with optional hostname verification (L370-380)
- Handles CRL checking policies (L382-398)
- Builds SecTrust objects from certificate chains (L400-416)
- Loads custom CA certificates from SSL context (L417-430)
- Performs trust evaluation using macOS Security framework (L434-447)
- Maps framework errors to Python SSL exceptions with detailed error reporting (L449-493)

## Key Dependencies
- `_ssl_constants` module for SSL context configuration (L19)
- Standard library: ctypes, ssl, platform, contextlib

## Architectural Patterns
- Heavy use of ctypes for system framework interop
- RAII pattern with try/finally blocks for CoreFoundation memory management
- Error code translation layer between macOS Security framework and Python SSL exceptions
- Fallback mechanisms for string conversion and library loading across macOS versions