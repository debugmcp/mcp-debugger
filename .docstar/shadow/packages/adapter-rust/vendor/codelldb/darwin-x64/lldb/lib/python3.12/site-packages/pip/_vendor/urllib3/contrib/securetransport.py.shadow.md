# packages/adapter-rust/vendor/codelldb/darwin-x64/lldb/lib/python3.12/site-packages/pip/_vendor/urllib3/contrib/securetransport.py
@source-hash: 15e7f5208514147a
@generated: 2026-02-09T17:57:56Z

## SecureTransport SSL/TLS Implementation for urllib3

This module provides macOS SecureTransport-based SSL/TLS support for urllib3 via ctypes bindings, enabling TLS connectivity without requiring OpenSSL compilation. It's a temporary workaround for macOS TLS compatibility issues until PEP 543 standardizes platform TLS integration.

### Core Architecture

**Monkey-patching Functions:**
- `inject_into_urllib3()` (L188-198): Replaces urllib3's SSL implementation with SecureTransport
- `extract_from_urllib3()` (L200-210): Restores original urllib3 SSL implementation

**Connection Management:**
- Global connection registry `_connection_refs` (L110): WeakValueDictionary mapping connection IDs to WrappedSocket instances
- Thread-safe access via `_connection_ref_lock` (L111)
- Connection ID computation using `id(self) % 2147483647` with collision handling (L503-506)

### Key Classes

**WrappedSocket (L325-764):**
- Main SSL socket wrapper providing OpenSSL-compatible API
- Key methods:
  - `__init__()` (L333-349): Initializes socket state and stores original timeout
  - `handshake()` (L473-564): Performs TLS handshake with comprehensive parameter handling
  - `recv()`/`recv_into()` (L576-623): Data reading with timeout and error handling
  - `send()`/`sendall()` (L631-653): Data transmission with chunking support
  - `close()` (L658-675): Resource cleanup including keychain deletion
  - `getpeercert()` (L677-733): Certificate retrieval (binary format only)
  - `version()` (L735-754): TLS version detection with protocol mapping

**SecureTransportContext (L784-920):**
- SSL context wrapper mimicking standard library SSLContext interface
- Properties: `check_hostname` (always True, L802-815), `options` (L818-830), `verify_mode` (L833-838)
- Key methods:
  - `set_ciphers()` (L855-858): Validates cipher string against defaults
  - `load_verify_locations()` (L860-870): Configures trust bundle
  - `load_cert_chain()` (L872-875): Sets client certificate chain
  - `set_alpn_protocols()` (L877-887): ALPN protocol configuration (macOS 10.12+ only)
  - `wrap_socket()` (L889-920): Creates WrappedSocket and initiates handshake

### Callback Infrastructure

**I/O Callbacks:**
- `_read_callback()` (L212-264): SecureTransport read callback with timeout handling and error translation
- `_write_callback()` (L267-315): SecureTransport write callback with chunked transmission
- Global callback pointers maintained to prevent GC (L321-322)

### Configuration & Constants

**Cipher Suite Configuration:**
- `CIPHER_SUITES` (L120-151): Comprehensive list of supported TLS cipher suites
- `SSL_WRITE_BLOCKSIZE` (L115): 16KB write limit matching OpenSSL

**Protocol Version Mapping:**
- `_protocol_to_min_max` (L156-185): Maps Python SSL protocols to SecureTransport constants
- Dynamic protocol support detection via `hasattr()` checks

### Dependencies

**External Modules:**
- `._securetransport.bindings`: CoreFoundation, Security, SecurityConst APIs
- `._securetransport.low_level`: Certificate handling and utility functions
- `..util.ssl_`: urllib3 SSL utilities and constants

**Platform Compatibility:**
- Python 2/3 compatibility via `_fileobject` detection (L80-84)
- Alternative `makefile` implementations for different Python versions (L766-781)

### Critical Constraints

- **macOS Only**: Designed specifically for macOS SecureTransport framework
- **Client-side Only**: Server-side SSL not supported (assertion at L900)
- **Binary Certificates**: Only supports binary certificate format (L698)
- **No Custom Ciphers**: Requires default cipher string (L857-858)
- **No Certificate Directories**: Only supports certificate files or data (L862-863)
- **Threading Considerations**: Connection registry requires locking for modifications but not reads