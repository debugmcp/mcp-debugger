# packages/adapter-rust/vendor/codelldb/darwin-x64/lldb/lib/python3.12/site-packages/pip/_vendor/cachecontrol/serialize.py
@source-hash: 1d0776225950d391
@generated: 2026-02-09T17:59:39Z

HTTP response serialization/deserialization for CacheControl's persistent caching mechanism.

## Primary Purpose
Serializes and deserializes HTTP responses to/from binary format for cache storage, using MessagePack for efficient binary serialization. Handles response metadata, headers, body content, and HTTP vary header validation for cache hit determination.

## Key Classes and Functions

**Serializer (L17-146)**: Main serialization class with version 4 format support
- `serde_version = "4"` (L18): Current serialization format version identifier
- `dumps(request, response, body=None)` (L20-60): Serializes HTTPResponse to bytes with metadata
  - Extracts response body if not provided (L30-36)
  - Builds serialization dictionary with response metadata (L38-47) 
  - Processes Vary headers for cache validation (L49-58)
  - Returns version-prefixed MessagePack data (L60)
- `serialize(data)` (L62-63): MessagePack serialization wrapper with binary type support
- `loads(request, data, body_file=None)` (L65-81): Deserializes cached response data
  - Version validation and format checking (L77-78)
  - Delegates to v4-specific loader (L80-81)
- `prepare_response(request, cached, body_file=None)` (L83-133): Reconstructs HTTPResponse from cached data
  - Vary header validation against current request (L96-103)
  - Handles chunked transfer-encoding cleanup (L110-111)
  - Body reconstruction with fallback for legacy pickle formats (L115-128)
  - Returns fully constructed HTTPResponse (L133)
- `_loads_v4(request, data, body_file=None)` (L135-146): MessagePack deserialization for v4 format

## Key Dependencies
- `msgpack`: Binary serialization format for efficient storage
- `urllib3.HTTPResponse`: HTTP response object reconstruction
- `requests.structures.CaseInsensitiveDict`: HTTP header handling
- `requests.PreparedRequest`: Request object for vary header validation

## Critical Architecture Patterns
- **Version-prefixed serialization**: Format identifier prevents incompatible deserialization
- **Vary header validation**: Ensures cached responses match request characteristics
- **Lazy body handling**: Supports separate body storage via body_file parameter
- **Backward compatibility**: Handles legacy format edge cases and parameter cleanup

## Important Invariants
- Serialized data always prefixed with format version (cc=4,)
- Vary header "*" value invalidates cache entries
- Response body streams are reset after reading during serialization
- Transfer-encoding chunked headers are stripped during reconstruction