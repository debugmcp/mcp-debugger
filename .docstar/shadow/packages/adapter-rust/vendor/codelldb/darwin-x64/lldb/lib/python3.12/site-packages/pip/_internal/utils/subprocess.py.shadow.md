# packages/adapter-rust/vendor/codelldb/darwin-x64/lldb/lib/python3.12/site-packages/pip/_internal/utils/subprocess.py
@source-hash: 12cbea4918923071
@generated: 2026-02-09T17:59:47Z

## Purpose
Subprocess execution utilities for pip with enhanced logging, spinner integration, and sensitive data handling. Provides secure command execution with redaction capabilities for secrets and comprehensive error handling.

## Key Types & Utilities
- **CommandArgs (L14)**: Type alias for `List[Union[str, HiddenText]]` - command argument list supporting both plain strings and redacted secrets
- **make_command (L17-31)**: Flattens mixed arguments (strings, HiddenText, lists) into unified CommandArgs structure
- **format_command_args (L34-46)**: Shell-safe string formatting with automatic redaction of HiddenText objects using shlex.quote
- **reveal_command_args (L49-53)**: Extracts raw unredacted arguments for actual subprocess execution

## Core Subprocess Execution
**call_subprocess (L56-221)**: Primary subprocess execution function with extensive configuration:
- **Logging Control**: `show_stdout` toggles INFO vs VERBOSE logging levels (L102-110)
- **Return Code Handling**: `on_returncode` supports "raise"/"warn"/"ignore" strategies (L190-220)
- **Environment Management**: Supports both `extra_environ` additions and `unset_environ` removals (L120-124)
- **Output Modes**: `stdout_only=False` combines stderr+stdout, `stdout_only=True` separates them (L145-180)
- **Spinner Integration**: Automatic spinner management when subprocess output not visible (L115-117, L183-188)
- **Security**: Uses `reveal_command_args()` to convert HiddenText to strings for Popen (L128)

## Error Handling & Logging
- **Process Error Detection (L182)**: Checks return codes against `extra_ok_returncodes`
- **Rich Error Reporting (L191-209)**: Creates `InstallationSubprocessError` with command details, working directory, and output
- **Conditional Logging (L196-207)**: Logs full command and cwd with rich markup when failures occur
- **Output Buffering (L144, L176, L194)**: Captures all output for error reporting when subprocess not visible

## Factory Function
**runner_with_spinner_message (L224-244)**: Creates a subprocess runner compatible with BuildBackendHookCaller API, wrapping `call_subprocess` with spinner and consistent interface.

## Dependencies
- **Rich markup integration**: Uses `pip._vendor.rich.markup.escape` for safe log formatting
- **Spinner system**: Integrates with `pip._internal.cli.spinners` for progress indication
- **Logging infrastructure**: Leverages `subprocess_logger` and VERBOSE level from pip's logging utils
- **HiddenText**: Supports secure handling of sensitive command arguments

## Architectural Patterns
- **Logging Level Strategy**: Dynamically determines visibility and logging behavior based on effective log levels
- **Security by Design**: Consistent redaction throughout display/logging while preserving raw values for execution
- **Flexible Error Handling**: Multiple strategies for non-zero exit codes with detailed error context
- **Output Mode Abstraction**: Handles both combined and separated stdout/stderr with unified interface