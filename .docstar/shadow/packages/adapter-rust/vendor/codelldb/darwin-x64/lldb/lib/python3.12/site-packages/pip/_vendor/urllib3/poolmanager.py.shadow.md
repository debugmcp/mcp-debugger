# packages/adapter-rust/vendor/codelldb/darwin-x64/lldb/lib/python3.12/site-packages/pip/_vendor/urllib3/poolmanager.py
@source-hash: 696ca15d1b4d3b82
@generated: 2026-02-09T18:00:23Z

## Primary Purpose

HTTP/HTTPS connection pool management system with proxy support. Provides centralized pooling of reusable connections, intelligent connection reuse based on pool keys, and transparent proxy handling for urllib3.

## Key Classes & Functions

### PoolManager (L140-422)
Core connection pool manager inheriting from RequestMethods. Maintains a cache of connection pools indexed by PoolKey tuples, automatically creating new pools as needed.

**Key Methods:**
- `__init__(num_pools=10, headers=None, **connection_pool_kw)` (L171): Initializes with RecentlyUsedContainer for pool caching
- `connection_from_host(host, port=None, scheme="http", pool_kwargs=None)` (L225): Primary connection retrieval by host/port/scheme
- `connection_from_context(request_context)` (L248): Gets connection from normalized request context dict
- `connection_from_pool_key(pool_key, request_context=None)` (L263): Thread-safe pool retrieval/creation using pools.lock
- `urlopen(method, url, redirect=True, **kw)` (L353): Main HTTP request method with redirect handling
- `_new_pool(scheme, host, port, request_context=None)` (L189): Creates new connection pools, strips SSL keywords for HTTP
- `clear()` (L216): Empties all pools and closes connections

### ProxyManager (L424-537)
Extends PoolManager for proxy-aware requests. Routes all traffic through configured proxy with CONNECT tunneling for HTTPS.

**Key Methods:**
- `__init__(proxy_url, num_pools=10, ...)` (L464): Parses proxy URL, validates scheme, sets proxy configuration
- `connection_from_host(host, port=None, scheme="http", pool_kwargs=None)` (L501): Overrides to route HTTP through proxy host, HTTPS through target host
- `_set_proxy_headers(url, headers=None)` (L511): Adds Accept and Host headers for proxy requests
- `urlopen(method, url, redirect=True, **kw)` (L526): Adds proxy headers when not using HTTP tunneling

### Key Functions

**_default_key_normalizer(key_class, request_context)** (L79-125): Normalizes request context into immutable PoolKey. Lowercases scheme/host, converts dicts to frozensets, handles socket options, prefixes keys with "key_".

**proxy_from_url(url, **kw)** (L539): Factory function returning ProxyManager instance.

## Important Data Structures

**PoolKey** (L73): namedtuple with 27 fields covering all connection parameters (SSL, timeouts, headers, proxy config, etc.)

**ProxyConfig** (L76): namedtuple storing ssl_context and use_forwarding_for_https flag

**SSL_KEYWORDS** (L28-38): Tuple of SSL-related parameter names stripped from HTTP pools

**key_fn_by_scheme** (L132-135): Maps schemes to key normalization functions

**pool_classes_by_scheme** (L137): Maps schemes to connection pool classes

## Dependencies & Relationships

- Inherits from RequestMethods for HTTP method support
- Uses RecentlyUsedContainer for LRU pool caching
- Creates HTTPConnectionPool/HTTPSConnectionPool instances
- Integrates with Retry logic for redirect handling
- Uses parse_url for URL parsing and validation
- Relies on connection_requires_http_tunnel for proxy tunnel decisions

## Architectural Patterns

**Pool Key Strategy**: Uses immutable namedtuples as cache keys, ensuring consistent pool reuse across requests with identical connection parameters.

**Context-Based Design**: Request context dicts flow through the system, getting normalized into pool keys and passed to pool constructors.

**Scheme-Based Dispatch**: Uses dictionaries to map URL schemes to appropriate handlers (key functions, pool classes).

**Proxy Transparency**: ProxyManager overrides specific methods while delegating most functionality to parent PoolManager.

## Critical Invariants

- Pool keys must be immutable (frozensets for dicts, tuples for lists)
- Thread safety maintained via pools.lock during pool retrieval/creation
- SSL keywords automatically stripped from HTTP pools to prevent errors
- Proxy scheme validation (only http/https supported)
- Host normalization (lowercase) for consistent pool key generation