# packages/adapter-rust/vendor/codelldb/darwin-x64/lldb/lib/python3.12/site-packages/pip/_internal/utils/unpacking.py
@source-hash: 7b20e44ac9389d6f
@generated: 2026-02-09T17:59:41Z

**Purpose**: Archive extraction utilities for pip package installation, handling ZIP and TAR archives with security protections against path traversal attacks.

**Key Components**:

- `SUPPORTED_EXTENSIONS` (L26): Dynamic list of supported archive formats, conditionally includes BZ2/XZ based on Python module availability
- `current_umask()` (L44-48): Gets current file creation mask by temporarily setting it
- `split_leading_dir()` (L51-60): Cross-platform path splitting that handles both forward and backslashes
- `has_leading_dir()` (L63-75): Checks if all archive paths share common root directory
- `is_within_directory()` (L78-86): Security function preventing path traversal attacks using `os.path.commonprefix`

**Archive Extraction Functions**:

- `unzip_file()` (L108-151): ZIP extraction with optional flattening, preserves executable permissions, includes path traversal protection
- `untar_file()` (L154-248): TAR extraction with compression auto-detection (gz/bz2/xz), uses modern `tarfile.data_filter` when available
- `_untar_without_filter()` (L251-306): Fallback TAR extraction for older Python versions without built-in security filters
- `unpack_file()` (L309-337): Main entry point that auto-detects archive type and delegates to appropriate extractor

**Security Features**:
- Path traversal protection in both ZIP and TAR extractors
- Uses `tarfile.data_filter` (PEP 706) when available for TAR security
- Special handling for Python versions with known `LinkOutsideDestinationError` bug (L211-224)
- Graceful handling of corrupt archive members with logging

**Permission Handling**:
- `zip_item_is_executable()` (L101-105): Detects executable files in ZIP archives
- `set_extracted_file_to_default_mode_plus_executable()` (L93-98): Applies execute permissions while respecting umask
- Preserves executable bits from original archives while using system defaults for other permissions

**Dependencies**: 
- Internal pip modules for exceptions and file type constants
- Standard library: `tarfile`, `zipfile`, `shutil`, `os`, `stat`
- Optional: `bz2`, `lzma` for additional compression formats

**Architecture Notes**:
- Conditional feature detection for compression formats
- Dual-path implementation for TAR extraction (filtered/unfiltered)
- Flatten option specifically disabled for wheel files (.whl)
- Cross-platform compatibility with Windows permission limitations