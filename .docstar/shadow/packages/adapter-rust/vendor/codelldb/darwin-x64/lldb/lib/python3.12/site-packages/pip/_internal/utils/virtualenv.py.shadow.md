# packages/adapter-rust/vendor/codelldb/darwin-x64/lldb/lib/python3.12/site-packages/pip/_internal/utils/virtualenv.py
@source-hash: 4ba7fb72c628ad1a
@generated: 2026-02-09T17:59:36Z

## Primary Purpose
Virtual environment detection and configuration utility for pip's internal operations. Provides cross-compatible detection for both PEP 405 compliant venv and legacy pypa/virtualenv environments, with system site-packages access determination.

## Key Functions

### Virtual Environment Detection
- `_running_under_venv()` (L14-19): Detects PEP 405 compliant virtual environments by comparing `sys.prefix` vs `sys.base_prefix`
- `_running_under_legacy_virtualenv()` (L22-28): Detects legacy pypa/virtualenv by checking for `sys.real_prefix` attribute
- `running_under_virtualenv()` (L31-33): Primary entry point combining both detection methods with OR logic

### System Site-Packages Access Detection
- `virtualenv_no_global()` (L94-104): Main interface determining if venv blocks system site-packages access
- `_no_global_under_venv()` (L51-77): Parses `pyvenv.cfg` for `include-system-site-packages = false` using regex pattern
- `_no_global_under_legacy_virtualenv()` (L80-91): Checks for `no-global-site-packages.txt` file in site module directory

### Configuration File Handling  
- `_get_pyvenv_cfg_lines()` (L36-48): Safely reads UTF-8 encoded `{sys.prefix}/pyvenv.cfg`, returns None on failure
- `_INCLUDE_SYSTEM_SITE_PACKAGES_REGEX` (L9-11): Compiled regex matching the include-system-site-packages config line

## Dependencies
- **Standard Library**: `logging`, `os`, `re`, `site`, `sys`
- **External**: None - pure stdlib implementation

## Architectural Patterns
- **Defensive Programming**: Graceful handling of missing config files with fallback assumptions
- **Detection Priority**: PEP 405 checked before legacy virtualenv (L96-98) due to virtualenv >=20 compatibility
- **Fail-Safe Defaults**: Assumes no system site-packages access when config is inaccessible (L64-71)

## Critical Invariants
- PEP 405 detection must precede legacy detection to handle virtualenv >=20 correctly
- UTF-8 encoding assumption for pyvenv.cfg files based on built-in venv module behavior
- Missing pyvenv.cfg in active venv triggers warning but defaults to restricted access