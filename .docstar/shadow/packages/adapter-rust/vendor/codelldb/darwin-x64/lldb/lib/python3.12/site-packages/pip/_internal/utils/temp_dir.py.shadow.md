# packages/adapter-rust/vendor/codelldb/darwin-x64/lldb/lib/python3.12/site-packages/pip/_internal/utils/temp_dir.py
@source-hash: 0d4030db6b85aee4
@generated: 2026-02-09T17:59:45Z

## Primary Purpose
Provides temporary directory management utilities for pip, including lifecycle control, cleanup handling, and specialized adjacent directory creation. Core infrastructure for managing build and cache directories during pip operations.

## Key Components

### Global State Management
- `_tempdir_manager` (L36): Global ExitStack for coordinated temp directory cleanup
- `global_tempdir_manager()` (L40-47): Context manager providing scoped global temp directory lifecycle management
- `_tempdir_registry` (L69): Global registry controlling deletion behavior per temp directory type
- `tempdir_registry()` (L73-83): Context manager providing scoped temp directory type registry

### Temp Directory Classification
- `tempdir_kinds` (L29-33): Enum defining globally-managed temp directory types:
  - `BUILD_ENV`: Environment setup directories
  - `EPHEM_WHEEL_CACHE`: Ephemeral wheel cache storage  
  - `REQ_BUILD`: Requirement build directories

### TempDirectoryTypeRegistry (L50-67)
Registry controlling auto-deletion behavior by temp directory kind.
- `set_delete()` (L56-60): Configure deletion policy for specific kinds
- `get_delete()` (L62-66): Retrieve deletion policy (defaults to True)

### TempDirectory (L93-224)
Main temporary directory abstraction with context manager support.

**Constructor** (L114-147):
- `path`: Optional explicit directory path
- `delete`: Deletion policy (bool, None, or _default sentinel)
- `kind`: Directory type classification
- `globally_managed`: Whether to register with global manager
- `ignore_cleanup_errors`: Whether to suppress cleanup exceptions

**Key Methods:**
- `path` property (L149-152): Protected path access with deletion check
- `_create()` (L171-179): Creates temp directory with realpath canonicalization
- `cleanup()` (L181-224): Robust cleanup with error handling and logging
  - Two-phase cleanup: first strict attempt, then error-tolerant pass
  - Comprehensive error logging via `onerror` callback (L189-207)

**Context Manager Protocol** (L157-169):
- Deletion decision hierarchy: explicit delete → registry policy → default True
- Automatic cleanup on context exit

### AdjacentTempDirectory (L226-296)
Specialized temp directory created adjacent to existing directories, useful for atomic operations.

**Key Features:**
- `LEADING_CHARS` (L246): Character set for generating valid adjacent names
- `_generate_names()` (L252-276): Algorithm generating filesystem-safe but package-invalid names
- `_create()` (L278-296): Creates directory adjacent to original with fallback to standard temp creation

## Architecture Patterns

### Layered Cleanup Strategy
1. Global manager coordinates multiple temp directories
2. Registry provides per-type deletion policies  
3. Individual directories handle robust cleanup with error tolerance

### Error Resilience
- Realpath canonicalization handles symlinked temp directories
- Two-phase cleanup: strict then permissive
- Comprehensive error logging without failing operations
- Graceful handling of missing directories and permission issues

## Critical Invariants
- Path access forbidden after deletion (`_deleted` flag enforcement)
- Global manager must exist when `globally_managed=True`
- Adjacent directories use package-invalid names to avoid conflicts
- Cleanup always sets `_deleted=True` regardless of success

## Dependencies
- `pip._internal.utils.misc.rmtree`: Robust directory removal with retry logic
- Standard `tempfile.mkdtemp`: Fallback temp directory creation
- `contextlib.ExitStack`: Coordinated resource management