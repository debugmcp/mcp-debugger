# packages/adapter-rust/vendor/codelldb/darwin-x64/lldb/lib/python3.12/site-packages/pip/_vendor/msgpack/fallback.py
@source-hash: c1d516264597da0c
@generated: 2026-02-09T17:59:53Z

Pure Python MessagePack implementation providing streaming serialization/deserialization capabilities.

## Primary Components

**unpackb() (L77-99)**: Convenience function for unpacking single msgpack objects from bytes. Creates temporary Unpacker, feeds data, and returns unpacked object with error handling for incomplete/extra data.

**Unpacker class (L135-605)**: Streaming deserializer supporting both file-like objects and manual feeding. Core unpacking logic in `_unpack()` (L491-563) uses recursive descent parsing with configurable limits and hooks.

Key methods:
- `feed()` (L322-335): Add bytes to internal buffer for streaming
- `_read_header()` (L395-489): Parse msgpack type headers using `_MSGPACK_HEADERS` lookup table
- `__next__()` (L568-578): Iterator support for streaming unpacking
- `read_array_header()`/`read_map_header()` (L593-601): Low-level header reading

**Packer class (L607-951)**: Serializes Python objects to msgpack format. Main logic in `_pack()` (L698-820) with type-specific encoding handlers.

Key methods:
- `pack()` (L822-831): Serialize single object with autoreset
- `_pack_array_header()`/`_pack_map_header()` (L887-903): Container header encoding
- `pack_ext_type()` (L858-885): Extension type serialization

## Architecture Patterns

**Platform Optimization (L7-41)**: PyPy-specific StringBuilder optimization using custom StringIO wrapper when available, falls back to BytesIO for other platforms.

**Header Lookup Table (L103-132)**: `_MSGPACK_HEADERS` dictionary maps msgpack type bytes to (size, struct_format, type) tuples for efficient parsing.

**Type Constants (L48-60)**: Execution modes (`EX_*`) and msgpack types (`TYPE_*`) for state machine control.

**Buffer Management**: Checkpoint-based buffering in Unpacker for streaming with rollback capability on incomplete data.

## Dependencies

- `struct` for binary data packing/unpacking
- `.exceptions` for msgpack-specific errors (BufferFull, OutOfData, etc.)
- `.ext` for ExtType and Timestamp support
- `datetime` for timestamp conversion

## Critical Invariants

- Buffer size limits enforced via `max_buffer_size` and related parameters
- Recursion depth tracking via `nest_limit` (default 511) prevents stack overflow
- Type validation in strict mode vs permissive mode controlled by `strict_types`
- UTF-8 encoding/decoding for string types with configurable error handling