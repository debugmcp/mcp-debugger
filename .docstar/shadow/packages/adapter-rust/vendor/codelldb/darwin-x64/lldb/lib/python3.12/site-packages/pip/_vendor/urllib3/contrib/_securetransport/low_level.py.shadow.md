# packages/adapter-rust/vendor/codelldb/darwin-x64/lldb/lib/python3.12/site-packages/pip/_vendor/urllib3/contrib/_securetransport/low_level.py
@source-hash: 076241076fcd44fd
@generated: 2026-02-09T17:56:59Z

## Purpose
Low-level helper module for SecureTransport bindings on macOS, providing memory-safe CoreFoundation and Security framework operations for SSL/TLS functionality. Handles certificate parsing, keychain management, and data type conversions between Python and macOS native types.

## Key Dependencies
- `.bindings`: CFConst, CoreFoundation, Security - macOS framework bindings (L19)
- Standard library: base64, ctypes, ssl, struct, tempfile for data handling and error reporting

## Core Functions

### Memory Management Utilities
- `_cf_data_from_bytes(bytestring)` (L27-34): Creates CFData from Python bytes, caller must CFRelease
- `_cf_dictionary_from_tuples(tuples)` (L37-56): Converts Python tuples to CFDictionary
- `_cfstr(py_bstr)` (L59-70): Creates CFString from Python binary data, caller must CFRelease
- `_create_cfstring_array(lst)` (L73-101): Creates CFMutableArray of CFStrings with automatic cleanup on failure

### String Conversion
- `_cf_string_to_unicode(value)` (L104-126): Extracts Unicode string from CFString, handles buffer allocation for error reporting

### Error Handling
- `_assert_no_error(error, exception_class=None)` (L129-147): Converts OSStatus codes to Python exceptions using Security framework error messages, defaults to ssl.SSLError

### Certificate Processing
- `_cert_array_from_pem(pem_bundle)` (L150-193): Parses PEM certificate bundle into CFArray of SecCertificateRef objects
  - Uses regex `_PEM_CERTS_RE` (L22-24) to extract base64 cert data
  - Converts to DER format and creates Security framework certificate objects
- `_is_cert(item)` (L196-201): Type checker for SecCertificateRef
- `_is_identity(item)` (L204-209): Type checker for SecIdentityRef

### Keychain Management
- `_temporary_keychain()` (L212-244): Creates temporary keychain with random password for credential storage
  - Returns tuple of (SecKeychainRef, temp_directory_path)
  - Uses 40 random bytes: 8 for filename, 32 for password
- `_load_items_from_file(keychain, path)` (L247-299): Imports certificates/identities from file into keychain
  - Returns tuple of (identities_list, certificates_list)
  - Uses SecItemImport for file processing
- `_load_client_cert_chain(keychain, *paths)` (L302-374): Builds client certificate trust chain
  - Strategy: Load all files, create SecIdentityRef from first cert if none exists
  - Returns CFArray with SecIdentityRef followed by SecCertificateRef objects

### Protocol Support
- `TLS_PROTOCOL_VERSIONS` (L377-383): Maps protocol names to version tuples
- `_build_tls_unknown_ca_alert(version)` (L386-396): Constructs TLS alert record for unknown CA errors

## Architecture Patterns
- Consistent memory management: All CF* creation functions require caller to CFRelease
- Exception safety: try/finally blocks ensure CFRelease on error paths
- Type safety: Explicit type checking for CoreFoundation objects
- Resource cleanup: Automatic cleanup of intermediate objects in complex operations

## Critical Invariants
- All CoreFoundation objects must be explicitly released to prevent memory leaks
- Temporary keychains must be deleted by caller (SecKeychainDelete)
- Certificate arrays maintain reference counts properly during trust chain building
- PEM parsing assumes standard certificate delimiters and base64 encoding