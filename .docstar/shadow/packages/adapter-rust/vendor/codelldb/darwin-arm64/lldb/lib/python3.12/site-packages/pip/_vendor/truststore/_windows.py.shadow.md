# packages/adapter-rust/vendor/codelldb/darwin-arm64/lldb/lib/python3.12/site-packages/pip/_vendor/truststore/_windows.py
@source-hash: 7a574d5621cd1de6
@generated: 2026-02-09T17:59:26Z

## Purpose
Windows-specific certificate verification implementation using Windows CryptoAPI. Provides certificate chain validation functionality to verify SSL/TLS peer certificates against Windows system trust stores and custom CA certificates loaded via SSLContext.

## Core Data Structures

**Windows API C Structure Bindings (L39-196)**
- `CERT_CONTEXT` (L39-46): Certificate context containing encoding type, certificate data pointer, size, and store handle
- `CERT_CHAIN_CONTEXT` (L127-137): Certificate chain context with trust status and chain array
- `CERT_CHAIN_ENGINE_CONFIG` (L177-192): Configuration for custom certificate chain engines
- `SSL_EXTRA_CERT_CHAIN_POLICY_PARA` (L144-150): SSL-specific policy parameters including server name

**Constants and Flags (L198-231)**
- Certificate encoding constants: `X509_ASN_ENCODING`, `PKCS_7_ASN_ENCODING` 
- Policy flags for different verification modes, including `CERT_CHAIN_POLICY_VERIFY_MODE_NONE_FLAGS` (L221-231) which combines all ignore flags for CERT_NONE mode
- OID for server authentication: `OID_PKIX_KP_SERVER_AUTH` (L203)

## Windows API Function Bindings

**Certificate Store Operations (L251-254)**
- `CertOpenStore`: Creates in-memory certificate stores
- `CertAddEncodedCertificateToStore` (L256-265): Adds certificates to stores

**Certificate Chain Operations (L272-294)**  
- `CertGetCertificateChain` (L272-284): Builds certificate chains
- `CertVerifyCertificateChainPolicy` (L286-293): Validates chains against policies
- `CertCreateCertificateChainEngine` (L244-249): Creates custom chain engines

**Resource Management (L295-307)**
- Cleanup functions for contexts, chains, stores, and engines

## Main Verification Logic

**Primary Entry Point: `_verify_peercerts_impl()` (L322-411)**
- Takes SSLContext, certificate chain bytes, and optional server hostname
- Creates in-memory store for intermediate certificates (L335)
- Creates certificate context for leaf certificate (L349-352)
- Configures chain parameters for server authentication usage (L354-363)
- Attempts verification with system trust store first (L375-383)
- Falls back to custom CA verification if system verification fails and custom CAs exist (L389-402)

**Chain Building and Verification: `_get_and_verify_cert_chain()` (L414-499)**
- Builds certificate chain using `CertGetCertificateChain` (L427-436)
- Configures SSL policy parameters with hostname validation (L440-457)
- Applies verification mode flags (CERT_NONE handling at L453-454)
- Performs policy verification and formats error messages (L463-496)

**Custom CA Verification: `_verify_using_custom_ca_certs()` (L502-551)**
- Creates exclusive trust store with only custom CA certificates (L515-523)
- Creates custom certificate chain engine (L527-535)
- Delegates to `_get_and_verify_cert_chain()` with custom engine

**Context Management: `_configure_context()` (L554-564)**
- Context manager that temporarily disables hostname checking and sets verify_mode to CERT_NONE
- Restores original settings on exit

## Key Dependencies
- `ctypes` for Windows API bindings
- `ssl` module for SSLContext integration  
- `._ssl_constants._set_ssl_context_verify_mode` for SSLContext configuration

## Architecture Patterns
- Extensive use of ctypes Structure classes to mirror Windows API structures
- Error handling via `_handle_win_error()` (L237-241) which converts Windows errors to Python exceptions
- Resource management with try/finally blocks ensuring proper cleanup of Windows handles
- Fallback verification strategy: system trust store â†’ custom CA store
- Context manager pattern for temporary SSLContext configuration changes