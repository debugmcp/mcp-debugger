# packages/adapter-rust/vendor/codelldb/darwin-arm64/lldb/lib/python3.12/site-packages/pip/_internal/network/lazy_wheel.py
@source-hash: d8f5d576e6193c23
@generated: 2026-02-09T17:58:37Z

## Purpose
Implements lazy ZIP file access over HTTP using range requests to minimize bandwidth usage when extracting wheel metadata. Primary use case is pip's wheel inspection without downloading entire files.

## Key Components

### HTTPRangeRequestUnsupported Exception (L19-20)
Custom exception raised when server doesn't support HTTP range requests, which are essential for lazy loading functionality.

### dist_from_wheel_url Function (L23-37)
Main entry point that creates a BaseDistribution from a wheel URL without full download. Uses LazyZipOverHTTP to fetch only metadata portions needed for distribution object construction. Returns canonicalized wheel distribution via MemoryWheel wrapper.

### LazyZipOverHTTP Class (L40-210)
Core implementation of file-like object that mimics ZIP file access over HTTP:

**Initialization (L49-63):**
- Validates server supports range requests via HEAD request
- Sets up NamedTemporaryFile for local caching
- Tracks downloaded byte ranges in `_left`/`_right` arrays
- Pre-validates ZIP format via `_check_zip()`

**File Interface Methods (L66-132):**
- Standard file-like properties: `mode`, `name`, `closed`, `seekable()`, `readable()`, `writable()`
- I/O operations: `read()`, `seek()`, `tell()`, `truncate()`, `close()`
- Context manager support: `__enter__()`, `__exit__()`

**Lazy Loading Logic:**
- `_stay()` (L141-151): Context manager preserving file position
- `_check_zip()` (L153-167): Downloads chunks from end backwards until valid ZIP
- `_stream_response()` (L168-176): Creates range HTTP requests
- `_merge()` (L178-198): Optimizes range requests by merging overlapping intervals
- `_download()` (L200-210): Core download logic using bisect for efficient range tracking

## Dependencies
- **pip._internal.metadata**: MemoryWheel, BaseDistribution, get_wheel_distribution
- **pip._internal.network**: PipSession, HTTP utilities
- **pip._vendor.packaging**: Name canonicalization
- **Standard library**: bisect, contextlib, tempfile, zipfile

## Architectural Patterns
- **Lazy Loading**: Downloads only necessary byte ranges on demand
- **Range Tracking**: Uses sorted arrays with bisect for O(log n) range operations  
- **File-like Interface**: Implements standard Python file protocol for ZipFile compatibility
- **Error Handling**: Graceful fallback when range requests unsupported

## Critical Invariants
- Server must support HTTP range requests (checked in constructor)
- `_left` and `_right` arrays maintain sorted, non-overlapping downloaded ranges
- ZIP validation works backwards from file end (where central directory typically resides)
- Local NamedTemporaryFile serves as sparse cache for downloaded ranges