# packages/adapter-rust/vendor/codelldb/darwin-arm64/lldb/lib/python3.12/site-packages/pip/_vendor/rich/markup.py
@source-hash: ddeb8628fe6ce353
@generated: 2026-02-09T17:59:20Z

## Purpose
Rich console markup parser that converts markup strings with style tags (e.g., `[bold]text[/bold]`) into styled Text objects. Handles tag parsing, escaping, and style application for terminal output formatting.

## Key Components

### Regular Expressions (L12-17)
- `RE_TAGS`: Matches markup tags like `[bold]`, `[red]`, `[/]` with escape handling
- `RE_HANDLER`: Parses handler syntax for meta tags (e.g., `@click(handler_name)`)

### Tag Class (L20-41)
`Tag` NamedTuple representing parsed markup tags:
- `name`: Tag identifier (e.g., "bold", "red", "@click")
- `parameters`: Optional parameters after tag name
- `markup` property: Reconstructs tag as string

### Core Functions

#### escape() (L48-71)
Escapes square brackets in text to prevent markup interpretation. Uses regex substitution to add backslashes before potential tag sequences.

#### _parse() (L73-104) 
Low-level parser yielding tuples of `(position, text, tag)` from markup string:
- Handles escaped tags and literal backslashes
- Splits tag text on "=" to separate name from parameters
- Uses `RE_TAGS.finditer()` for efficient parsing

#### render() (L106-231)
Main entry point converting markup string to styled Text object:
- **Style Stack Management (L137-151)**: Tracks nested style tags using stack
- **Tag Processing (L153-221)**:
  - Closing tags (`/name` or `/`): Pop from stack, create spans
  - Meta tags (`@handler`): Parse parameters with `literal_eval()`
  - Opening tags: Push to stack with normalized names
- **Span Creation (L217, L228)**: Converts tag ranges to Text spans
- **Emoji Support**: Optional emoji replacement via `_emoji_replace`

## Dependencies
- `Style`: Style normalization and representation
- `Text`, `Span`: Rich text objects with styling spans
- `_emoji_replace`: Emoji code replacement
- `MarkupError`: Markup parsing exceptions

## Key Patterns
- **Stack-based parsing**: Tracks nested tags for proper span generation
- **Lazy evaluation**: Uses generators and local variable caching for performance
- **Error handling**: Comprehensive markup syntax error reporting
- **Escape sequences**: Supports backslash escaping of markup characters

## Critical Behavior
- Tags are case-sensitive and normalized via `Style.normalize()`
- Unclosed tags automatically close at text end (L224-228)
- Meta tags (@-prefixed) store parameters in style metadata
- Emoji replacement only occurs when `emoji=True`
- Spans are reverse-sorted by start position for proper rendering