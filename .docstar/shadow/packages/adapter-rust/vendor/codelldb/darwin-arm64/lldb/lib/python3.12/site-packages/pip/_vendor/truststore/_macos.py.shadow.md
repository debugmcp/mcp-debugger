# packages/adapter-rust/vendor/codelldb/darwin-arm64/lldb/lib/python3.12/site-packages/pip/_vendor/truststore/_macos.py
@source-hash: 549db86afcf96841
@generated: 2026-02-09T17:59:28Z

**Purpose:** macOS-specific SSL certificate verification using native Security and CoreFoundation frameworks via ctypes. Provides trust store integration for certificate validation on macOS 10.8+.

## Core Architecture

**Platform Compatibility Check (L21-26):** Enforces macOS 10.8+ requirement, raises ImportError for older versions.

**Framework Loading (L29-52):** Dynamic library loader `_load_cdll()` handles macOS version differences, particularly Big Sur (10.16+) path fallbacks. Loads Security.framework and CoreFoundation.framework with error handling.

## Type System & Bindings

**CoreFoundation Types (L54-76):** Complete ctypes mapping for CF objects - CFString, CFData, CFArray, CFError, etc. All mapped to c_void_p pointers with proper reference types.

**Security Framework Types (L77-82):** Certificate, policy, and trust object types for SecCertificateRef, SecPolicyRef, SecTrustRef with result enums.

**Function Signatures (L84-201):** Comprehensive ctypes function signature definitions for both frameworks. Error handling via AttributeError catch ensures clean ImportError on binding failures.

## Error Handling

**OSStatus Handler (L204-254):** `_handle_osstatus()` converts macOS OSStatus codes to Python ssl.SSLError exceptions. Handles CFString error message extraction with fallback buffer allocation for non-efficient string access.

**Error Check Assignment (L257-260):** Automatically applies error checking to Security framework functions.

## Certificate Processing

**Data Conversion Utilities:**
- `_bytes_to_cf_data_ref()` (L274-277): Python bytes → CFDataRef
- `_bytes_to_cf_string()` (L280-291): Python bytes → CFString
- `_cf_string_ref_to_str()` (L294-314): CFStringRef → Python string with buffer fallback

**Certificate Array Builder (L317-344):** `_der_certs_to_cf_cert_array()` converts DER certificate list to CFMutableArrayRef of SecCertificateRef objects. Handles memory management with proper CFRelease cleanup.

## SSL Context Integration

**Context Configuration (L347-357):** `_configure_context()` context manager temporarily disables SSL verification (check_hostname=False, CERT_NONE) for custom trust evaluation.

**Main Verification Engine (L360-499):** `_verify_peercerts_impl()` orchestrates complete certificate chain validation:

1. **Policy Setup (L370-398):** Creates SSL policy with optional hostname, handles CRL checking flags
2. **Trust Object Creation (L400-416):** Builds SecTrust from certificate chain and policies  
3. **Anchor Certificate Handling (L417-432):** Integrates SSLContext CA certificates as trust anchors
4. **Trust Evaluation (L434-466):** Calls SecTrustEvaluateWithError, respects SSLContext verify_mode settings
5. **Error Processing (L467-494):** Constructs SSLCertVerificationError with native error messages

## Constants & Configuration

**CFConst Class (L263-272):** Centralized constants including UTF-8 encoding and common Security framework error codes.

**Revocation Flags (L122-123):** CRL checking configuration constants.

## Memory Management Pattern

Consistent RAII-style resource management using try/finally blocks with CFRelease calls for all CoreFoundation objects to prevent memory leaks.