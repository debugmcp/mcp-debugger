# packages/adapter-rust/vendor/codelldb/darwin-arm64/lldb/lib/python3.12/site-packages/pip/_internal/index/sources.py
@source-hash: 7497a0891f5ff3a9
@generated: 2026-02-09T17:58:38Z

## Purpose
Factory and implementation classes for pip package index sources that handle different types of package locations (local directories, files, remote URLs). Core abstraction for discovering Python packages from various sources during installation.

## Key Components

### Abstract Base Class
- **LinkSource (L29-42)**: Abstract interface defining two discovery methods:
  - `page_candidates()`: Extract packages from HTML listings
  - `file_links()`: Direct archive file links
  - Optional `link` property for underlying URL access

### Type Aliases (L23-26)
- **FoundCandidates**: Iterator of InstallationCandidate objects
- **FoundLinks**: Iterator of Link objects  
- **CandidatesFromPage**: Function to parse HTML pages for candidates
- **PageValidator**: Function to validate remote pages

### Implementation Classes

#### _FlatDirectoryToUrls (L48-93)
Caches directory scan results with lazy loading:
- Scans local directories once via `_scan_directory()` (L57-78)
- Separates HTML files (page candidates) from package archives
- Validates wheel/sdist filenames using packaging utils
- Groups archives by canonicalized project names

#### _FlatDirectorySource (L95-133)  
Handles `--find-links=<directory>` with class-level caching:
- Static `_paths_to_urls` dict (L104) prevents redundant directory scans
- Returns HTML-parsed candidates and direct file links for specific projects
- Uses canonicalized project names for filtering

#### _LocalFileSource (L135-166)
Processes local files/file: URLs:
- Differentiates HTML files (parse for links) vs direct archives
- Returns candidates from HTML parsing or yields file directly

#### _RemoteFileSource (L168-198)
Handles remote URLs:
- Validates pages via `PageValidator` before parsing
- Always yields the link as potential file candidate
- Supports both HTML parsing and direct file downloads

#### _IndexDirectorySource (L200-224)
Treats directory URLs as package indexes:
- Only provides page candidates (no direct files)
- Relies on `candidates_from_page` to append `index.html`

### Factory Function
**build_source() (L226-285)**: Central factory that:
1. Determines if location is local path, file: URL, or remote URL
2. Selects appropriate LinkSource implementation based on:
   - Local vs remote location
   - Directory vs file
   - `expand_dir` flag (flat directory vs index directory)
3. Returns tuple of (normalized_url, source_instance)
4. Logs warnings for invalid/inaccessible locations

## Architecture Patterns
- **Strategy Pattern**: Different source classes handle various location types
- **Lazy Loading**: Directory scanning deferred until first access
- **Caching**: Class-level cache prevents redundant directory operations
- **Factory Pattern**: Single entry point (`build_source`) creates appropriate sources

## Dependencies
- `pip._vendor.packaging.utils`: Filename parsing and validation
- `pip._internal.models`: Link and InstallationCandidate data structures
- `pip._internal.utils.urls`: Path/URL conversion utilities
- `pip._internal.vcs`: URL scheme validation

## Critical Invariants
- Directory scans populate both page candidates and project-specific URLs atomically
- HTML detection via mimetype determines parsing vs direct file handling  
- All sources must implement the LinkSource protocol consistently
- File validation ensures only valid wheel/sdist names are considered