# packages/adapter-rust/vendor/codelldb/darwin-arm64/lldb/lib/python3.12/site-packages/pip/_vendor/urllib3/contrib/securetransport.py
@source-hash: 15e7f5208514147a
@generated: 2026-02-09T17:57:41Z

## SecureTransport SSL Backend for urllib3

**Primary Purpose**: Provides macOS SecureTransport SSL/TLS support for urllib3 via ctypes, enabling TLS 1.2+ connections without requiring OpenSSL compilation. This is a compatibility shim that monkey-patches urllib3 to use macOS's native SecureTransport framework instead of OpenSSL.

### Key Public Functions

- `inject_into_urllib3()` (L188-198): Monkey-patches urllib3 to use SecureTransport by replacing `util.SSLContext` and related attributes
- `extract_from_urllib3()` (L200-210): Reverses the monkey-patching, restoring original urllib3 SSL behavior

### Core Classes

**WrappedSocket** (L325-781): SSL socket wrapper that provides OpenSSL-compatible API over SecureTransport
- `__init__(socket)` (L333-350): Initializes wrapper with timeout management and state tracking
- `handshake()` (L473-565): Performs TLS handshake with comprehensive parameter support (hostname, verification, client certs, ALPN)
- `recv()/recv_into()` (L576-623): Data reading with SecureTransport error handling and timeout management
- `send()/sendall()` (L631-653): Data writing with chunking (16KB blocks per SSL_WRITE_BLOCKSIZE)
- `getpeercert()` (L677-733): Returns peer certificate in binary DER format only
- `version()` (L735-754): Returns negotiated TLS version string
- `close()` (L658-675): Resource cleanup including keychain management

**SecureTransportContext** (L784-920): SSLContext-compatible interface for SecureTransport
- `__init__(protocol)` (L791-799): Maps SSL protocol constants to SecureTransport min/max versions
- `wrap_socket()` (L889-920): Creates WrappedSocket and initiates handshake
- Property handlers for `check_hostname`, `options`, `verify_mode` with SecureTransport-specific behaviors
- `load_verify_locations()` (L860-870): Loads custom CA certificates (file or data only, no directories)
- `set_alpn_protocols()` (L877-887): ALPN support (requires macOS 10.12+)

### Critical Callback Functions

- `_read_callback()` (L212-265): SecureTransport read callback with connection ref lookup and error mapping
- `_write_callback()` (L267-316): SecureTransport write callback with chunked sending and error handling
- Callback pointers stored as module globals (L321-322) to prevent garbage collection

### Key Data Structures

- `_connection_refs` (L110): WeakValueDictionary mapping connection IDs to WrappedSocket instances
- `_connection_ref_lock` (L111): Threading lock for connection ref dictionary updates
- `CIPHER_SUITES` (L120-151): Hardcoded list of supported TLS cipher suites
- `_protocol_to_min_max` (L156-185): Protocol version mapping dictionary

### Important Constants & Configuration

- `SSL_WRITE_BLOCKSIZE = 16384` (L115): Maximum write chunk size
- `HAS_SNI = True` (L89): SNI always supported on macOS
- Platform-specific imports handle Python 2/3 compatibility (L80-84, L766-781)

### Critical Behaviors

- **Certificate Validation**: Custom validation via `_custom_validate()` (L398-431) with TLS alert sending on failure
- **Keychain Management**: Temporary keychains created for client certificates, cleaned up on close
- **Error Handling**: SecureTransport error codes mapped to Python socket/SSL exceptions
- **Hostname Checking**: Cannot be disabled (always returns True), handled by SecureTransport internally
- **Resource Management**: Explicit CFRelease calls for CoreFoundation objects to prevent memory leaks

### Dependencies

- ctypes for SecureTransport bindings
- `_securetransport.bindings` for CoreFoundation/Security framework access
- `_securetransport.low_level` for utility functions
- Standard library: socket, ssl, threading, weakref, contextlib

### Architectural Notes

- Uses ctypes exclusively to avoid compilation requirements
- Designed as temporary solution pending PEP 543 implementation
- Thread-safe connection reference management with optimized callback performance
- Extensive error propagation from SecureTransport callbacks to Python exceptions