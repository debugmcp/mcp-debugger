# packages/adapter-rust/vendor/codelldb/darwin-arm64/lldb/lib/python3.12/site-packages/pip/_vendor/cachecontrol/filewrapper.py
@source-hash: 493b6d1a620f06f6
@generated: 2026-02-09T17:58:47Z

## Primary Purpose

File wrapper that intercepts HTTP response data streams, caching all read data in a temporary file and executing a callback with the complete data when the stream closes. Part of the cachecontrol library for HTTP caching functionality.

## Key Classes and Functions

### CallbackFileWrapper (L14-119)
Main wrapper class that proxies an HTTP response file object while tee-ing all read data to a temporary buffer.

**Constructor** (L33-38):
- `fp: HTTPResponse` - The underlying HTTP response file object to wrap
- `callback: Callable[[bytes], None] | None` - Function called with complete data when stream closes
- Creates `NamedTemporaryFile` for buffering (`__buf`)

**Core Methods**:
- `__getattr__(name)` (L40-50) - Proxies all attribute access to underlying file object
- `read(amt)` (L97-106) - Main read method that tees data to buffer and triggers close when needed
- `_safe_read(amt)` (L108-119) - Special read method for urllib compatibility, handles CRLF detection
- `_close()` (L70-95) - Executes callback with complete buffered data using memory-mapped view

**Helper Methods**:
- `__is_fp_closed()` (L52-68) - Detects if underlying file is closed via multiple fallback checks

## Key Dependencies

- `mmap` - For memory-efficient access to temporary file data
- `tempfile.NamedTemporaryFile` - For disk-based buffering
- `typing` - Type annotations for HTTPResponse and callbacks

## Architecture Patterns

**Proxy Pattern**: All undefined attributes are forwarded to the wrapped HTTP response object via `__getattr__`.

**Buffering Strategy**: Uses temporary files that leverage filesystem memory cache, automatically spilling to disk under memory pressure without performance impact for small files.

**Memory Optimization**: Uses `mmap` and `memoryview` to avoid loading entire file into memory when executing callback.

**Reference Cycle Breaking**: Explicitly sets callback to `None` after execution to prevent garbage collection deadlocks.

## Critical Implementation Details

**Double Underscore Naming**: All internal attributes use `__` prefix to avoid shadowing proxied attributes from the underlying file object.

**Robust Close Detection**: Multiple fallback mechanisms for detecting closed state (`fp is None`, `closed` attribute) since different HTTP response types may vary.

**CRLF Handling**: Special case in `_safe_read` for 2-byte `\r\n` reads that urllib uses to consume chunk terminators.

**Temporary File Management**: Automatically deletes temporary file on close to free disk space, important for large cached responses.