# packages/adapter-rust/vendor/codelldb/darwin-arm64/lldb/lib/python3.12/site-packages/pip/_vendor/urllib3/packages/backports/weakref_finalize.py
@source-hash: b5109a97938084d4
@generated: 2026-02-09T17:56:58Z

## Purpose
Backports Python 3's `weakref.finalize` functionality for older Python versions, providing a mechanism to register cleanup functions that execute when objects are garbage collected.

## Core Class: weakref_finalize (L17-155)
Main finalizer class that mimics Python 3's `weakref.finalize` behavior.

### Key Attributes (L34-38)
- `_registry` (L34): Dictionary mapping finalizer instances to `_Info` objects containing cleanup data
- `_shutdown` (L35): Boolean flag preventing finalizer execution during program shutdown
- `_index_iter` (L36): Counter for ordering finalizers by creation time
- `_dirty` (L37): Flag indicating registry changes, triggers re-evaluation of pending finalizers
- `_registered_with_atexit` (L38): Ensures atexit handler is registered only once

### Internal Data Structure: _Info (L40-41)
Lightweight container storing finalizer metadata with slots for: weakref, func, args, kwargs, atexit flag, and index.

### Core Methods
- `__init__(obj, func, *args, **kwargs)` (L43-59): Registers finalizer for object, creates weakref, stores cleanup function and arguments
- `__call__(_=None)` (L61-66): Executes and removes finalizer, returns function result or None if dead
- `detach()` (L68-74): Removes finalizer without execution, returns tuple of (obj, func, args, kwargs) or None
- `peek()` (L76-82): Returns finalizer details without modification, useful for inspection
- `alive` property (L84-87): Checks if finalizer is still registered
- `atexit` property (L89-99): Controls whether finalizer runs during program exit

### Exit Handling
- `_select_for_exit()` (L114-119): Returns live finalizers marked for exit, sorted by creation order (oldest first)
- `_exitfunc()` (L121-155): Cleanup handler registered with atexit module, disables GC during execution to prevent reference cycles, processes finalizers in creation order

## Architecture Patterns
- **Registry Pattern**: Uses class-level dictionary to track all finalizers
- **Weakref Integration**: Leverages weakref callbacks to trigger cleanup automatically on object destruction  
- **Atexit Integration**: Ensures cleanup runs during program shutdown for remaining finalizers
- **GC Management**: Temporarily disables garbage collection during exit to prevent issues with finalizer creation during cleanup

## Critical Invariants
- Finalizers have no instance state (`__slots__ = ()`) to prevent reference cycles
- Registry cleanup is atomic - finalizers are removed before execution
- Exit finalizers run in reverse creation order (oldest first via index sorting)
- Shutdown flag prevents new finalizer execution during program termination

## Dependencies
- `weakref.ref` for object lifecycle tracking
- `itertools.count()` for ordering finalizers
- `atexit` module for program exit hooks
- `gc` module for garbage collection control during exit