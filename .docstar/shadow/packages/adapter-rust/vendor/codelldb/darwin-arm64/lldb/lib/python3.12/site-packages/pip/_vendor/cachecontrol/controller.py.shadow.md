# packages/adapter-rust/vendor/codelldb/darwin-arm64/lldb/lib/python3.12/site-packages/pip/_vendor/cachecontrol/controller.py
@source-hash: a3e7a31899419a92
@generated: 2026-02-09T17:58:51Z

**Primary Purpose**: HTTP cache controller implementing RFC 7234 caching algorithms for the cachecontrol library, ported from httplib2 for use with requests library. Manages request/response caching decisions, cache validation, and conditional requests.

**Key Classes & Functions**:

- **CacheController (L48-499)**: Main cache management class
  - `__init__` (L51-61): Configures cache backend, etag caching, serializer, and cacheable status codes
  - `cached_request` (L167-275): Primary method to check if request can be served from cache, implements freshness validation
  - `cache_response` (L322-457): Determines if response should be cached based on headers and status codes
  - `conditional_headers` (L277-290): Generates If-None-Match/If-Modified-Since headers for cache validation
  - `update_cached_response` (L459-499): Updates cached response headers on 304 Not Modified responses

- **parse_uri** (L37-45): RFC 3986 URI parser using regex, returns tuple of URI components

**Key Methods & Logic**:

- **URL Normalization** (`_urlnorm`/`cache_url`, L63-85): Creates consistent cache keys by normalizing schemes, authorities, and paths
- **Cache Control Parsing** (`parse_cache_control`, L87-139): Parses Cache-Control headers per RFC 7234, handles directives like max-age, no-cache, no-store
- **Cache Loading** (`_load_from_cache`, L141-165): Retrieves cached responses, handles separate body storage for SeparateBodyBaseCache
- **Cache Storage** (`_cache_set`, L292-320): Stores responses with optional body separation and expiration times

**Important Dependencies**:
- `pip._vendor.requests`: PreparedRequest objects and CaseInsensitiveDict
- `pip._vendor.urllib3`: HTTPResponse objects  
- `pip._vendor.cachecontrol.cache`: BaseCache, DictCache, SeparateBodyBaseCache
- `pip._vendor.cachecontrol.serialize`: Serializer for cache persistence

**Key Constants & Patterns**:
- `URI` (L32): RFC 3986 URI parsing regex
- `PERMANENT_REDIRECT_STATUSES` (L34): 301, 308 status codes for permanent redirects
- Default cacheable status codes: 200, 203, 300, 301, 308 (L61)

**Critical Invariants**:
- Only absolute URIs allowed for caching (L67-68)
- Range requests bypass cache entirely (L147-148)  
- Responses with `Vary: *` header never cached (L392-394)
- Content-Length must match body length for caching (L358-364)
- ETags get minimum 14-day cache lifetime (L404)
- 304 responses update cached headers but preserve 200 status (L494)

**Caching Decision Logic**:
1. Request-level bypasses: no-cache, max-age=0, Range headers
2. Response validation: status codes, no-store directives, Vary headers  
3. Freshness calculation: max-age > expires > heuristic caching
4. Conditional requests using ETags and Last-Modified headers