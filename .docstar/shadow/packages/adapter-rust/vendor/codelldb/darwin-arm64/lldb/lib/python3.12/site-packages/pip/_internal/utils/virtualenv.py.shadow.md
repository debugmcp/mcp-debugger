# packages/adapter-rust/vendor/codelldb/darwin-arm64/lldb/lib/python3.12/site-packages/pip/_internal/utils/virtualenv.py
@source-hash: 4ba7fb72c628ad1a
@generated: 2026-02-09T17:58:41Z

## Purpose
Virtual environment detection utility for pip. Handles both modern PEP 405 compliant virtual environments and legacy pypa/virtualenv installations. Primary responsibility is determining if pip is running inside a virtual environment and whether system site-packages are accessible.

## Key Functions

**`running_under_virtualenv()` (L31-33)**
- Main entry point for virtual environment detection
- Returns True if running inside any type of virtual environment
- Combines both modern and legacy detection methods

**`_running_under_venv()` (L14-19)**
- Detects PEP 405 compliant virtual environments (Python 3.3+)
- Compares `sys.prefix` with `sys.base_prefix` for detection
- Uses safe fallback with getattr for Python versions without base_prefix

**`_running_under_legacy_virtualenv()` (L22-28)**
- Detects pypa/virtualenv created environments
- Checks for existence of `sys.real_prefix` attribute
- Handles older virtual environment implementations

**`virtualenv_no_global()` (L94-104)**
- Determines if virtual environment excludes system site-packages
- Uses priority-based checking: PEP 405 first, then legacy
- Returns False if not in virtual environment

**Configuration Parsing Functions:**
- `_get_pyvenv_cfg_lines()` (L36-48): Reads pyvenv.cfg with UTF-8 encoding
- `_no_global_under_venv()` (L51-77): Parses PEP 405 config using regex
- `_no_global_under_legacy_virtualenv()` (L80-91): Checks for no-global-site-packages.txt file

## Dependencies
- Standard library: `logging`, `os`, `re`, `site`, `sys`
- Type hints from `typing` module

## Architecture Patterns
- **Dual Detection Strategy**: Supports both modern (PEP 405) and legacy (pypa/virtualenv) virtual environments
- **Priority-Based Logic**: PEP 405 detection takes precedence in `virtualenv_no_global()` (L96-97)
- **Defensive Programming**: Uses getattr with fallback, handles OSError gracefully
- **Regex-Based Parsing**: Uses compiled regex `_INCLUDE_SYSTEM_SITE_PACKAGES_REGEX` (L9-11) for config file parsing

## Critical Invariants
- PEP 405 virtual environments always write pyvenv.cfg with UTF-8 encoding
- Legacy virtualenv detection relies on `sys.real_prefix` attribute existence
- System site-packages access is determined by specific configuration markers in each virtual environment type
- Default assumption is no system site-packages access when configuration is unclear