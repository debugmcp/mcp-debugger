# packages/adapter-rust/vendor/codelldb/darwin-arm64/lldb/lib/python3.12/site-packages/pip/_vendor/urllib3/contrib/_securetransport/low_level.py
@source-hash: 076241076fcd44fd
@generated: 2026-02-09T17:56:57Z

## Purpose
Low-level SecureTransport bindings helper module providing CoreFoundation and Security framework integration for macOS SSL/TLS operations. Handles memory management, certificate/keychain operations, and data conversion between Python and CoreFoundation types.

## Key Dependencies  
- `.bindings`: Imports `CFConst`, `CoreFoundation`, `Security` framework bindings (L19)
- Standard libraries: `ctypes`, `ssl`, `base64`, `struct` for data manipulation and error handling

## Core Functions

### Data Conversion Utilities
- `_cf_data_from_bytes(bytestring)` (L27-34): Creates CFData from Python bytes, caller must CFRelease
- `_cfstr(py_bstr)` (L59-70): Creates CFString from Python binary data, caller must CFRelease  
- `_cf_dictionary_from_tuples(tuples)` (L37-56): Creates CFDictionary from Python tuple list
- `_create_cfstring_array(lst)` (L73-101): Creates CFMutableArray of CFStrings, with automatic cleanup on failure
- `_cf_string_to_unicode(value)` (L104-126): Converts CFString to Python unicode string for error reporting

### Certificate Management
- `_cert_array_from_pem(pem_bundle)` (L150-193): Parses PEM certificate bundle into CFArray of SecCertificate objects
- `_is_cert(item)` (L196-201): Type check for SecCertificate CFTypeRef
- `_is_identity(item)` (L204-209): Type check for SecIdentity CFTypeRef

### Keychain Operations
- `_temporary_keychain()` (L212-244): Creates temporary keychain with random password, returns (keychain, temp_dir)
- `_load_items_from_file(keychain, path)` (L247-299): Imports certificates/identities from file into keychain
- `_load_client_cert_chain(keychain, *paths)` (L302-375): Loads complete client certificate chain, creates SecIdentity if needed

### Error Handling & Protocol Support
- `_assert_no_error(error, exception_class=None)` (L129-147): Converts Security framework errors to Python exceptions
- `TLS_PROTOCOL_VERSIONS` (L377-383): Protocol version mapping dictionary
- `_build_tls_unknown_ca_alert(version)` (L386-396): Constructs TLS alert record for unknown CA errors

## Memory Management Pattern
Critical pattern: All `CF*Create*` functions require caller to `CFRelease`. Functions use try/finally blocks to ensure cleanup on exceptions. Objects are retained when added to collections and released when no longer needed.

## Certificate Regex
`_PEM_CERTS_RE` (L22-24): Extracts certificate data from PEM format using DOTALL matching.

## Architecture Notes
- Designed for macOS SecureTransport backend in urllib3
- Heavy ctypes usage for C API interop
- Defensive memory management with exception-safe cleanup
- Temporary keychain strategy required for SecIdentity creation on macOS