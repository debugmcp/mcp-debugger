# packages/adapter-rust/vendor/codelldb/darwin-arm64/lldb/lib/python3.12/site-packages/pip/_vendor/msgpack/fallback.py
@source-hash: c1d516264597da0c
@generated: 2026-02-09T17:59:05Z

## Purpose
Pure Python fallback implementation for MessagePack serialization/deserialization when C extensions are unavailable. Provides streaming and direct pack/unpack capabilities with extensive configuration options.

## Key Classes

### Unpacker (L135-605)
Streaming MessagePack deserializer supporting both file-like objects and manual buffer feeding.

**Constructor** (L231-321): Extensive configuration including buffer limits, hooks, type handling
- `file_like`: File object for streaming reads
- `max_buffer_size`: Buffer size limit (default 100MB)
- `raw`, `use_list`, `strict_map_key`: Type conversion options
- `object_hook`, `object_pairs_hook`, `list_hook`: Custom deserialization callbacks
- `timestamp`: Timestamp handling mode (0-3)

**Core Methods**:
- `feed(next_bytes)` (L322-336): Add data to internal buffer
- `_unpack(execute)` (L491-563): Main deserialization logic with recursion handling
- `_read_header()` (L395-489): Parse MessagePack type headers using `_MSGPACK_HEADERS` lookup
- Iterator interface (`__iter__`, `__next__`) (L565-579)
- `unpack()`, `skip()` (L585-583): Single object operations
- `read_array_header()`, `read_map_header()` (L593-601): Header-only parsing

**Buffer Management**:
- `_buffer`: Internal bytearray for data storage
- `_buff_i`: Current read position
- `_buf_checkpoint`: Rollback point for incomplete reads
- `_consume()` (L337-340): Cleanup consumed data

### Packer (L607-951)
MessagePack serializer with type-specific encoding logic.

**Constructor** (L676-696): Serialization behavior configuration
- `default`: Custom type handler
- `use_single_float`, `strict_types`, `datetime`: Type handling options
- `autoreset`: Auto-clear buffer after packing

**Core Methods**:
- `_pack(obj, nest_limit)` (L698-820): Main recursive serialization with type dispatch
- `pack(obj)` (L822-831): Public interface with error handling
- Type-specific packers: `_pack_array_header()` (L887-894), `_pack_map_header()` (L896-903)
- `pack_ext_type()` (L858-885): Extension type serialization

## Key Data Structures

### _MSGPACK_HEADERS (L103-132)
Lookup table mapping MessagePack format bytes to parsing specifications:
- Format: `{byte: (size, struct_format, type_constant)}`
- Used by `_read_header()` for efficient type dispatch

### Constants (L48-61)
- Execution modes: `EX_SKIP`, `EX_CONSTRUCT`, `EX_READ_ARRAY_HEADER`, `EX_READ_MAP_HEADER`
- Type constants: `TYPE_IMMEDIATE`, `TYPE_ARRAY`, `TYPE_MAP`, `TYPE_RAW`, `TYPE_BIN`, `TYPE_EXT`
- `DEFAULT_RECURSE_LIMIT`: Stack overflow protection (511)

## Platform Optimizations

### PyPy StringBuilder (L7-41)
Conditional import of PyPy's optimized StringBuilder for better performance:
- Custom `StringIO` wrapper using `StringBuilder` when available
- Falls back to standard `io.BytesIO` on other platforms

## Utility Functions

- `unpackb(packed, **kwargs)` (L77-99): Convenience function for single-shot unpacking
- `_check_type_strict(obj, t)` (L63-67): Strict type checking helper
- `_get_data_from_buffer(obj)` (L70-74): Memory view validation

## Error Handling
- `BufferFull`: Buffer size limits exceeded
- `OutOfData`: Incomplete input data
- `ExtraData`: Trailing bytes after complete object
- `FormatError`: Invalid MessagePack format
- `StackError`: Recursion limit exceeded

## Dependencies
- `struct`: Binary data packing/unpacking
- `.exceptions`: Custom exception classes
- `.ext`: ExtType and Timestamp extension types
- Conditional PyPy imports for performance optimization