# packages/adapter-rust/vendor/codelldb/darwin-arm64/lldb/lib/python3.12/site-packages/pip/_vendor/urllib3/util/connection.py
@source-hash: e4bc760753d6dbd2
@generated: 2026-02-09T17:57:29Z

## Purpose
Provides low-level socket connection utilities for urllib3, handling platform-specific connection management, IPv6 capability detection, and socket creation with custom options.

## Key Functions

**`is_connection_dropped(conn)` (L11-30)**
- Detects if an HTTP connection should be closed due to being dropped
- Returns False on AppEngine to let platform handle connection recycling
- Uses `wait_for_read()` with 0 timeout to check socket readability
- Handles cases where connection has no socket or is already closed

**`create_connection(address, timeout, source_address, socket_options)` (L37-97)**
- Enhanced version of Python's standard `socket.create_connection()`
- Creates TCP connections with IPv6 awareness and custom socket options
- Strips IPv6 bracket notation from hostnames
- Validates hostname with IDNA encoding, raises LocationParseError on failure
- Uses `allowed_gai_family()` to determine IP family preference
- Iterates through getaddrinfo results, attempting connection on each
- Applies custom socket options via `_set_socket_options()`
- Returns first successful socket connection

**`_set_socket_options(sock, options)` (L100-105)**
- Helper to apply list of socket options using `setsockopt()`
- Options format: list of tuples to unpack as setsockopt arguments

**`allowed_gai_family()` (L108-116)**
- Returns appropriate address family for getaddrinfo calls
- Returns AF_INET (IPv4 only) or AF_UNSPEC (IPv4+IPv6) based on system capability
- Controlled by global HAS_IPV6 constant

**`_has_ipv6(host)` (L119-146)**
- Tests actual IPv6 functionality by attempting socket bind
- Returns False immediately on AppEngine due to platform limitations
- Checks `socket.has_ipv6` (compile-time support) then tests runtime capability
- Safely handles exceptions during IPv6 socket creation/binding

## Global Constants
**`HAS_IPV6` (L149)** - Boolean indicating system IPv6 support, determined by testing bind to "::1"

## Dependencies
- Standard `socket` module for core networking
- `..contrib._appengine_environ` for platform detection
- `..exceptions.LocationParseError` for hostname validation errors
- `..packages.six` for Python 2/3 compatibility
- `.wait.wait_for_read`, `.wait.NoWayToWaitForSocketError` for non-blocking socket checks

## Architecture Notes
- Platform-aware design with special handling for Google AppEngine
- IPv6 capability detection through runtime testing rather than just compile-time flags
- Robust error handling with connection cleanup on failures
- Extension of Python standard library with additional socket options support