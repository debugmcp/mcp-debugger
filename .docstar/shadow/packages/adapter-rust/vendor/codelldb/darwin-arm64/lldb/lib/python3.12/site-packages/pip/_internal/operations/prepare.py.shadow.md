# packages/adapter-rust/vendor/codelldb/darwin-arm64/lldb/lib/python3.12/site-packages/pip/_internal/operations/prepare.py
@source-hash: 8e8589c0f92ea86b
@generated: 2026-02-09T17:58:43Z

**Purpose:** Core pip distribution preparation module handling package download, unpacking, hash verification, and metadata extraction for installation requirements.

**Key Classes:**

- **File (L84-92)**: Simple dataclass representing a file with path and auto-detected MIME content type
- **RequirementPreparer (L215-732)**: Main orchestrator class for preparing distributions from various sources (URLs, local files, VCS, editable installs)

**Core Functions:**

- **_get_prepared_distribution (L60-75)**: Creates distribution metadata from InstallRequirement using build tracker
- **unpack_vcs_link (L78-81)**: Unpacks VCS-based links using appropriate VCS backend
- **get_http_url (L94-115)**: Downloads HTTP URLs with hash verification and caching support
- **get_file_url (L118-139)**: Handles file:// URLs with optional hash checking
- **unpack_url (L142-182)**: Universal unpacking dispatcher - routes to VCS, file, or HTTP handlers; unpacks non-wheel archives
- **_check_download_dir (L185-212)**: Validates previously downloaded files against expected hashes

**RequirementPreparer Key Methods:**

- **prepare_linked_requirement (L491-527)**: Main entry point for linked requirements; attempts optimizations (cached files, metadata-only fetch) before full preparation
- **prepare_linked_requirements_more (L529-557)**: Handles batch completion of partially-prepared requirements
- **_prepare_linked_requirement (L559-649)**: Core preparation logic with hash verification, download/unpack, and distribution creation
- **prepare_editable_requirement (L677-708)**: Specialized handler for editable installs
- **prepare_installed_requirement (L710-732)**: Handles already-satisfied requirements

**Optimization Features:**

- **_fetch_metadata_only (L358-375)**: Attempts PEP 658 metadata or lazy wheel fetching to avoid full downloads
- **_fetch_metadata_using_link_data_attr (L377-416)**: Downloads standalone METADATA files when available
- **_fetch_metadata_using_lazy_wheel (L418-445)**: Uses HTTP range requests for wheel metadata extraction
- **_complete_partial_requirements (L447-489)**: Batch downloads requirements that were initially metadata-only

**Dependencies:** Heavily integrated with pip's internal ecosystem including downloaders, build tracking, hash verification, VCS backends, and distribution metadata systems.

**Architecture Notes:**
- Supports both legacy and modern resolvers
- Implements multiple download optimization strategies
- Maintains download caching with URL-to-path mapping
- Handles complex hash verification scenarios including cached wheels
- Integrates with build isolation and dependency checking systems