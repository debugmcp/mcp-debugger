# packages/adapter-rust/vendor/codelldb/darwin-arm64/lldb/lib/python3.12/site-packages/pip/_internal/index/collector.py
@source-hash: 45d3ced092c0966c
@generated: 2026-02-09T17:58:43Z

## Primary Purpose

This module implements the link collection mechanism for pip's package discovery system, centered around the `LinkCollector.collect_sources()` method (L450-494). It handles fetching and parsing Simple API responses (HTML/JSON) from PyPI-style package indexes to extract downloadable package links.

## Key Components

### Core Classes

**LinkCollector (L390-494)**
- Main orchestrator class responsible for collecting package links from configured sources
- `__init__(L398-404)`: Takes PipSession and SearchScope
- `create()` classmethod (L407-438): Factory method that builds from command-line options
- `collect_sources(L450-494)`: Primary method that builds sources for both index URLs and find-links
- `fetch_response(L444-448)`: Wrapper for fetching index content from a link

**IndexContent (L252-271)** 
- Immutable dataclass representing parsed page content with metadata
- Contains `content` (bytes), `content_type`, `encoding`, `url`, and `cache_link_parsing` flag
- Used as input to link parsing functions

**HTMLLinkParser (L273-299)**
- HTMLParser subclass that extracts anchor tags and base URLs
- `handle_starttag(L286-292)`: Processes `<base>` and `<a>` tags
- Stores results in `self.anchors` and `self.base_url`

### Key Functions

**parse_links (L224-250)** (decorated with caching)
- Parses both JSON Simple API v1 and HTML formats 
- Returns iterable of Link objects extracted from IndexContent
- Handles JSON format (L230-237) and HTML format (L239-249)

**_get_index_content (L324-382)**
- Fetches content from a Link URL with comprehensive error handling
- Handles VCS scheme filtering, file:// directory handling, and multiple exception types
- Returns IndexContent or None on failure

**_get_simple_response (L113-173)**
- Core HTTP fetching logic with Simple API validation
- Sets appropriate Accept headers for PyPI Simple API
- Implements cache-control strategy (max-age=0) for package index freshness

### Validation and Error Handling

**_ensure_api_header (L69-88)** and **_ensure_api_response (L95-111)**
- Validate Content-Type headers for Simple API compliance
- Accept: text/html, application/vnd.pypi.simple.v1+html, application/vnd.pypi.simple.v1+json

**Exception Classes**
- `_NotAPIContent (L62-67)`: Invalid content type
- `_NotHTTP (L91-92)`: Non-HTTP scheme

### Caching Infrastructure

**with_cached_index_content (L203-221)**
- Decorator factory providing LRU caching for link parsing
- Uses `CacheablePageContent (L187-197)` as cache key
- Respects `cache_link_parsing` flag to disable caching for PyPI URLs

## Dependencies

- **External**: requests, email.message, html.parser, urllib
- **Internal**: pip models (Link, SearchScope), network utils, VCS support
- **Local**: sources module for LinkSource and build_source

## Architectural Patterns

1. **Factory Pattern**: LinkCollector.create() builds instances from CLI options
2. **Strategy Pattern**: Different parsing strategies for JSON vs HTML content
3. **Decorator Pattern**: Caching decorator wraps parsing functions
4. **Error Recovery**: Comprehensive exception handling with logging and graceful degradation

## Critical Invariants

- Simple API responses must have valid Content-Type headers
- Link parsing can be selectively cached based on source type
- VCS URLs are filtered out during content fetching
- File URLs to directories are automatically appended with "index.html"
- All network errors are caught and logged rather than propagated