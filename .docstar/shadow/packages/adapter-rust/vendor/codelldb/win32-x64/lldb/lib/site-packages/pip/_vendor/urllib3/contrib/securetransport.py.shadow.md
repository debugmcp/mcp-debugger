# packages/adapter-rust/vendor/codelldb/win32-x64/lldb/lib/site-packages/pip/_vendor/urllib3/contrib/securetransport.py
@source-hash: 15e7f5208514147a
@generated: 2026-02-09T18:02:29Z

## Purpose
Provides macOS SecureTransport-based TLS support for urllib3 via ctypes, enabling TLS 1.2+ connections without requiring a compiler. This is a compatibility shim for macOS systems where the default OpenSSL cannot handle modern TLS requirements.

## Key Components

### Module Configuration (L86-196)
- `inject_into_urllib3()` (L188-198): Monkey-patches urllib3 to use SecureTransport by replacing `util.SSLContext` and setting capability flags
- `extract_from_urllib3()` (L200-210): Reverses the monkey-patching to restore original urllib3 SSL behavior
- `HAS_SNI = True` (L89): SNI support is always available in SecureTransport
- `CIPHER_SUITES` (L120-151): Hardcoded list of supported cipher suites matching urllib3's DEFAULT_CIPHERS

### Protocol Configuration (L156-185)
- `_protocol_to_min_max` (L156-185): Maps SSL/TLS protocol constants to SecureTransport protocol version ranges
- Supports TLS 1.0-1.2, with conditional support for older protocols based on Python ssl module availability

### Callback System (L212-322)
- `_read_callback()` (L212-265): SecureTransport read callback that handles socket data reading with timeout management
- `_write_callback()` (L267-316): SecureTransport write callback for network data transmission
- `_connection_refs` (L110): WeakValueDictionary mapping connection IDs to wrapped socket objects
- `_connection_ref_lock` (L111): Threading lock for safe connection reference management

### WrappedSocket Class (L325-764)
Primary socket wrapper implementing OpenSSL-compatible interface over SecureTransport:

#### Core Methods
- `__init__()` (L333-350): Initializes socket wrapper, saves original timeout, sets socket to non-blocking
- `handshake()` (L473-565): Performs TLS handshake with comprehensive parameter handling (hostname, verification, client certs, ALPN)
- `recv()` / `recv_into()` (L576-623): Data reading with SecureTransport error handling
- `send()` / `sendall()` (L631-653): Data transmission with chunking support
- `close()` (L658-676): Cleanup including keychain deletion and CoreFoundation object release

#### Certificate Handling
- `_custom_validate()` (L398-432): Custom certificate validation logic, handles trust bundles and verification bypass
- `_evaluate_trust()` (L433-471): SecureTransport trust evaluation using custom CA certificates
- `getpeercert()` (L677-733): Returns peer certificate in DER format (binary only)

#### Configuration
- `_set_ciphers()` (L372-383): Applies the hardcoded cipher suite list
- `_set_alpn_protocols()` (L385-396): Configures ALPN protocol negotiation

### SecureTransportContext Class (L784-920)
SSL context wrapper implementing Python's SSLContext interface:

- `__init__()` (L791-799): Initializes with protocol version bounds and default settings
- `wrap_socket()` (L889-920): Creates WrappedSocket and performs handshake
- Property handlers for `check_hostname`, `options`, `verify_mode` with SecureTransport-specific behaviors
- `load_verify_locations()` (L860-870): Supports custom CA files/data but not CA directories
- `load_cert_chain()` (L872-875): Configures client certificate authentication
- `set_alpn_protocols()` (L877-887): ALPN configuration with macOS 10.12+ requirement check

## Key Dependencies
- `_securetransport.bindings`: CoreFoundation, Security, SecurityConst APIs
- `_securetransport.low_level`: Utility functions for certificate handling and SecureTransport operations
- ctypes for system API interaction
- Platform-specific imports for Python 2/3 socket compatibility

## Architecture Notes
- Uses ctypes exclusively to avoid compilation requirements
- Thread-safe connection reference management via WeakValueDictionary
- Implements custom certificate validation pipeline
- Hardcoded cipher suites prevent user customization
- Temporary keychain creation for client certificate storage