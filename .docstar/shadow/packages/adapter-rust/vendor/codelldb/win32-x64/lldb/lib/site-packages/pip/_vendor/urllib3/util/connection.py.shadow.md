# packages/adapter-rust/vendor/codelldb/win32-x64/lldb/lib/site-packages/pip/_vendor/urllib3/util/connection.py
@source-hash: e4bc760753d6dbd2
@generated: 2026-02-09T18:02:11Z

## Purpose

Socket connection utilities for urllib3 that provide platform-agnostic connection management, including connection health checks, socket creation with IPv6 support detection, and AppEngine compatibility.

## Key Functions

**`is_connection_dropped(conn)` (L11-30)**
- Detects if an HTTP connection has been dropped and should be closed
- Uses socket readability as a proxy for connection state (readable = dropped)
- Returns False on AppEngine platforms to let platform handle connection recycling
- Returns True if connection already closed or socket is readable

**`create_connection(address, timeout, source_address, socket_options)` (L37-97)**
- Enhanced version of Python's socket.create_connection with additional features
- Supports IPv6 bracket notation parsing (strips `[]` from host)
- Uses `allowed_gai_family()` to determine IP family support
- Validates host with IDNA encoding, raises LocationParseError for invalid hosts
- Iterates through getaddrinfo results, applies socket options, and returns first successful connection
- Properly closes failed sockets to prevent resource leaks

**`_set_socket_options(sock, options)` (L100-105)**
- Helper function to apply socket-level options before connection
- Iterates through options list and applies each via setsockopt

**`allowed_gai_family()` (L108-116)**
- Returns appropriate address family for getaddrinfo calls
- Returns AF_INET for IPv4-only systems, AF_UNSPEC for IPv6-capable systems
- Used by create_connection to filter DNS records based on system capabilities

**`_has_ipv6(host)` (L119-146)**
- Runtime IPv6 capability detection by attempting to bind to IPv6 address
- Returns False immediately on AppEngine to avoid socket quota issues
- Tests actual system IPv6 support beyond Python compile-time support

## Key Dependencies

- `socket` - Core networking functionality
- `..contrib._appengine_environ` - AppEngine platform detection
- `..exceptions.LocationParseError` - Host validation error handling
- `.wait.wait_for_read, NoWayToWaitForSocketError` - Socket readability testing

## Global State

**`HAS_IPV6` (L149)** - Module-level constant set by testing IPv6 binding capability on localhost (`::1`)

## Architectural Patterns

- Platform abstraction: Special handling for AppEngine limitations
- Defensive programming: Proper socket cleanup in exception paths
- Enhanced stdlib functions: Extends standard library with additional features (socket options, IPv6 detection)
- Error propagation: Preserves original socket errors while adding context