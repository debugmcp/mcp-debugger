# packages/adapter-rust/vendor/codelldb/win32-x64/lldb/lib/site-packages/pip/_vendor/urllib3/packages/backports/weakref_finalize.py
@source-hash: b5109a97938084d4
@generated: 2026-02-09T17:58:08Z

## Purpose
Backports Python 3's `weakref.finalize` functionality to provide automatic cleanup of objects when they are garbage collected. This is a compatibility shim for environments lacking native `weakref.finalize` support.

## Key Classes

### weakref_finalize (L17-155)
Core finalizer class that manages automatic cleanup callbacks for weakly-referenced objects.

**Key Attributes:**
- `_registry` (L34): Dict mapping finalizer instances to `_Info` objects containing cleanup metadata
- `_shutdown` (L35): Boolean flag preventing finalizer execution during interpreter shutdown
- `_index_iter` (L36): Counter for ordering finalizers by creation time
- `_dirty` (L37): Flag indicating registry changes requiring re-selection
- `_registered_with_atexit` (L38): One-time atexit registration flag

**Constructor** (L43-59):
- Creates weak reference to target object with self as callback
- Registers cleanup function, args, and kwargs in `_Info` instance
- Ensures atexit handler is registered exactly once

**Core Methods:**
- `__call__` (L61-66): Executes and removes finalizer, returning cleanup function result
- `detach` (L68-74): Removes finalizer and returns (obj, func, args, kwargs) tuple if alive
- `peek` (L76-82): Returns finalizer metadata without removing it
- `alive` property (L84-87): Checks if finalizer is still registered
- `atexit` property (L89-99): Gets/sets whether finalizer runs at program exit

### _Info (L40-41)
Internal storage class for finalizer metadata using `__slots__` for memory efficiency.
Fields: `weakref`, `func`, `args`, `kwargs`, `atexit`, `index`

## Key Methods

### _select_for_exit (L114-119)
Class method that returns live finalizers marked for atexit execution, sorted by creation order (oldest first).

### _exitfunc (L121-155)
Critical atexit callback that:
- Disables garbage collection during cleanup to prevent interference
- Processes finalizers in creation order, handling new finalizers created during cleanup
- Uses `_dirty` flag to detect registry changes and re-select pending finalizers
- Catches and reports exceptions via `sys.excepthook`
- Sets `_shutdown` flag to prevent further finalizer execution

## Architecture Patterns

**Weak Reference Design**: Uses weak references to avoid circular dependencies between finalizers and target objects.

**Registry Pattern**: Central `_registry` dict maps finalizer instances (as keys) to metadata objects, ensuring finalizers themselves remain stateless.

**Atexit Integration**: Single atexit registration with robust cleanup logic that handles dynamic finalizer creation during shutdown.

**Thread Safety Considerations**: Uses class-level flags and accepts potential race conditions in atexit registration as harmless.

## Dependencies
- `itertools.count()` for unique indexing
- `weakref.ref` for weak object references  
- `atexit` module for shutdown cleanup registration
- `gc` module for garbage collection control during shutdown