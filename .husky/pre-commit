# Run existing personal info check
node "$(dirname -- "$0")/../scripts/check-personal-paths.cjs"

# Check for build artifacts in src directories
echo "ðŸ” Checking for build artifacts in source directories..."

# Check for JS files in src/ (excluding proxy-bootstrap.js which is a legitimate source file)
if git diff --cached --name-only | grep -E '^src/.*\.(js|d\.ts|js\.map)$' | grep -v '^src/proxy/proxy-bootstrap.js$'; then
    echo ""
    echo "âŒ Error: Build artifacts detected in src/ directory!"
    echo "   These files should not be committed:"
    git diff --cached --name-only | grep -E '^src/.*\.(js|d\.ts|js\.map)$' | grep -v '^src/proxy/proxy-bootstrap.js$'
    echo ""
    echo "ðŸ’¡ Run 'npm run clean' to remove build artifacts"
    echo "ðŸ’¡ Only TypeScript source files should be in src/"
    echo "ðŸ’¡ Exception: src/proxy/proxy-bootstrap.js is a legitimate JavaScript source file"
    exit 1
fi

# Check for JS files in packages/*/src/
if git diff --cached --name-only | grep -E '^packages/.*/src/.*\.(js|d\.ts|js\.map)$'; then
    echo ""
    echo "âŒ Error: Build artifacts detected in package source directories!"
    echo "   These files should not be committed:"
    git diff --cached --name-only | grep -E '^packages/.*/src/.*\.(js|d\.ts|js\.map)$'
    echo ""
    echo "ðŸ’¡ Run 'npm run clean' to remove build artifacts"
    echo "ðŸ’¡ Only TypeScript source files should be in packages/*/src/"
    exit 1
fi

# Check for package tarballs
if git diff --cached --name-only | grep -E '\.tgz$'; then
    echo ""
    echo "âŒ Error: Package tarball files detected!"
    echo "   These files should not be committed:"
    git diff --cached --name-only | grep -E '\.tgz$'
    echo ""
    echo "ðŸ’¡ Package tarballs are for local testing only"
    exit 1
fi

echo "âœ… No build artifacts found in staged files"

# Docstar shadow documentation (optional â€” runs only if docstar is installed)
if command -v docstar &> /dev/null; then
  echo "Docstar: Updating shadow documentation..."
  docstar shadow . 2>/dev/null || true
  # Stage any updated shadow docs
  if [ -d ".docstar/shadow" ]; then
    git add .docstar/shadow 2>/dev/null || true
  fi
fi
